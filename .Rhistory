dplyr::mutate(bin=cutpts[cut(SIZE,cutpts,labels=FALSE)]+3),
by="HAULJOIN") |>
dplyr::group_by(YEAR,HAULJOIN) |>
dplyr::summarize(numIndivs=sum(numIndivs,na.rm=TRUE))
dfrZCsByH = dfrHD_NMFS |>
dplyr::inner_join(dfrID_NMFS |>
dplyr::mutate(bin=cutpts[cut(SIZE,cutpts,labels=FALSE)]+3),
by="HAULJOIN") |>
dplyr::group_by(YEAR,HAULJOIN,SIZE) |>
dplyr::summarize(numIndivs=sum(numIndivs,na.rm=TRUE))
dfrZCsByH = dfrHD_NMFS |>
dplyr::inner_join(dfrID_NMFS |>
dplyr::mutate(bin=cutpts[cut(SIZE,cutpts,labels=FALSE)]+3),
by="HAULJOIN") |>
dplyr::group_by(YEAR,HAULJOIN,bin) |>
dplyr::summarize(numIndivs=sum(numIndivs,na.rm=TRUE))
rm(dfrHaulData_NMFS);
View(dfrHDwSCs)
names(dfrZCsByH)
names(dfrHDwSCs)
dfrHDwSCsp = dfrHDwSCs |>
dplyr::inner_join(dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs),
by=c("h"="HAULJOIN","z"="bin"))
View(dfrHDwSCsp)
dfrHDwSCsp = dfrHDwSCs |>
dplyr::inner_join(dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs),
by=c("h"="HAULJOIN","z"="bin"))
dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs)
dfrZCsByH = dfrHD_NMFS |>
dplyr::inner_join(dfrID_NMFS |>
dplyr::mutate(bin=cutpts[cut(SIZE,cutpts,labels=FALSE)]+3),
by="HAULJOIN") |>
dplyr::group_by(YEAR,HAULJOIN,bin) |>
dplyr::summarize(numIndivs=sum(numIndivs,na.rm=TRUE)) |>
dplyr::ungroup();
dfrHDwSCsp = dfrHDwSCs |>
dplyr::inner_join(dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs),
by=c("h"="HAULJOIN","z"="bin"))
View(dfrHDwSCsp)
dfrRbyHp = dfrRbyH |>
dplyr::inner_join(dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs),
by=c("h"="HAULJOIN","z"="bin"))
plotWgtdSels<-function(dfrRbyH,dfrMnR,wt){
p = ggplot(dfrRbyH,
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=wt)) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper),data=dfrMnR,colour=NA,fill="red",alpha=0.2,inherit.aes=FALSE) +
geom_line(aes(x=z,y=mnR),data=dfrMnR,colour="red",inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme();
return(p);
}
plotWgtdSels(dfrRbyH,dfrMnR,1/dfrRbyH$se);
plotWgtdSels(dfrRbyH,dfrMnR,1/dfrRbyH$seR);
plotWgtdSelsWithY<-function(dfrRbyH,dfrMnR,wt){
p = ggplot(dfrRbyH,
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=wt)) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper,fill=y),data=dfrMnRbyY,inherit.aes=FALSE,colour=NA,alpha=0.2) +
geom_line(aes(x=z,y=mnR,colour=y),                data=dfrMnRbyY,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
scale_fill_viridis_d(aesthetics=c("fill","colour")) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme();
}
plotWgtdSelsWithY(dfrRbyH,dfrMnR,1/dfrRbyH$seR);
plotWgtdSelsWithY<-function(dfrRbyH,dfrMnR,wt){
p = ggplot(dfrRbyH,
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=wt)) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper,fill=y),data=dfrMnRbyY,inherit.aes=FALSE,colour=NA,alpha=0.2) +
geom_line(aes(x=z,y=mnR,colour=y),                data=dfrMnRbyY,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
scale_fill_viridis_d(aesthetics=c("fill","colour")) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme();
return(p)
}
plotWgtdSelsWithY(dfrRbyH,dfrMnR,1/dfrRbyH$seR);
plotWgtdSelsByY(dfrRbyH,dfrMnRbyY,wt)
plotWgtdSelsByY<-function(dfrRbyH,dfrMnRbyY,wt){
ps = list();
for (yd_ in levels(dfrMnRbyY$yd)){
dfrMnRbyYp = dfrMnRbyY  |> dplyr::filter(yd==yd_);
ps[[yd_]]=ggplot(dfrRbyH |> dplyr::filter(yd==yd_),
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=wt)) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper,fill=y),data=dfrMnRbyYp,inherit.aes=FALSE,colour=NA,alpha=0.2) +
geom_line(aes(x=z,y=mnR,colour=y),                data=dfrMnRbyYp,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
scale_fill_manual(aesthetics=c("fill","colour"),values=viridis::inferno(10)) +
facet_wrap(~yd) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme() +
theme(legend.position="none");
}
p = patchwork::wrap_plots(ps,nrow=2) + patchwork::plot_layout(axis_titles="collect");
return(p)
}
plotWgtdSelsByY(dfrRbyH,dfrMnRbyY,wt)
plotWgtdSelsByY(dfrRbyH,dfrMnRbyY,1/dfrRbyH$seR)
plotWgtdSelsByY<-function(dfrRbyH,dfrMnRbyY,invwt){
ps = list();
for (yd_ in levels(dfrMnRbyY$yd)){
dfrMnRbyYp = dfrMnRbyY  |> dplyr::filter(yd==yd_);
ps[[yd_]]=ggplot(dfrRbyH |> dplyr::filter(yd==yd_),
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=1/(!!invwt))) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper,fill=y),data=dfrMnRbyYp,inherit.aes=FALSE,colour=NA,alpha=0.2) +
geom_line(aes(x=z,y=mnR,colour=y),                data=dfrMnRbyYp,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
scale_fill_manual(aesthetics=c("fill","colour"),values=viridis::inferno(10)) +
facet_wrap(~yd) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme() +
theme(legend.position="none");
}
p = patchwork::wrap_plots(ps,nrow=2) + patchwork::plot_layout(axis_titles="collect");
return(p)
}
plotWgtdSelsByY(dfrRbyH,dfrMnRbyY,seR)
plotWgtdSelsByY<-function(dfrRbyH,dfrMnRbyY,invwt){
ps = list();
for (yd_ in levels(dfrMnRbyY$yd)){
dfrMnRbyYp = dfrMnRbyY  |> dplyr::filter(yd==yd_);
ps[[yd_]]=ggplot(dfrRbyH |> dplyr::filter(yd==yd_),
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=1/{{invwt}})) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper,fill=y),data=dfrMnRbyYp,inherit.aes=FALSE,colour=NA,alpha=0.2) +
geom_line(aes(x=z,y=mnR,colour=y),                data=dfrMnRbyYp,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
scale_fill_manual(aesthetics=c("fill","colour"),values=viridis::inferno(10)) +
facet_wrap(~yd) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme() +
theme(legend.position="none");
}
p = patchwork::wrap_plots(ps,nrow=2) + patchwork::plot_layout(axis_titles="collect");
return(p)
}
plotWgtdSelsByY(dfrRbyH,dfrMnRbyY,seR)
plotWgtdSelsWithY(dfrRbyHp,dfrMnRp,1/dfrRbyHp$seR);
dfrRbyHp = dfrRbyH |>
dplyr::inner_join(dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs),
by=c("h"="HAULJOIN","z"="bin")) |>
dplyr::mutate(invwgt=seR/numIndivs)
#--number and std. dev-weighted mean selectivity across all hauls--
dfrMnRp = dfrRbyHp |>
dplyr::group_by(z) |>
dplyr::summarize(mnR=Hmisc::wtd.mean(prdR,weights=1/invwgt,normwt=FALSE,na.rm=TRUE),
lower=Hmisc::wtd.quantile(prdR,weights=1/invwgt,normwt=FALSE,na.rm=TRUE,probs=0.10),
upper=Hmisc::wtd.quantile(prdR,weights=1/invwgt,normwt=FALSE,na.rm=TRUE,probs=0.90)) |>
dplyr::ungroup();
plotWgtdSelsWithY(dfrRbyHp,dfrMnRp,invwgt);
View(dfrRbyHp)
dfrRbyHp = dfrRbyH |>
dplyr::inner_join(dfrZCsByH |> dplyr::select(HAULJOIN,bin,numIndivs),
by=c("h"="HAULJOIN","z"="bin")) |>
dplyr::mutate(invwgt_=seR/numIndivs);
#--number and std. dev-weighted mean selectivity across all hauls--
dfrMnRp = dfrRbyHp |>
dplyr::group_by(z) |>
dplyr::summarize(mnR=Hmisc::wtd.mean(prdR,weights=1/invwgt_,normwt=FALSE,na.rm=TRUE),
lower=Hmisc::wtd.quantile(prdR,weights=1/invwgt_,normwt=FALSE,na.rm=TRUE,probs=0.10),
upper=Hmisc::wtd.quantile(prdR,weights=1/invwgt_,normwt=FALSE,na.rm=TRUE,probs=0.90)) |>
dplyr::ungroup();
plotWgtdSelsWithY(dfrRbyHp,dfrMnRp,invwgt_);
plotWgtdSelsWithY<-function(dfrRbyH,dfrMnR,invwgt){
p = ggplot(dfrRbyH,
aes(x=z,y=prdR,ymin=lower,ymax=upper,size=1/{{invwgt}})) +
geom_point() +
scale_size_area() +
geom_ribbon(aes(x=z,ymin=lower,ymax=upper,fill=y),data=dfrMnRbyY,inherit.aes=FALSE,colour=NA,alpha=0.2) +
geom_line(aes(x=z,y=mnR,colour=y),                data=dfrMnRbyY,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,2)) +
scale_fill_viridis_d(aesthetics=c("fill","colour")) +
labs(x="size (mm CW)",y="predicted selectivity") +
wtsPlots::getStdTheme();
return(p)
}
plotWgtdSelsWithY(dfrRbyH,dfrMnR,seR);
plotWgtdSelsWithY(dfrRbyHp,dfrMnRp,invwgt_);
#--number and std. dev-weighted mean selectivity across all hauls, by year
dfrMnRbyYp = dfrRbyHp |>
dplyr::group_by(yd,y,z) |>
dplyr::summarize(mnR=Hmisc::wtd.mean(prdR,weights=1/invwgt_,normwt=FALSE,na.rm=TRUE),
lower=Hmisc::wtd.quantile(prdR,weights=1/invwgt_,normwt=FALSE,na.rm=TRUE,probs=0.10),
upper=Hmisc::wtd.quantile(prdR,weights=1/invwgt_,normwt=FALSE,na.rm=TRUE,probs=0.90)) |>
dplyr::ungroup() |>
dplyr::mutate(y=as.factor(y));
plotWgtdSelsByY(dfrRbyHp,dfrMnRbyYp,invwgt_)
#--fit various models for ln(r) using mgcv to fit GAMs for a specific sex
#----BINOMIAL distribution
require(DHARMa);
require(dplyr);
require(ggplot2);
require(gratia)
require(mgcv);
dirThs = dirname(rstudioapi::getActiveDocumentContext()$path);
#--get trimmed data
dfrDat =  wtsUtilities::getObj(file.path(dirThs,"../rda_dfrTrimmedData.RData")) |>
dplyr::mutate(obsR=exp(lnR),
nN=round(p*n), #--number caught in NMFS gear
nB=n-nN);      #--number caught in BSFRF gear
#--extract characteristics from size and environmental data
#----size
grd_z = seq(5,180,5)+2.5; med_z = 100.0; #--for males
#--depth
med_d = median(dfrDat$d,na.rm=TRUE); rng_d = range(dfrDat$d,na.rm=TRUE);
grd_d = seq(from=rng_d[1],rng_d[2],length.out=50);
#--temperature
med_t = median(dfrDat$t,na.rm=TRUE); rng_t = range(dfrDat$t,na.rm=TRUE);
grd_t = seq(from=rng_t[1],rng_t[2],length.out=50);
#--phi
med_f = median(dfrDat$f,na.rm=TRUE); rng_f = range(dfrDat$f,na.rm=TRUE);
grd_f = seq(from=rng_f[1],rng_f[2],length.out=50);
#--sorting
med_s = median(dfrDat$s,na.rm=TRUE); rng_s = range(dfrDat$s,na.rm=TRUE);
grd_s = seq(from=rng_s[1],rng_s[2],length.out=50);
grids = list(z=grd_z,d=grd_d,t=grd_t,f=grd_f,s=grd_s);
lbls  = list(z="size (mm CW)",d="depth (m)",t="temperature (deg C)",f="-log2(phi)",s="sorting coeff.")
#--the logit-scale observed proportions "o=nN/(nN+nB)" are related to the
#--NMFS-to-BSFRF selectivity ratio "r" (S_nmfs/S_bsfrf) by
#     logit(o) = ln(r) + ln(q)
# where q = expF_b/expF_n is the ratio of expansion factors used to convert
# numbers sampled to CPUE: i.e., CPUE = N_s * expF, where expF = 1/(As * Sf),
# and As = area swept and Sf is the sampling fraction (note that
# the SAMPLING_FACTOR in the haul data tables is 1/(sampling fraction),
# so expF = SAMPLING_FACTOR/AREA_SWEPT).
#--set sex
x = "MALE";
dfrDat   = dfrDat |> dplyr::filter(x=="MALE") |> dplyr::mutate(obsR=exp(lnR));
#--remove zeros, infs, questionable observed Rs
dfrDatp   = dfrDat |> dplyr::filter(obsR<10, is.finite(lnR),between(z,15,150));
#--BINOMIAL regression  models for lnR
famB = stats::binomial(link="logit");
#--------ALL Z 2-WAY INTERACTIONS--------------------------
#--ln(r) = ti(z) +
#--         ti(d) + ti(t) + ti(f) + ti(s) +
#--        ti(z,d) + ti(z,t) + ti(z,f) +ti(z,s)
ks=c(20,10);
k1 = ks[1]; k2 = ks[2];
frmla  = p~ti(z,bs="ts",k=k1)   +
ti(d,bs="ts",k=k2)   + ti(t,bs="ts",k=k2)   + ti(f,bs="ts",k=k2)   + ti(s,bs="ts",k=k2) +
ti(z,d,bs="ts",k=c(k1,k2)) + ti(z,t,bs="ts",k=c(k1,k2)) + ti(z,f,bs="ts",k=c(k1,k2)) + ti(z,s,bs="ts",k=c(k1,k2));
mdlB_ZE2D  = mgcv::gam(frmla,family=famB,data=dfrDatp,select=TRUE,method="REML",fit=FALSE,
offset=lnq,weights=n);
source(file.path(dirThs,"../r_gam.prefit.functions.R"));
source(file.path(dirThs,"../r_SelectModelByConcurvityFunctions.R"));
#--run cross validation-------------------------------------------------
set.seed(1111111);
mdl = mdlB_ZE2D;
dfrCrsVal = runCrossValidation(
mdl,
ks,
dfrData=dfrDatp,
numFolds=10,
concrv_opt=2,
doParallel=TRUE,
ncores=parallel::detectCores()-1,
max_ncmbs=NULL,
icmbs=NULL,
log=TRUE,
debug=FALSE);
wtsUtilities::saveObj(dfrCrsVal,file.path(dirThs,"rda_BinomialModels_CrsVal.RData"));
dfrCrsValp = dfrCrsVal |>
dplyr::group_by(i,frmla,smths) |>
dplyr::summarize(mnRsqr=mean(rsqr),
mnAIC=mean(aic),
mnRsqr_prd=mean(rsqr_prd),
mnMSPE_prd=mean(mspe_prd),
mnMASE_prd=mean(mase_prd),
scrSignifp=sum(as.numeric(signifp)),
scrSignifs=sum(as.numeric(signifs)),
scrConcrv_tst=sum(as.numeric(concrv_tst))) |>
dplyr::ungroup() |>
dplyr::arrange(desc(scrConcrv_tst),desc(scrSignifs),mnMSPE_prd);
best_idx = dfrCrsValp$i[1];#--index of best model in evaluated combinations
best_mdl = evalBestModel(mdl,ks,best_idx);
simResids <- DHARMa::simulateResiduals(fittedModel = best_mdl, plot = F, n=1000);
DHARMa::plotQQunif(simResids);
DHARMa::plotResiduals(simResids);
getModelPlots(best_mdl);
wtsUtilities::saveObj(best_mdl,file.path(dirThs,"rda_BinomialModels_BestModel.RData"));
View(dfrCrsValp)
View(dfrDatp)
View(best_mdl)
range(residuals(best_mdl))
plot(best_mdl)
plot(best_mdl,residuals=TRUE)
exp(6)
partial_residuals
gratia:::partial_residuals.gam
dfr = partial_residuals(best_mdl)
View(dfr)
range(dfr[[1]])
gratia:::compute_partial_residuals
weights(best_mdl)
plot.gam
gratia:::compute_partial_residuals
predict.gam
object=best_mdl
!is.null(object$family$predict)
!is.null(object$pred.formula)
attr(object$pred.formula,"full")
terms(object)
attr(attr(object$model, "terms"), "offset")
w_resid <- as.numeric(residuals(object)) * sqrt(weights(object))
data <- object[["model"]]
predict(object, type = "terms", newdata = data)
p_terms = predict(object, type = "terms", newdata = data)
attr(p_terms, "constant") <- NULL
p_resids <- p_terms + w_resid
dfr_p_resids = as_tibble(p_resids)
range(p_resids)
head(data)
data$p_terms=p_terms
head(data)
data$w_resid = w_resid
head(data)
data$lgtp = log(data$p/(1-data$p))
head(data)
head(weights(object))
data$lnR = data$lgtp - data$`(offset)`
head(data)
data$p_terms  = p_terms
head(data)
ggplot(data,aes(x=z,y=p_term))+geom)point()
ggplot(data,aes(x=z,y=p_term))+geom_point()
ggplot(data,aes(x=z,y=`ti(z)`))+geom_point()
names(data)
ggplot(data,aes(x=z,y=p_terms))+geom_point()
ggplot(data,aes(x=z,y=p_terms))+geom_point()+geom_point(aes(y=w_resid),color="red")
data$pred = predict(object)
data$resids = (lgtp-`(offset)`) - data$pred
data$resids = (data$lgtp-data$`(offset)`) - data$pred
ggplot(data,aes(x=z,y=p_terms))+geom_point()+geom_point(aes(y=resids,color="red")
)
head(data)
data$working = object$residuals
head(data)
data=object$model
head(data)
data$obsLink = log(data$p/(1-data$p))-data$`(offset)`
data$prdLink = predict.gam(object,type="link")
head(data)
ggplot(data,aes(x=z,y=obsLink))+geom_point()+geom_point(aes(y=prdLink),color="red")
data$resids = residuals.gam(object,type="pearson")
data$resids_d = residuals.gam(object,type="deviance")
data$resids_w = residuals.gam(object,type="working")
head(data)
data$diff=data$obsLink-data$prdLink
head(data)
data$prd_s = predict.gam(object,type=terms)
data$prd_s = predict.gam(object,type="terms")
head(data)
model_constant(object)
data=object$model;
data$lgtp = log(data$p/(1-data$p));
data$obsLink = data$lgtp-data$`(offset)`;
data$prdLink  = predict(object,type="link");
data$prdLinkN = predict(object,type="link",newdata=object$model);
head(data)
data$prdLinkN = predict(object,type="link",newdata=object$model[,1:2]);
head(data)
object$model[,1:2]
head(object$model[,1:2])
data$prdLinkN = predict(object,type="link",newdata=object$model[,1:2]);
head(data)
data$prdLinkN = predict(object,type="link",newdata=object$model|>dplyr::mutate(`(offset)`=0));
head(data)
head(object$model|>dplyr::mutate(`(offset)`=0))
data=object$model;
data$lgtp = log(data$p/(1-data$p));
data$obsLink = data$lgtp-data$`(offset)`;
data$prdLink  = predict(object,type="link");
data$`Link(obs-prd)` = data$obsLink-data$prdLink;
head(data)
data$`WorkingRs` = object$residuals;
head(data)
head(as.numeric(residuals(object)))
residuals.gam
object$family$residuals
object$sig2
head(data)
head(object$y)
head(object$mu)
head(object$fitted.values)
object$family$dev.resids
head(object$family$dev.resids(object$y,object$fitted.values,object$prior.weights))
head(object$family$dev.resids(object$y,object$fitted.values,object$prior.weights)*sign(object$y-object$fitted.values))
head(as.numeric(residuals(object)) * sqrt(weights(object)))
head(as.numeric(residuals(object)))
head(as.numeric(residuals(object,type="working")))
head(object$residuals)
head(data$y)
head(object$y)
data$fitted=object$fitted.values
ggplot(data,aes(x=z,y=p)) + geom_point() + geom_point(aes(y=fitted),color="red")
head(object$prior.weights)
draw(best_mdl,residuals=TRUE)
gratia:::draw.gam
gratia:::nested_partial_residuals
mgcv:::plot.gam
res = residuals(object="deviance")
res = residuals(object,"deviance")
data$devRs = residuals(object,"deviance")
ggplot(data,aes(x=z,y=p)) + geom_point() + geom_point(aes(y=devRs),color="red")
ggplot(data,aes(x=`WorkingRs`,y=devRs)) + geom_point()
ggplot(data,aes(x=`WorkingRs`,y=devRs)) + geom_point() + geom_abline(slope=1,color="red")
plot.gam(object,residuals=TRUE)
range(data$WorkingRs)
head(object$prior.weights)
head(object$working.weights)
head(object$weights)
res = object$family$dev.resids(object$y,object$fitted.values,object$prior.weights);
res = sign(object$y-object$fitted.values)*sqrt(res)
is.complex(res)
head(res)
head(data$devRs)
stats:::C_binomial_dev_resids
load("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysisOld/Analysis/03_MGCV_Analysis/Binomial_Males_CensoredData1/selModels.Binom.All.males.RData")
View(obj)
smooth_terms(obj$`signif 2-way interactions`)
smooth_terms(obj$`signif 2-way interactions`$model)
obj$`signif 2-way interactions`$plotEsts
rlang::last_trace()
obj$`signif 2-way interactions`$plotEsts$1a
obj$`signif 2-way interactions`$plotEsts$1a
obj$`signif 2-way interactions`[[1]]
plot(obj$`signif 2-way interactions`[[1]])
plot(obj$`signif 2-way interactions`[[1]],residuals=TRUE)
draw(obj$`signif 2-way interactions`[[1]],residuals=TRUE)
draw(obj$`signif 2-way interactions`[[1]],residuals=TRUE,select=1)
plot(obj$`signif 2-way interactions`[[1]],residuals=TRUE,select=1)
ggplot(data,aes(x=z,y=devsR)) + geom_point() + geom_point(aes(y=prdLink),color="red")
ggplot(data,aes(x=z,y=devRs)) + geom_point() + geom_point(aes(y=prdLink),color="red")
ggplot(data,aes(x=z,y=prdLink+devRs)) + geom_point() + geom_point(aes(y=prdLink),color="red")
ggplot(data,aes(x=z,y=prdLink+devRs)) + geom_point() + geom)hline(yintercept=0)
ggplot(data,aes(x=z,y=prdLink+devRs)) + geom_point() + geom_hline(yintercept=0)
ggplot(data,aes(x=z,y=devRs)) + geom_point() + geom_hline(yintercept=0)
datap = add_partial_residuals(object$model,object)
View(datap)
range(datap$`ti(z)`)
add_partial_residuals
add_partial_residuals.gam
gratia:::add_partial_residuals.gam
datap = add_partial_residuals(object$model,object,type="working")
range(datap$`ti(z)`)
predict.gam
data=best_mdl$model
names(data)
datanew=data[,1:2]
attributes(datanew)
debugSource("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/04_MGCV_Analysis/BestModels_Males/r_Predict.gam.R")
traceback()
debugSource("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/04_MGCV_Analysis/BestModels_Males/r_Predict.gam.R")
debugSource("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/04_MGCV_Analysis/BestModels_Males/r_Predict.gam.R")
datap = bind_cols(data,prd_lp=prd_data,obs_lp=log(data$p/(1-data$p))-`(offset)`)
datap = bind_cols(data,prd_lp=prd_data,obs_lp=log(data$p/(1-data$p))-data$`(offset)`)
ggplot(datap,aes(x=z,y=obs_lp)) + geom_point() + geom_point(aes(y=prd_lp))
ggplot(datap,aes(x=z,y=obs_lp)) + geom_point() + geom_point(aes(y=prd_lp),color="red")
datap = bind_cols(data,lgtp=log(data$p/(1-data$p)),prd_lp=prd_data,obs_lp=log(data$p/(1-data$p))-data$`(offset)`)
ggplot(datap,aes(x=z,y=obs_lp)) + geom_point() + geom_point(aes(y=prd_lp),color="red") + geom_point(y=lgtp),color="blue");
ggplot(datap,aes(x=z,y=obs_lp)) + geom_point() + geom_point(aes(y=prd_lp),color="red") + geom_point(aes(y=lgtp),color="blue");
ggplot(datap,aes(x=z,y=obs_lp)) +
geom_point() + geom_point(aes(y=prd_lp),color="red") +
geom_point(aes(y=lgtp),color="blue") +
geom_point(aes(y=`(offset)`),colour="green");
ggplot(datap,aes(x=z,y=obs_lp)) +
geom_point() + geom_point(aes(y=prd_lp),color="red") +
geom_point(aes(x=z-0.5,y=lgtp),color="blue") +
geom_point(aes(x=z+0.5,y=`(offset)`),colour="green");
prd_s  = predict.gam(best_mdl,data,type="terms",terms=1)
prd_s  = predict.gam(best_mdl,data,type="terms")
prd_lp = predict.gam(best_mdl,data,type="link");
prd_s  = predict.gam(best_mdl,data,type="terms")
model_constant(best_mdl)
head(model_constant(best_mdl)+prd_s)
View(dfrCrsValp)
datal = datap |> tidyr::pivot_longer(lgtp,prd_lp,obs_lp,`(offset)`,names_to="type")
datal = datap |> tidyr::pivot_longer(cols=c(lgtp,prd_lp,obs_lp,`(offset)`),names_to="type")
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point()
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point() + scale_color_manual(values=c("(offset)"="green","lgtp"="blue","obs_lp"="black",prd_lp="black"))
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point() +
scale_color_manual(values=c("(offset)"="green","lgtp"="blue","obs_lp"="black",prd_lp="black",prd_s="red"))
datal = datap |> tidyr::pivot_longer(cols=c(lgtp,prd_lp,obs_lp,`(offset)`,prd_s),names_to="type")
datap = bind_cols(data,lgtp=log(data$p/(1-data$p)),
prd_lp=prd_lp,obs_lp=log(data$p/(1-data$p))-data$`(offset)`)
datal = datap |> tidyr::pivot_longer(cols=c(lgtp,prd_lp,obs_lp,`(offset)`),names_to="type")
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point() +
scale_color_manual(values=c("(offset)"="green","lgtp"="blue","obs_lp"="black",prd_lp="red"))
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point() + position_jitter() +
scale_color_manual(values=c("(offset)"="green","lgtp"="blue","obs_lp"="black",prd_lp="red"))
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point(position=position_jitter) +
scale_color_manual(values=c("(offset)"="green","lgtp"="blue","obs_lp"="black",prd_lp="red"))
ggplot(datal,aes(x=z,y=value,colour=type)) +
geom_point(position="jitter") +
scale_color_manual(values=c("(offset)"="green","lgtp"="blue","obs_lp"="black",prd_lp="red"))
