ps = list();
#--plot predicted selectivity values
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y={{y_}},z=prdLnR)) +
geom_contour(breaks=log(c(0.01,0.1,0.5,1,2,10))) +
labs(x=xlab,y=ylab,
subtitle=paste0(tolower(x),"s: ","predicted ln-scale R")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) {
p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE);
p = p + geom_rug(data=dfrDat,mapping=aes(y={{y_}}),inherit.aes=FALSE);
}
ps[["lnR"]] = p;
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y={{y_}},z=exp(prdLnR+(seLnR^2)/2))) +
geom_contour(breaks=c(0.01,0.1,0.5,1,2,10)) +
labs(x=xlab,ylab=ylab,
subtitle=paste0(tolower(x),"s: ","predicted R")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) {
p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE);
p = p + geom_rug(data=dfrDat,mapping=aes(y={{y_}}),inherit.aes=FALSE);
}
ps[["R"]] = p;
return(ps);
}
mdl = mdlB_All1D;
k=20;
frmla = p~ti(z,bs="ts",k=k)+ti(d,bs="ts",k=k)+ti(t,bs="ts",k=k)+ti(f,bs="ts",k=k)+ti(s,bs="ts",k=k);
mdlB_All1D   = estSelRatio(dfrDat,frmla,family=fam,select=TRUE);
mdl = mdlB_All1D;
df_prdsel_d = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=grd_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_d = plotPrdSel1D(df_prdsel_d,x_=z,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
ps_prdsel_d
ps_prdsel_d = plotPrdSel1D(df_prdsel_d,x_=d,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
ps_prdsel_d
df_prdsel_zd = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=grd_z,d=grd_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_zd = plotPrdSel1D(df_prdsel_zd,x_=z,y=d,xlab="size (mm CW)",ylab="haul depth (m)",
xints=c(25,180),dfrDat=dfrDat,ci=0.80)
ps_prdsel_zd = plotPrdSel2D(df_prdsel_zd,x_=z,y=d,xlab="size (mm CW)",ylab="haul depth (m)",
xints=c(25,180),dfrDat=dfrDat,ci=0.80)
ps_prdsel_zd
plotPrdSel2D<-function(dfrPrd,x_,y_,xlab="size (mm CW)",ylab="depth (m)",xints=NULL,dfrDat=NULL,ci=0.80){
dci = (1-ci)/2;
mlt = pnorm(1-dci,0,1);#se multiplier corresponding to ci
ps = list();
#--plot predicted selectivity values
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y={{y_}},z=prdLnR)) +
geom_contour(breaks=log(c(0.01,0.1,0.5,1,2,10))) +
labs(x=xlab,y=ylab,
subtitle=paste0(tolower(x),"s: ","predicted ln-scale R")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) {
p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE);
p = p + geom_rug(data=dfrDat,mapping=aes(y={{y_}}),inherit.aes=FALSE);
}
ps[["lnR"]] = p;
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y={{y_}},z=exp(prdLnR+(seLnR^2)/2))) +
geom_contour_filled(breaks=c(0.01,0.1,0.5,1,2,10)) +
labs(x=xlab,ylab=ylab,
subtitle=paste0(tolower(x),"s: ","predicted R")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) {
p = p + geom_point(data=dfrDat,mapping=aes(x={{x_}}),y={{y_}},inherit.aes=FALSE,size=0.1,colour="white")
p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE);
p = p + geom_rug(data=dfrDat,mapping=aes(y={{y_}}),inherit.aes=FALSE);
}
ps[["R"]] = p;
return(ps);
}
df_prdsel_zd = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=grd_z,d=grd_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_zd = plotPrdSel2D(df_prdsel_zd,x_=z,y=d,xlab="size (mm CW)",ylab="haul depth (m)",
xints=c(25,180),dfrDat=dfrDat,ci=0.80)
require(magrittr);
require(mgcv);
#'
#' @title Estimate selectivity ratio
#'
#' @importFrom dplyr mutate
#' @importFrom magrittr %<>%
#' @import mgcv
#'
#' @export
#'
estSelRatio<-function(
dfrDat,
formula,
family=stats::binomial(),
method="REML",
select=FALSE,
scale=0){
mdl = mgcv::gam(data=dfrDat,family=family,formula=formula,weights=n,
method=method,select=select,scale=scale,offset=lnq);
#--extract fitted values and calculate associated selectivity ratio
if (family$family=="binomial"){
dfrDat %<>% dplyr::mutate(fits=fitted(mdl),                         #--fitted values on response scale (i.e., prNMFS)
residuals=residuals(mdl,type="deviance"), #--deviance residuals for qqplot
lnR=log(fits/(1-fits))-lnq,               #--corresponding values of lnR
R=exp(lnR));                              #--corresponding values of R
} else { #--negative binomial
dfrDat %<>% dplyr::mutate(fits=fitted(mdl),                         #--fitted values on response scale (i.e., logit(prNMFS))
residuals=residuals(mdl,type="deviance"), #--deviance residuals for qqplot
lnR=fits-lnq,                             #--corresponding values of lnR
R=exp(lnR));                              #--corresponding values of R
}
return(list(model=mdl,data=dfrDat));
}
plotEsts<-function(dfrDat,showPlots=FALSE){
ps = list();
#--plot fitted values
ps[["1a"]] = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=z,y=fits,colour=y)) +
ggplot2::geom_point() + ggplot2::geom_smooth() +
ggplot2::labs(x="size (mm CW)",y="fitted prNMFS");
if (showPlots) print(ps[["1a"]]);
ps[["1b"]] = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=z,y=lnR,colour=y)) +
ggplot2::geom_point() + ggplot2::geom_smooth() +
ggplot2::labs(x="size (mm CW)",y="predicted lnR");
if (showPlots) print(ps[["1b"]]);
ps[["1c"]] = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=z,y=R,colour=y)) +
ggplot2::geom_point() + ggplot2::geom_smooth() +
ggplot2::labs(x="size (mm CW)",y="predicted R");
if (showPlots) print(ps[["1c"]]);
#--plot residuals
ps[["2a"]]  = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=z,y=residuals,colour=y)) +
ggplot2::geom_point() + ggplot2::geom_smooth() +
ggplot2::labs(x="size (mm CW)",y="deviance residuals");
if (showPlots) print(ps[["2a"]]);
ps[["2b"]]  = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=fits,y=residuals,colour=y)) +
ggplot2::geom_point() + ggplot2::geom_smooth() +
ggplot2::labs(x="fitted values",y="deviance residuals");
if (showPlots) print(ps[["2b"]]);
ps[["2c"]]  = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(sample=residuals)) +
ggplot2::geom_qq() + ggplot2::geom_qq_line() +
ggplot2::labs(x="fitted values",y="deviance residuals");
if (showPlots) print(ps[["2c"]]);
return(ps);
}
#'
#' @title Calculate the predicted (ln-scale) selectivity ratio across a grid of covariates
#' @description Function to calculate the predicted (ln-scale) selectivity ratio across a grid of covariates.
#'
#' @param model - [mgcv::gam()] model object
#' @param dfrNew - expanded grid tibble with covariate values at which to calculate the selectivity
#'
#' @return a tibble replicating dfrNew with additional columns prdLnR and seLnR
#'
#' @import mgcv
#' @importFrom dplyr mutate
#' @export
#'
calcPrdSel<-function(model,dfrNew){
prd = predict(model,newdata=dfrNew,se.fit=TRUE,type="link",newdata.guaranteed=TRUE);
dfrPrd = dfrNew |>
dplyr::mutate(prdLnR=prd$fit,   #--offset is lnq is 0, identically
seLnR=prd$se.fit);#--standard error
return(dfrPrd);
}
#'
#' @title Plot predicted selectivity estimates along 1 covariate
#'
#' @param dfrPrd - dataframe with columns prdLnR, seLnR, and covariates
#' @param x_ - covariate column to plot against
#' @param xlab - label for x axis
#' @param xints - x intercepts for vertical dashed reference lines (if not NULL)
#' @param dfrDat - original data to use for rug plots
#' @param ci - two-sided confidence interval
#' @return list of two plots (lnR, R vs.x_)
#' @importFrom wtsPlots getStdTheme
#' @import ggplot2
#' @export
#'
plotPrdSel1D<-function(dfrPrd,x_,xlab="size (mm CW)",xints=NULL,dfrDat=NULL,ci=0.80){
dci = (1-ci)/2;
mlt = pnorm(1-dci,0,1);#se multiplier corresponding to ci
ps = list();
#--plot predicted selectivity values
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y=prdLnR,ymin=prdLnR-mlt*seLnR,ymax=prdLnR+mlt*seLnR)) +
geom_line() + geom_ribbon(alpha=0.4) +
geom_hline(yintercept=log(c(0.5,1)),linetype=2) +
labs(x=xlab,y="ln(selectivity ratio)",
subtitle=paste0(tolower(x),"s: ","predicted ln-scale R with ",100*ci,"% CI.")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE)
ps[["lnR"]] = p;
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y=exp(prdLnR+(seLnR^2)/2),
ymin=exp(prdLnR-mlt*seLnR),ymax=exp(prdLnR+mlt*seLnR))) +
geom_line() + geom_ribbon(alpha=0.4) +
geom_hline(yintercept=c(0,0.5,1),linetype=2) +
labs(x=xlab,y="selectivity ratio",
subtitle=paste0(tolower(x),"s: ","predicted R with ",100*ci,"% CI.")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE)
ps[["R"]] = p;
return(ps);
}
#'
#' @title Plot predicted selectivity estimates across 2 covariates
#'
#' @param dfrPrd - dataframe with columns prdLnR, seLnR, and covariates
#' @param x_ - x-axis covariate column to plot against
#' @param y_ - y-axis covariate column to plot against
#' @param xlab - label for x axis
#' @param ylab - label for y axis
#' @param xints - x intercepts for vertical dashed reference lines (if not NULL)
#' @param dfrDat - original data to use for rug plots
#' @param ci - two-sided confidence interval
#' @return list of two plots (lnR, R vs.x_)
#' @importFrom wtsPlots getStdTheme
#' @import ggplot2
#' @export
#'
plotPrdSel2D<-function(dfrPrd,x_,y_,xlab="size (mm CW)",ylab="depth (m)",xints=NULL,dfrDat=NULL,ci=0.80){
dci = (1-ci)/2;
mlt = pnorm(1-dci,0,1);#se multiplier corresponding to ci
ps = list();
#--plot predicted selectivity values
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y={{y_}},z=prdLnR)) +
geom_contour(breaks=log(c(0.01,0.1,0.5,1,2,10))) +
labs(x=xlab,y=ylab,
subtitle=paste0(tolower(x),"s: ","predicted ln-scale R")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) {
p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE);
p = p + geom_rug(data=dfrDat,mapping=aes(y={{y_}}),inherit.aes=FALSE);
}
ps[["lnR"]] = p;
p = ggplot(data=dfrPrd,mapping=aes(x={{x_}},y={{y_}},z=exp(prdLnR+(seLnR^2)/2))) +
geom_contour_filled(breaks=c(0.01,0.1,0.5,1,2,10)) +
labs(x=xlab,ylab=ylab,
subtitle=paste0(tolower(x),"s: ","predicted R")) +
wtsPlots::getStdTheme();
if (!is.null(xints))  p = p + geom_vline(xintercept=xints,linetype=2);
if (!is.null(dfrDat)) {
p = p + geom_point(data=dfrDat,mapping=aes(x={{x_}},y={{y_}}),inherit.aes=FALSE,size=0.1,colour="white")
p = p + geom_rug(data=dfrDat,mapping=aes(x={{x_}}),inherit.aes=FALSE);
p = p + geom_rug(data=dfrDat,mapping=aes(y={{y_}}),inherit.aes=FALSE);
}
ps[["R"]] = p;
return(ps);
}
df_prdsel_zd = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=grd_z,d=grd_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_zd = plotPrdSel2D(df_prdsel_zd,x_=z,y=d,xlab="size (mm CW)",ylab="haul depth (m)",
xints=c(25,180),dfrDat=dfrDat,ci=0.80)
ps_prdsel_zd
df_prdsel_t = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=med_d,t=grd_t,f=med_f,s=med_s));
ps_prdsel_t = plotPrdSel1D(df_prdsel_t,x_=t,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
df_prdsel_f = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=med_d,t=med_t,f=grd_f,s=med_s));
ps_prdsel_f = plotPrdSel1D(df_prdsel_f,x_=f,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
df_prdsel_s = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=med_d,t=med_t,f=med_f,s=grd_s));
ps_prdsel_s = plotPrdSel1D(df_prdsel_s,x_=s,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
ps_prdsel_t
lst_prdtrms = wtsMGCV::predSmoothTerms(mdl$model,grids);
ps_prdtrms  = wtsMGCV::plotSmoothTerms(lst_prdtrms,labs=lbls,dfrDat=dfrDat,ori="V",ci=0.80)
ps_prdtrms
wtsMGCV::gam.check.plots(mdl$model);
_sumry)),collapse="\n");
wtsMGCV::gam.check(mdl$model);
txt_gamchk  = wtsMGCV::gam.check(mdl$model);
cat("```\nResults of checking the smooth term specifically are:\n",txt_gamchk,"\n```\n");
#---------mdlB_All1D: ALL 1-WAY TERMS----------------------------------
#--ln(r) = ti(z) + ti(d) + ti(t) + ti(f) + ti(s)
k=10;
frmla = p~ti(z,bs="ts",k=k)+ti(d,bs="ts",k=k)+ti(t,bs="ts",k=k)+ti(f,bs="ts",k=k)+ti(s,bs="ts",k=k);
mdlB_All1Da   = estSelRatio(dfrDat,frmla,family=fam,select=TRUE);
rm(k,frmla);
mdl = mdlB_All1Da;
lst_sumry   = summary(mdl$model);
txt_sumry   = paste0(capture.output(print(lst_sumry)),collapse="\n");
txt_gamchk  = wtsMGCV::gam.check(mdl$model);
ps_gamchk   = wtsMGCV::gam.check.plots(mdl$model);
lst_prdtrms = wtsMGCV::predSmoothTerms(mdl$model,grids);
ps_prdtrms  = wtsMGCV::plotSmoothTerms(lst_prdtrms,labs=lbls,dfrDat=dfrDat,ori="V",ci=0.80)
df_prdsel_z = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=grd_z,d=med_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_z = plotPrdSel1D(df_prdsel_z,x_=z,xlab="size (mm CW)",xints=c(25,180),dfrDat=dfrDat,ci=0.80)
df_prdsel_d = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=grd_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_d = plotPrdSel1D(df_prdsel_d,x_=d,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
df_prdsel_t = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=med_d,t=grd_t,f=med_f,s=med_s));
ps_prdsel_t = plotPrdSel1D(df_prdsel_t,x_=t,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
df_prdsel_f = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=med_d,t=med_t,f=grd_f,s=med_s));
ps_prdsel_f = plotPrdSel1D(df_prdsel_f,x_=f,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
df_prdsel_s = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=med_z,d=med_d,t=med_t,f=med_f,s=grd_s));
ps_prdsel_s = plotPrdSel1D(df_prdsel_s,x_=s,xlab="depth (m)",xints=NULL,dfrDat=dfrDat,ci=0.80)
df_prdsel_zd = calcPrdSel(mdl$model,wtsMGCV::createGridTbl(z=grd_z,d=grd_d,t=med_t,f=med_f,s=med_s));
ps_prdsel_zd = plotPrdSel2D(df_prdsel_zd,x_=z,y=d,xlab="size (mm CW)",ylab="haul depth (m)",
xints=c(25,180),dfrDat=dfrDat,ci=0.80)
rsltBM[["All1Da"]] = list(terms=list(lst=lst_prdtrms,plts=ps_prdtrms),
sumry=list(lst=lst_sumry,txt=txt_sumry,gamchk=txt_gamchk,plts=ps_gamchk),
sel1Ds=list(z=list(dfr=df_prdsel_z,plts=ps_prdsel_z)));
rm(mdl);
cat("```\nSummary results for this model are:\n",txt_sumry,"\n```\n");
cat("```\nResults of checking the smooth term specifically are:\n",txt_gamchk,"\n```\n");
#| label: fig-MdlB-All1Da-Diags
#| fig-cap: "Diagnostic plots for binomial model $ln(R_h,z) = \\alpha + s(z) + \\sum_i {\\beta_i \\cdot s_i(x_i)}$ with k=10."
if (!isPDF) print(ps_gamchk) else {
lbl = getLabel();
cap = wtsQMD::getFigCaption();
pth = file.path(dirFigs,basename(xfun::with_ext(knitr::fig_path(),def_ext)));
lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=def_wid,dpi=def_dpi);
ggsave(pth,plot=ps_gamchk,width=def_wid,height=def_wid/def_asp,units="in",dpi=def_dpi);
rm(lbl,cap,pth);
}
ps_prdsel_z
df_prdsel_d
ps_prdsel_d
df_prdsel_t
ps_prdsel_t
ps_prdsel_f
ps_prdsel_s = plotPrdSel1D(df_prdsel_s,x_=s,xlab="sorting coefficient",xints=NULL,dfrDat=dfrDat,ci=0.80)
ps_prdsel_s
dfrDatRE = dfrDat;
dfrDatRE$h = as.factor(dfrDatRE$h);
k = 20;
frmla = p~ti(z,bs="ts",k=k) + s(h,bs="re");
mdlB_1DREZb = estSelRatio(dfrDatRE,frmla,family=fam,select=TRUE);
mdl = mdlB_1DREZb;
summary(mdl$model);
lst_sumry   = summary(mdl$model);
txt_sumry   = paste0(capture.output(print(lst_sumry)),collapse="\n");
txt_gamchk  = wtsMGCV::gam.check(mdl$model);
ps_gamchk   = wtsMGCV::gam.check.plots(mdl$model);
lst_prdtrms = wtsMGCV::predSmoothTerms(mdl$model,grids);
lst_sumry   = summary(mdl$model);
txt_sumry   = paste0(capture.output(print(lst_sumry)),collapse="\n");
txt_gamchk  = wtsMGCV::gam.check(mdl$model);
ps_gamchk   = wtsMGCV::gam.check.plots(mdl$model);
lst_prdtrms = wtsMGCV::predSmoothTerms(mdl$model,grids);
wtsMGCV::getSmoothTerms(mdl)
View(mdl)
View(mdl$model)
gridsre = list(grids[],h=0);
lst_prdtrms = wtsMGCV::predSmoothTerms(mdl$model,gridsre);
grdTbl=wtsMGCV::createGridTbl(gridsre)
View(grdTbl)
gridsre = c(grids,list(h=0));
grdTbl=wtsMGCV::createGridTbl(gridsre)
View(grdTbl)
View(gridsre)
gc()
lst_prdtrms = wtsMGCV::predSmoothTerms(mdl$model,c(grids,h=0));
dfr = wtsMGCV::predSmoothTerm(mdl$model,wtsMGCV::createGridTbl(z=grd_z),"ti(z)",TRUE)
View(dfr)
mdl$model
dfr = wtsMGCV::predSmoothTerm(mdl$model,wtsMGCV::createGridTbl(h=unique(dfrDat$h)),"ti(h)",TRUE)
dfr = wtsMGCV::predSmoothTerm(mdl$model,wtsMGCV::createGridTbl(h=unique(dfrDat$h)),"s(h)",TRUE)
ggplot(dfr,aes(x=h,y=value,ymin=value-se,ymax=value+se))+geom_ribbon()+geom_line()
ggplot(dfr,aes(x=as.numeric(h),y=value,ymin=value-se,ymax=value+se))+geom_ribbon()+geom_line()
ggplot(dfr,aes(x=as.integer(h),y=value,ymin=value-se,ymax=value+se))+geom_ribbon()+geom_line()
ggplot(dfr,aes(x=levels(h),y=value,ymin=value-se,ymax=value+se))+geom_ribbon()+geom_line()
dfr$n=dplyr::row_number()
dfr$n=dplyr::row_number(dfr)
ggplot(dfr,aes(x=n,y=value,ymin=value-se,ymax=value+se))+geom_ribbon()+geom_line()
plot(mdl$model,residuals=TRUE,rug=TRUE)
plot(mdlB_All1Da,residuals=TRUE,rug=TRUE)
plot(mdlB_All1Da$model,residuals=TRUE,rug=TRUE)
plot.gam
load("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_Sediment_Analyses/rda_dfrHD_All_NMFS_WithInterpolatedSedValues.RData")
names(obj)
# Chunk 1: SedAnal2_setup
#| label: SedAnal2_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
testing = params$testing;
if (testing) cat(params$setup,"\n\n")
source(params$setup);
if (testing) cat("root = ",root,"\n\n")
reorderTables  = params$reorderTables;
reorderFigures = params$reorderFigures;
# Chunk 2: setup_SedAnal2
#| label: setup_SedAnal2
#| results: 'asis'
require(ggplot2);
require(kableExtra);
require(tables);
require(tcsamSurveyData);
#--also requires cowplot, dplyr, readr, rstudioapi, sf, stars,
#----wtsGIS, wtsPlots, wtsUtilities
Sum = wtsUtilities::Sum;
old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
cowplot::background_grid() +
cowplot::panel_border());
thm = wtsPlots::getStdTheme();
options("readr.show_col_types"=FALSE);
if (testing) cat("dirThs =",child_path$peek(),"\n\n")
if (rstudioapi::isAvailable()){
dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/03_SedimentAnalyses");
} else if (child_path$peek()!=""){
dirThs = child_path$peek();
} else {
dirThs = ".";
}
##--NOTE: take out or modify the following as necessary
if (!exists("s",mode="list")){
if (rstudioapi::isAvailable())
fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
if (child_path$peek()!="")
fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
#--for debugging: ;
if (file.exists(fn)) s = wtsUtilities::getObj(fn);
}
##--
#--get interpolation rasters
top<-file.path(dirThs,"02_SedimentAnalyses","Rasters");
fns<-c("CoKr_EditedGrainSizeRaster.tif",
"CoKr_EditedSortingRaster.tif");
rasters<-list();
for (fn in fns){
fnp<-stringr::str_remove(fn,(".tif"))
rasters[[fnp]]<-stars::read_stars(file.path(top,fn));
if (params$testing) plot(rasters[[fnp]]);
}
ls()
list.files(dirThs)
list.files(dirThs,pattern=glob2rx(*.*))
list.files(dirThs,pattern=glob2rx("*.*"))
dirThs
# Chunk 1: SedAnal2_setup
#| label: SedAnal2_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
testing = params$testing;
if (testing) cat(params$setup,"\n\n")
source(params$setup);
if (testing) cat("root = ",root,"\n\n")
reorderTables  = params$reorderTables;
reorderFigures = params$reorderFigures;
# Chunk 2: setup_SedAnal2
#| label: setup_SedAnal2
#| results: 'asis'
require(ggplot2);
require(kableExtra);
require(tables);
require(tcsamSurveyData);
#--also requires cowplot, dplyr, readr, rstudioapi, sf, stars,
#----wtsGIS, wtsPlots, wtsUtilities
Sum = wtsUtilities::Sum;
old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
cowplot::background_grid() +
cowplot::panel_border());
thm = wtsPlots::getStdTheme();
options("readr.show_col_types"=FALSE);
if (testing) cat("dirThs =",child_path$peek(),"\n\n")
if (rstudioapi::isAvailable()){
dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/03_Sediment_Analyses");
} else if (child_path$peek()!=""){
dirThs = child_path$peek();
} else {
dirThs = ".";
}
##--NOTE: take out or modify the following as necessary
if (!exists("s",mode="list")){
if (rstudioapi::isAvailable())
fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
if (child_path$peek()!="")
fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
#--for debugging: ;
if (file.exists(fn)) s = wtsUtilities::getObj(fn);
}
##--
#--get interpolation rasters
top<-file.path(dirThs,"02_SedimentAnalyses","Rasters");
fns<-c("CoKr_EditedGrainSizeRaster.tif",
"CoKr_EditedSortingRaster.tif");
rasters<-list();
for (fn in fns){
fnp<-stringr::str_remove(fn,(".tif"))
rasters[[fnp]]<-stars::read_stars(file.path(top,fn));
if (params$testing) plot(rasters[[fnp]]);
}
crs = sf::st_crs(rasters[[1]]);
#| label: fig-SedAnal2-MeanGrainSize
#| fig-cap: "Distribution of mean grain size (phi units) from the EBSSED2 database."
#--plot map of phi
bmls = wtsGIS::gg_CreateBasemapLayers();
ggplot() + bmls$bathym + bmls$bathym + bmls$map_scale + bmls$theme
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme +
geom_raster(rasters[[1]])
View(rasters)
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme +
stars::geom_stars(rasters[[1]])
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme +
stars::geom_stars(stars::as(rasters[[1]]))
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme +
stars::geom_stars(data=stars::as(rasters[[1]]))
rasters[1]
rasters[[1]]
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme +
stars::geom_stars(data=rasters[[1]])
ggplot() + bmls$land + bmls$bathym + bmls$theme +
stars::geom_stars(data=rasters[[1]])
bmls$map_scale$crs
ggplot() + bmls$land + bmls$bathym + bmls$theme +
stars::geom_stars(data=stars::st_transform(rasters[[1]],crs=bmls$map_scale$crs)
)
ggplot() + bmls$land + bmls$bathym + bmls$theme +
stars::geom_stars(data=stars::st_transform_proj(rasters[[1]],crs=bmls$map_scale$crs))
prj  = stars::st_transform_proj(rasters[[1]],crs=bmls$map_scale$crs);
ggplot() + bmls$land + bmls$bathym + bmls$theme +
stars::geom_stars(data=prj) +
scale_fill_viridis_c("magma") + labs(fill="phi")
ggplot() + bmls$land + bmls$bathym + bmls$map_scale + bmls$theme +
stars::geom_stars(data=prj) +
scale_fill_viridis_c(name="phi",option="magma")
ggplot() + bmls$land + bmls$bathym + bmls$theme +
stars::geom_stars(data=prj) +
bmls$map_scale +
scale_fill_viridis_c(name="phi",option="magma")
