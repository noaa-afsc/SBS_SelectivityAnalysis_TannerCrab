#| results: asis
dfr = tibble::tibble(model=names(maxSel),q=unname(maxSel),`size (mm CW)`=unname(maxSelZs));
View(dfr)
flextable::flextable(dfr);
flextable::flextable(dfr) |> flextable::vline(j=1);
flextable::flextable(dfr) |>
flextable::vline(j=1) |>
flextable::colformat_double(j=2,digits=3);
#| results: asis
dfr = tibble::tibble(model=names(maxSel),q=unname(maxSel),`size\n(mm CW)`=unname(maxSelZs));
flextable::flextable(dfr) |>
flextable::vline(j=1) |>
flextable::colformat_double(j=2,digits=3);
flextable::flextable(dfr) |>
flextable::vline(j=1) |>
flextable::colformat_double(j=2,digits=3) |>
flextable::width(j=2,width=2);
flextable::flextable(dfr) |>
flextable::vline(j=1) |>
flextable::colformat_double(j=2,digits=3) |>
flextable::width(j=3,width=2);
flextable::flextable(dfr) |>
flextable::vline(j=1) |>
flextable::colformat_double(j=2,digits=3) |>
flextable::width(j=3,width=1);
library(stringr)
# Chunk 1: SurvSel_setup
#| label: SurvSel_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
testing = params$testing;
if (testing) cat(params$setup,"\n\n")
source(params$setup);
if (testing) cat("root = ",root,"\n\n")
reorderTables  = params$reorderTables;
reorderFigures = params$reorderFigures;
# Chunk 2: setup_SurvSel
#| label: setup_SurvSel
#| results: 'asis'
require(ggplot2);
require(gratia);
require(kableExtra);
require(mgcv);
require(tables);
require(tcsamSurveyData);
flextable::set_flextable_defaults(font.size=11);
Sum = wtsUtilities::Sum;
old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
cowplot::background_grid() +
cowplot::panel_border());
thm = wtsPlots::getStdTheme();
options("readr.show_col_types"=FALSE);
if (testing) cat("dirThs =",child_path$peek(),"\n\n")
if (rstudioapi::isAvailable()){
dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/02_Empirical_Selectivity");
} else if (child_path$peek()!=""){
dirThs = child_path$peek();
} else {
dirThs = ".";
}
##--NOTE: take out or modify the following as necessary
if (!exists("s")){
if (rstudioapi::isAvailable())
fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
if (child_path$peek()!="")
fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
#--for debugging: ;
if (file.exists(fn)) s = wtsUtilities::getObj(fn);
}
##--
# Chunk 3: SurvSel-GetESs
ofn = file.path(dirThs,"rda_Step1_EmpiricalSelectivityFromData.RData");
lst = wtsUtilities::getObj(ofn);
dfrESs = lst$dfrESs |> dplyr::mutate(y=factor(as.character(y)));
rm(lst);
# Chunk 4: SurvSel-DefModelFcns
#----function to predict values based on a model
prdMod<-function(mdl,trms,lst,type="response",keep=NULL,p=0.05){
dfr = wtsMGCV::createGridTbl(lst);
if (any(trms=="all")){
#--add intercept and all smooth terms
trmsp = "(Intercept)";
trms = wtsMGCV::getSmoothTerms(mdl);
for (trm in trms) trmsp = c(trmsp,trm);
trms = trmsp;
}
prd = dplyr::bind_cols(
dfr,
tibble::as_tibble(
mgcv::predict.gam(mdl,dfr,type=type,terms=trms,se.fit=TRUE),
) |>
dplyr::mutate(type="fit",
lci=qnorm(p,fit,se.fit,lower.tail=TRUE),
uci=qnorm(p,fit,se.fit,lower.tail=FALSE),
terms=paste(trms,collapse=" + "))
) |>
dplyr::rename(emp_sel=fit);
if (!is.null(keep)){
prd = prd |>
dplyr::distinct(pick(tidyselect::any_of(keep),emp_sel,se.fit,lci,uci,terms));
drop = names(lst)[!(names(lst) %in% keep)];
for (drp in drop) prd[[drp]] = NA;
}
return(prd);
}
plotMod<-function(tmp,ylims=c(0,1.5)){
if (all(is.na(tmp$y))) tmp$y = "all";
p = ggplot(tmp,aes(x=z,y=emp_sel,ymin=lci,ymax=uci,colour=y,fill=y));
if ("n" %in% names(tmp)){
p = p + geom_point(aes(size=n)) + scale_size_area() +
geom_line();
}
p = p +
geom_ribbon(alpha=0.3) +
geom_line() +
geom_hline(yintercept=0.5,linetype=3) +
scale_y_continuous(limits=ylims,oob=scales::squish) +
labs(x="size (mm CW)",y="empirical\nselectivity",
colour="study\nyear",fill="study\nyear",size="crab\nsampled") +
theme(legend.position="inside",
legend.position.inside=c(0.01,0.99),
legend.justification.inside=c(0,1),
legend.byrow=TRUE,
legend.box="horizontal");
return(p);
}
#----function to do model diagnostics
doDiagnostics<-function(mod){
summary(mod);
plot(mod,page=1);
gam.check(mod);
}
#----functions to create a "glance" comparison table for multiple models
glance_gam <- function(x, ...) {
s <- summary(x)
gl = broom:::as_glance_tibble(
family=x$family$family,
df = sum(x$edf),
logLik = as.numeric(stats::logLik(x)),
AIC = stats::AIC(x),
BIC = stats::BIC(x),
deviance = stats::deviance(x),
df.residual = stats::df.residual(x),
`N(obs)` = stats::nobs(x),
`adj. R^2` = s$r.sq,
`N(params)` = s$np,
na_types = "cirrrriiri"
)
return(gl);
}
getGlance<-function(mdls){
lst = list();
for (mdl in names(mdls)){
lst[[mdl]] = glance_gam(mdls[[mdl]]) |> dplyr::mutate(model=mdl);
}
lvls = c("family","AIC","BIC","deviance","adj. R^2","df","N(params)","N(obs)");
dfrGl = dplyr::bind_rows(lst) |>
dplyr::select(tidyselect::all_of(c("model",lvls)));
# tidyr::pivot_longer(cols=1:(ncol(lst[[1]])-1),names_to="quantity",values_to="value") |>
# dplyr::filter(quantity %in% lvls) |>
# dplyr::mutate(quantity=factor(quantity,levels=lvls)) |>
# dplyr::arrange(quantity) |>
# tidyr::pivot_wider(names_from="model");
return(dfrGl);
}
#--function to get table comparing summary statistics among the models
getSmryFlxTbl<-function(mdls){
dfrGl = getGlance(mdls);
lvls = names(dfrGl)[3:length(names(dfrGl))];#--names except "model" and "family"
lvls1 = lvls[1:5];#--lvls except N(params) and N(obs)
lvls2 = lvls[6:7];#--N(params) and N(obs)
dfrGl1 = dfrGl |> dplyr::select(tidyselect::all_of(c("model",lvls1))) |>
tidyr::pivot_longer(cols=tidyselect::all_of(lvls1),
names_to="quantity",values_to="value") |>
dplyr::mutate(quantity=factor(quantity,levels=lvls1)) |>
dplyr::arrange(quantity) |>
tidyr::pivot_wider(names_from="model");
dfrGl2 = dfrGl |> dplyr::select(tidyselect::all_of(c("model",lvls2))) |>
tidyr::pivot_longer(cols=tidyselect::all_of(lvls2),
names_to="quantity",values_to="value") |>
dplyr::mutate(quantity=factor(quantity,levels=lvls2)) |>
dplyr::arrange(quantity) |>
tidyr::pivot_wider(names_from="model");
dfrFs = dfrGl |> dplyr::select(model,family) |>
dplyr::mutate(family=paste(stringr::str_split_1(family,"(")[1],
stringr::str_split_1(stringr::str_split_1(family,"(")[2],")")[1]));
ft1 = flextable::flextable(dfrGl1) |>
flextable::colformat_double(digits=2);
ft2 = flextable::flextable(dfrGl2);
ft1 = ft1 |> flextable::add_body_row(top=TRUE,values=c("family",dfrFs$family[]));
for (r in 1:nrow(dfrGl2))
ft1 = ft1 |> flextable::add_body_row(top=FALSE,values=dfrGl2[r,])
ft1 = ft1 |>
flextable::theme_booktabs() |>
flextable::align(j=2:4,align="center",part="all") |>
flextable::vline(j=1,part="all")
return(ft1);
}
# Chunk 5: fig-SurvSel-AnnualM
#| label: fig-SurvSel-AnnualM
#| fig-cap: "Comparison of annual empirical estimates of NMFS survey selectivity for male Tanner crab. An overall (unweighted) smoothed trend and simple uncertainty interval are indicated by the thick blue line and grey shading."
#| fig-asp: 0.6
dfrESsp = dfrESs |> dplyr::filter(x=="male");
tmp = dfrESsp;
tmp$totN = tmp$n_BSFRF+tmp$n_NMFS;
tmp$y = factor(tmp$y)
p1 = ggplot(data=tmp,mapping=aes(x=z,y=emp_sel,colour=y,size=totN)) +
geom_point() + scale_size_area() +
geom_line(mapping=aes(x=z,y=emp_sel,colour=y),inherit.aes=FALSE) +
geom_smooth(mapping=aes(x=z,y=emp_sel),inherit.aes = FALSE) +
facet_grid(rows = .~x,scales = "free_x") +
labs(x="size (mm CW)",y="empirical\ncatchability",
colour="study\nyear",size="crab\nsampled") +
wtsPlots::getStdTheme() +
theme(legend.position.inside=c(0.01,0.99),
legend.justification=c(0,1),
panel.grid=element_line(colour="grey"),
panel.grid.minor.y=element_blank());
lstFigs = c(lstFigs,wtsQMD::printGGplot(p1));
rm(tmp,p1);
# Chunk 6: EmpSel-CalcModelsEmpSelFcnsM
mdl1m = mgcv::gam(emp_sel ~ s(z,bs="tp",k=10),
family=mgcv::tw,data=dfrESsp,method="REML",
weights=n_BSFRF/mean(n_BSFRF));
mdl2m = mgcv::gam(emp_sel ~ s(z,bs="tp",k=10) + ti(z,by=y,bs="sz"),
family=mgcv::tw,data=dfrESsp,method="REML",select=TRUE,
weights=n_BSFRF/mean(n_BSFRF));
#--add "non-study" level to reflect uncertainty associated with unknown random effects
dfrESsp1 = dfrESsp |> dplyr::mutate(y=factor(as.character(y),levels=c("non-study",levels(y))));
mdl3m = mgcv::gam(emp_sel ~ s(z,bs="tp",k=10) + s(z,y,bs="fs"),
family=mgcv::tw,data=dfrESsp1,method="REML",select=TRUE,
weights=n_BSFRF/mean(n_BSFRF),
drop.unused.levels=FALSE);
#--define prediction grids
grids = list(z=(dfrESsp |> dplyr::distinct(z))[[1]],
y=(dfrESsp |> dplyr::distinct(y))[[1]]);
grids1 = list(z=(dfrESsp |> dplyr::distinct(z))[[1]],
y=factor("non-study"));
#--predict time-invariant response
prd1mt = prdMod(mdl1m,trms=c("(Intercept)","s(z)"),
lst=grids,type="response",keep="z");
prd2mt = prdMod(mdl2m,trms=c("(Intercept)","s(z)"),
lst=grids,type="response",keep="z");
prd3mt = prdMod(mdl3m,trms=c("(Intercept)","s(z)"),
lst=grids1,type="response",keep="z");
maxSel = c("Model 1"=max(prd1mt$emp_sel),
"Model 2"=max(prd2mt$emp_sel),
"Model 3"=max(prd3mt$emp_sel));
maxSelZs = c("Model 1"=(dplyr::filter(prd1mt,emp_sel==maxSel["Model 1"])[1,])$z,
"Model 2"=(dplyr::filter(prd2mt,emp_sel==maxSel["Model 2"])[1,])$z,
"Model 3"=(dplyr::filter(prd3mt,emp_sel==maxSel["Model 3"])[1,])$z);
mdls = list(`Model 1`=mdl1m,`Model 2`=mdl2m,`Model 3`=mdl3m);
ft = getSmryFlxTbl(mdls);
dfrGl = getGlance(mdls);
dfrFs = dfrGl |> dplyr::select(model,family) |>
dplyr::rowwise() |>
dplyr::mutate(family=paste(stringr::str_split_1(family,"(")[1],
stringr::str_split_1(stringr::str_split_1(family,"(")[2],")")[1]));
dfrFs = dfrGl |> dplyr::select(model,family) |>
dplyr::rowwise() |>
dplyr::mutate(family=paste(stringr::str_split_1(family,"\(")[1],
dfrFs = dfrGl |> dplyr::select(model,family) |>
dplyr::rowwise() |>
dplyr::mutate(family= paste(
stringr::str_split_1(family,"\\(")[1],
stringr::str_split_1(stringr::str_split_1(family,"\\(")[2],"\\)")[1]
)
);
View(dfrFs)
lvls = names(dfrGl)[3:length(names(dfrGl))];#--names except "model" and "family"
lvls1 = lvls[1:5];#--lvls except N(params) and N(obs)
lvls2 = lvls[6:7];#--N(params) and N(obs)
dfrGl1 = dfrGl |> dplyr::select(tidyselect::all_of(c("model",lvls1))) |>
tidyr::pivot_longer(cols=tidyselect::all_of(lvls1),
names_to="quantity",values_to="value") |>
dplyr::mutate(quantity=factor(quantity,levels=lvls1)) |>
dplyr::arrange(quantity) |>
tidyr::pivot_wider(names_from="model");
dfrGl2 = dfrGl |> dplyr::select(tidyselect::all_of(c("model",lvls2))) |>
tidyr::pivot_longer(cols=tidyselect::all_of(lvls2),
names_to="quantity",values_to="value") |>
dplyr::mutate(quantity=factor(quantity,levels=lvls2)) |>
dplyr::arrange(quantity) |>
tidyr::pivot_wider(names_from="model");
ft1 = flextable::flextable(dfrGl1) |>
flextable::colformat_double(digits=2);
ft2 = flextable::flextable(dfrGl2);
ft1 = ft1 |> flextable::add_body_row(top=TRUE,values=c("family",dfrFs$family[]));
for (r in 1:nrow(dfrGl2))
ft1 = ft1 |> flextable::add_body_row(top=FALSE,values=dfrGl2[r,])
ft1 = ft1 |>
flextable::theme_booktabs() |>
flextable::align(j=2:4,align="center",part="all") |>
flextable::vline(j=1,part="all")
ft1
citation("DHARMa")
dfr1 = gratia:::smooth_estimates(mdl1m,select="s(z)",partial_match=TRUE,
unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |> dplyr::mutate(model="Model 1");
dfr2 = gratia:::smooth_estimates(mdl2m,select="s(z)",
unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |> dplyr::mutate(model="Model 2");
dfr3 = gratia:::smooth_estimates(mdl3m,select="s(z)",
unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |> dplyr::mutate(model="Model 3");
dfr = dplyr::bind_rows(dfr1,dfr2,dfr3);
dfrPRs1 = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl1m,select=paste0("s(z)")) |>
dplyr::rename(residuals=any_of(paste0("s(z)")))) |>
dplyr::mutate(model="Model 1");
dfrPRs2 = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl2m,select="s(z)") |>
dplyr::rename(residuals="s(z)")) |>
dplyr::mutate(model="Model 2");
dfrPRs3 = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl3m,select="s(z)") |>
dplyr::rename(residuals="s(z)")) |>
dplyr::mutate(model="Model 3");
dfrPRs = dplyr::bind_rows(dfrPRs1,dfrPRs2,dfrPRs3);
p1 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),
inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") +
facet_wrap(~model,ncol=1) +
labs(x="size (mm CW)",y="link scale",colour="study\nyear",fill="study\nyear");
p1
dfr = gratia:::smooth_estimates(mdl3m,select="s(z,y)",unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint();
View(dfr)
str(dfr$y)
dfr = gratia:::smooth_estimates(mdl3m,select="s(z,y)",unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.characer(2013:2018),"non-study")));
dfr = gratia:::smooth_estimates(mdl3m,select="s(z,y)",unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.character(2013:2018),"non-study")));
dfrPRs = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl3m,select="s(z,y)") |>
dplyr::rename(residuals="s(z,y)"));
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci,colour=y,fill=y)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear"); # +
p2
prd3m = prdMod(mdl3m,trms=c("all"),lst=grids,type="response");
p1 = plotMod(prd3m,c(0,1.5)) + theme(axis.title.x=element_blank());
dfr = gratia:::smooth_estimates(mdl3m,select="s(z,y)",unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.character(2013:2018),"non-study")));
dfrPRs = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl3m,select="s(z,y)") |>
dplyr::rename(residuals="s(z,y)"));
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci,colour=y,fill=y)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear"); # +
pg = cowplot::plot_grid(p1,p2,ncol=1);
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci,colour=y,fill=y)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
guides(colour="none") +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.5,0.0));
ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci,colour=y,fill=y)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
guides(colour="none",fill="none") +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.5,0.0),
legend.direction="horizontal");
ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci,colour=y,fill=y)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
guides(colour="none",fill="none") +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.4,0.2),
legend.direction="horizontal");
prd3m = prdMod(mdl3m,trms=c("all"),lst=grids,type="response");
p1 = plotMod(prd3m,c(0,1.5)) + theme(axis.title.x=element_blank());
dfr = gratia:::smooth_estimates(mdl3m,select="s(z,y)",unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.character(2013:2018),"non-study")));
dfrPRs = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl3m,select="s(z,y)") |>
dplyr::rename(residuals="s(z,y)"));
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci,colour=y,fill=y)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,colour=y,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
guides(colour="none",fill="none") +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.4,0.2),
legend.direction="horizontal");
pg = cowplot::plot_grid(p1,p2,ncol=1);
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
pg = cowplot::plot_grid(p1,p2,ncol=1,rel_heights=c(1,2));
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
guides(colour="none",fill="none") +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.4,0.2),
legend.direction="horizontal");
pg = cowplot::plot_grid(p1,p2,ncol=1,rel_heights=c(1,2));
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
prd2m = prdMod(mdl2m,trms=c("all"),lst=grids,type="response");
p1 = plotMod(prd2m,c(0,1.5));
dfr = gratia:::smooth_estimates(mdl2m,select="ti(z):y",partial_match=TRUE,
unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.character(2013:2018),"non-study")));
lstPRs = list();
for (y_ in levels(dfrESs$y))
lstPRs[[y_]] = dplyr::bind_cols(
dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl2m,select=paste0("ti(z):y",y_)) |>
dplyr::rename(residuals=any_of(paste0("ti(z):y",y_)))
) |> dplyr::filter(y==y_);
dfrPRs = dplyr::bind_rows(lstPRs);
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,size=n_BSFRF),
inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
labs(x="size (mm CW)",y="link scale",colour="study\nyear",fill="study\nyear");
pg = cowplot::plot_grid(p1,p2,ncol=1);
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,size=n_BSFRF),
inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y,drop=FALSE) +
labs(x="size (mm CW)",y="link scale",colour="study\nyear",fill="study\nyear");
pg = cowplot::plot_grid(p1,p2,ncol=1);
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
prd2m = prdMod(mdl2m,trms=c("all"),lst=grids,type="response");
p1 = plotMod(prd2m,c(0,1.5));
dfr = gratia:::smooth_estimates(mdl2m,select="ti(z):y",partial_match=TRUE,
unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.character(2013:2018),"non-study")));
lstPRs = list();
for (y_ in levels(dfrESs$y))
lstPRs[[y_]] = dplyr::bind_cols(
dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl2m,select=paste0("ti(z):y",y_)) |>
dplyr::rename(residuals=any_of(paste0("ti(z):y",y_)))
) |> dplyr::filter(y==y_);
dfrPRs = dplyr::bind_rows(lstPRs);
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,size=n_BSFRF),
inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y,drop=FALSE) +
guides(colour="none",fill="none") +
labs(x="size (mm CW)",y="link scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.4,0.2),
legend.direction="horizontal");
pg = cowplot::plot_grid(p1,p2,ncol=1,rel_heights=c(1,2));
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
prd3m = prdMod(mdl3m,trms=c("all"),lst=grids,type="response");
p1 = plotMod(prd3m,c(0,1.5)) + theme(axis.title.x=element_blank());
dfr = gratia:::smooth_estimates(mdl3m,select="s(z,y)",unconditional=TRUE,overall_uncertainty=TRUE) |>
gratia::add_confint() |>
dplyr::mutate(y=factor(as.character(y),
levels=c(as.character(2013:2018),"non-study")));
dfrPRs = dplyr::bind_cols(dfrESsp |> dplyr::filter(!is.na(emp_sel)),
gratia::partial_residuals(mdl3m,select="s(z,y)") |>
dplyr::rename(residuals="s(z,y)"));
p2 = ggplot(dfr,aes(x=z,y=.estimate,ymin=.lower_ci,ymax=.upper_ci)) +
geom_line() + geom_ribbon(colour=NA,alpha=0.3) +
geom_point(data=dfrPRs,mapping=aes(x=z,y=residuals,size=n_BSFRF),inherit.aes=FALSE) +
scale_size_area(name="n (BSFRF)") + facet_wrap(~y) +
guides(colour="none",fill="none") +
labs(x="size (mm CW)",y="link-scale",colour="study\nyear",fill="study\nyear") +
theme(legend.justification=c(0.0,0.0),
legend.position="inside",
legend.position.inside=c(0.4,0.2),
legend.direction="horizontal");
pg = cowplot::plot_grid(p1,p2,ncol=1,rel_heights=c(1,2));
lstFigs = c(lstFigs,wtsQMD::printGGplot(pg));
resSimMdl1m = DHARMa::simulateResiduals(mdl1m);
require(mgcv)
resSimMdl1m = DHARMa::simulateResiduals(mdl1m);
lstFigs = c(lstFigs,wtsQMD::printRGraphics(expression(plot(resSimMdl1m)),ori="L"));
