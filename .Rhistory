rm(lst);
#--dfrRSD_BSFRF_SBS and dfrRSD_NMFS_SBS are identical
#--one needs to replace dfrRSD_SBS so re-ordering is correct
dfrRSD_SBS<-dfrRSD_BSFRF_SBS;
rm(dfrRSD_BSFRF_SBS,dfrRSD_NMFS_SBS);
#--now replace HAULJOINS with newHAULJOINS
dfrRHD_BSFRF_SBS %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
dfrRID_BSFRF_SBS %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
dfrRHD_NMFS_SBS  %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
dfrRID_NMFS_SBS  %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
#--rename GIS_STATIONS to avoid duplicates
dfrRSD_SBS$GIS_STATION      <-as.character(1:nS_SBS);
dfrRHD_BSFRF_SBS$GIS_STATION<-as.character(1:nS_SBS);
dfrRHD_NMFS_SBS$GIS_STATION <-as.character(1:nS_SBS);
#--create single stratum for SBS stations
dfrRSD_SBS %<>% dplyr::mutate(STRATUM="1", STRATUM_CODE="1",
STRATUM_AREA=wtsUtilities::Sum(STATION_AREA),
STRATUM_AREA_BYSTATION=STRATUM_AREA);
# dfrRSD_SBS$STRATUM<-"1";
# dfrRSD_SBS$STRATUM_CODE<-"1";
# dfrRSD_SBS$STRATUM_AREA          <-sum(dfrRSD_SBS$STATION_AREA,na.rm=TRUE);
# dfrRSD_SBS$STRATUM_AREA_BYSTATION<-sum(dfrRSD_SBS$STATION_AREA,na.rm=TRUE);
dfrRHD_BSFRF_SBS$STRATUM<-"1";
dfrRHD_NMFS_SBS$STRATUM <-"1";
#--recast data into form required by selfisher
#----join area swept and sampling factor info to indiv data
recastIndivData1<-function(idfr){
#--NEW 2026-02-02:
#--now summing SAMPLING_FACTOR similar to numIndivs within a size bin
#--rather than using it as a "group by" variable
qry<-"select
HAULJOIN, SEX, SIZE,
sum(SAMPLING_FACTOR) as SAMPLING_FACTOR,
sum(numIndivs) as numIndivs
from idfr as i
group by
HAULJOIN, SEX, SIZE;";  #--pre 2026-02-02: SAMPLING_FACTOR was a grouping variable
res<-sqldf::sqldf(qry);
return(res);
}
dfrRCI_NMFS <-recastIndivData1(dfrRID_NMFS_SBS);
dfrRCI_BSFRF<-recastIndivData1(dfrRID_BSFRF_SBS);
uHs<-unique(unique(dfrRCI_BSFRF$HAULJOIN),unique(dfrRCI_NMFS$SHAULJOIN));
uXs<-unique(unique(dfrRCI_BSFRF$SEX),     unique(dfrRCI_NMFS$SEX));
uZs<-unique(unique(dfrRCI_BSFRF$SIZE),    unique(dfrRCI_NMFS$SIZE));
#--expand indiv info dataframes to all hauljoins, sexes, and sizes
expandIndivData<-function(idfr,uHs,uXs,uZs){
uHs<-data.frame(HAULJOIN=uHs,stringsAsFactors=FALSE);
uXs<-data.frame(SEX=uXs,stringsAsFactors=FALSE);
uZs<-data.frame(SIZE=uZs,stringsAsFactors=FALSE);
qry<-"select HAULJOIN,SEX,SIZE from uHs,uXs,uZs;";
uHXZs<-sqldf::sqldf(qry);
qry<-"select
u.HAULJOIN,u.SEX,u.SIZE,
i.SAMPLING_FACTOR,i.numIndivs
from uHXZs as u left join idfr as i
on
u.HAULJOIN=i.HAULJOIN and
u.SEX=i.SEX and
u.SIZE=i.SIZE;";
tmp<-sqldf::sqldf(qry);
idx<-is.na(tmp$numIndivs);
tmp$SAMPLING_FACTOR[idx]<-1;
tmp$numIndivs[idx]      <-0;
return(tmp);
}
dfrREI_NMFS <-expandIndivData(dfrRCI_NMFS, uHs,uXs,uZs);
dfrREI_BSFRF<-expandIndivData(dfrRCI_BSFRF,uHs,uXs,uZs);
for (iY in uYs){
if (testing) cat("Processing",iY,"\n");
#--get actual SBS stations, hauls, and indiv data for year iY
dfrYSD_SBS<-dfrSD_SBS[dfrSD_SBS$YEAR==iY,];
dfrYHD_BSFRF_SBS<-dfrHD_BSFRF_SBS[dfrHD_BSFRF_SBS$YEAR==iY,];
dfrYID_BSFRF_SBS<-dfrID_BSFRF_SBS[dfrID_BSFRF_SBS$HAULJOIN %in% dfrYHD_BSFRF_SBS$HAULJOIN,];
dfrYHD_NMFS_SBS <-dfrHD_NMFS_SBS[dfrHD_NMFS_SBS$YEAR==iY,];
dfrYID_NMFS_SBS <-dfrID_NMFS_SBS[dfrID_NMFS_SBS$HAULJOIN %in% dfrYHD_NMFS_SBS$HAULJOIN,];
#--get number of stations/hauls in EBS for year iY
nS_SBS <- nrow(dfrYSD_SBS);
#--DON'T resample from SBS stations
# idS_SBS <- ceiling(stats::runif(n=nS_SBS,min=0,max=nS_SBS));#random index to row of dfrSDy_SBS
# dfrRSD_SBS<-dfrYSD_SBS[idS_SBS,];#--resampled SBS stations
dfrRSD_SBS<-dfrYSD_SBS;#--use original SBS stations (will be resampled stations in step3a)
#----extract BSFRF hauls and individuals (don't really need to do this, but consistent with step3a)
lst<-extractHaulsAndIndivs(dfrRSD_SBS,dfrYHD_BSFRF_SBS,dfrYID_BSFRF_SBS,resampleIndivs=FALSE);
dfrRSD_BSFRF_SBS<-lst$dfrSDr;#--rows have been reordered in ascending order
dfrRHD_BSFRF_SBS<-lst$dfrHDr;#--newHAULJOINs indicate row in dfrRSD_BSFRF_SBS, newHAULJOINS must replace HAULJOINS below
dfrRID_BSFRF_SBS<-lst$dfrIDr;#--newHAULJOINs match those in dfrRHD_BSFRF_SBS, newHAULJOINS must replace HAULJOINS below
rm(lst);
#----DON'T resample NMFS hauls and individuals
lst<-extractHaulsAndIndivs(dfrRSD_SBS,dfrYHD_NMFS_SBS,dfrYID_NMFS_SBS,resampleIndivs=FALSE);
dfrRSD_NMFS_SBS<-lst$dfrSDr;#--rows have been reordered in ascending order
dfrRHD_NMFS_SBS<-lst$dfrHDr;#--newHAULJOINs indicate row in dfrRSD_NMFS_SBS, newHAULJOINS must replace HAULJOINS below
dfrRID_NMFS_SBS<-lst$dfrIDr;#--newHAULJOINs match those in dfrRHD_NMFS_SBS, newHAULJOINS must replace HAULJOINS below
rm(lst);
#--dfrRSD_BSFRF_SBS and dfrRSD_NMFS_SBS are identical
#--one needs to replace dfrRSD_SBS so re-ordering is correct
dfrRSD_SBS<-dfrRSD_BSFRF_SBS;
rm(dfrRSD_BSFRF_SBS,dfrRSD_NMFS_SBS);
#--now replace HAULJOINS with newHAULJOINS
dfrRHD_BSFRF_SBS %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
dfrRID_BSFRF_SBS %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
dfrRHD_NMFS_SBS  %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
dfrRID_NMFS_SBS  %<>% dplyr::mutate(HAULJOIN=newHAULJOIN) |> dplyr::select(-newHAULJOIN);
#--rename GIS_STATIONS to avoid duplicates
dfrRSD_SBS$GIS_STATION      <-as.character(1:nS_SBS);
dfrRHD_BSFRF_SBS$GIS_STATION<-as.character(1:nS_SBS);
dfrRHD_NMFS_SBS$GIS_STATION <-as.character(1:nS_SBS);
#--create single stratum for SBS stations
dfrRSD_SBS %<>% dplyr::mutate(STRATUM="1", STRATUM_CODE="1",
STRATUM_AREA=wtsUtilities::Sum(STATION_AREA),
STRATUM_AREA_BYSTATION=STRATUM_AREA);
# dfrRSD_SBS$STRATUM<-"1";
# dfrRSD_SBS$STRATUM_CODE<-"1";
# dfrRSD_SBS$STRATUM_AREA          <-sum(dfrRSD_SBS$STATION_AREA,na.rm=TRUE);
# dfrRSD_SBS$STRATUM_AREA_BYSTATION<-sum(dfrRSD_SBS$STATION_AREA,na.rm=TRUE);
dfrRHD_BSFRF_SBS$STRATUM<-"1";
dfrRHD_NMFS_SBS$STRATUM <-"1";
#--recast data into form required by selfisher
#----join area swept and sampling factor info to indiv data
recastIndivData1<-function(idfr){
#--NEW 2026-02-02:
#--now summing SAMPLING_FACTOR similar to numIndivs within a size bin
#--rather than using it as a "group by" variable
qry<-"select
HAULJOIN, SEX, SIZE,
sum(SAMPLING_FACTOR) as SAMPLING_FACTOR,
sum(numIndivs) as numIndivs
from idfr as i
group by
HAULJOIN, SEX, SIZE;";  #--pre 2026-02-02: SAMPLING_FACTOR was a grouping variable
res<-sqldf::sqldf(qry);
return(res);
}
dfrRCI_NMFS <-recastIndivData1(dfrRID_NMFS_SBS);
dfrRCI_BSFRF<-recastIndivData1(dfrRID_BSFRF_SBS);
uHs<-unique(unique(dfrRCI_BSFRF$HAULJOIN),unique(dfrRCI_NMFS$SHAULJOIN));
uXs<-unique(unique(dfrRCI_BSFRF$SEX),     unique(dfrRCI_NMFS$SEX));
uZs<-unique(unique(dfrRCI_BSFRF$SIZE),    unique(dfrRCI_NMFS$SIZE));
#--expand indiv info dataframes to all hauljoins, sexes, and sizes
expandIndivData<-function(idfr,uHs,uXs,uZs){
uHs<-data.frame(HAULJOIN=uHs,stringsAsFactors=FALSE);
uXs<-data.frame(SEX=uXs,stringsAsFactors=FALSE);
uZs<-data.frame(SIZE=uZs,stringsAsFactors=FALSE);
qry<-"select HAULJOIN,SEX,SIZE from uHs,uXs,uZs;";
uHXZs<-sqldf::sqldf(qry);
qry<-"select
u.HAULJOIN,u.SEX,u.SIZE,
i.SAMPLING_FACTOR,i.numIndivs
from uHXZs as u left join idfr as i
on
u.HAULJOIN=i.HAULJOIN and
u.SEX=i.SEX and
u.SIZE=i.SIZE;";
tmp<-sqldf::sqldf(qry);
idx<-is.na(tmp$numIndivs);
tmp$SAMPLING_FACTOR[idx]<-1;
tmp$numIndivs[idx]      <-0;
return(tmp);
}
dfrREI_NMFS <-expandIndivData(dfrRCI_NMFS, uHs,uXs,uZs);
dfrREI_BSFRF<-expandIndivData(dfrRCI_BSFRF,uHs,uXs,uZs);
#--merge haul+sediment data with indiv data
#----note: the expansion factors are defined such that
#        CPUE [number/(unit area)] = (number sampled)*expFactor
#----and expFactor = 1/(AREA_SWEPT*fraction sampled)
##--pre-2026-02-02, SAMPLING_FACTOR was incorrectly assumed to apply to all sampled individuals w/in a size bin
##--and used as a grouping variable to sum numIndivs above. If this assumption had been correct, then
#----SAMPLING_FACTOR = 1/(sampling fraction) and
#----expFactor = SAMPLING_FACTOR/AREA_SWEPT = 1/(AREA_SWEPT * (sampling fraction))
##--2026-02-02 correction: SAMPLING_FACTOR is now summed above in the same manner as numIndivs, thus
##--sampling fraction for crab in a size bin = numIndivs/SAMPLING_FACTOR and
##--expFactor for a size bin = (SAMPLING_FACTOR/numIndivs)/AREA_SWEPT
mergeHaulData<-function(hdfr,idfr){
qry<-"select
h.HAULJOIN, BOTTOM_DEPTH, GEAR_TEMPERATURE, phi, sorting,
AREA_SWEPT_VARIABLE,
SEX, SIZE,
(SAMPLING_FACTOR/numIndivs)/AREA_SWEPT_VARIABLE as expFACTOR,
SAMPLING_FACTOR/numIndivs as SAMPLING_FACTOR,
numIndivs
from hdfr as h, idfr as i
where
h.HAULJOIN = i.HAULJOIN";
res<-sqldf::sqldf(qry);
#--note: SAMPLING_FACTOR is now the mean sampling factor over sampled crab within a size bin
return(res);
}
dfrRHI_NMFS <-mergeHaulData(dfrRHD_NMFS_SBS, dfrREI_NMFS);
dfrRHI_BSFRF<-mergeHaulData(dfrRHD_BSFRF_SBS,dfrREI_BSFRF);
#--merge BSFRF and NMFS RHI dataframes
qry<-"select
n.HAULJOIN,n.BOTTOM_DEPTH, n.GEAR_TEMPERATURE,n.phi,n.sorting,
n.SEX,n.SIZE,
n.numIndivs as numNMFS,
n.AREA_SWEPT_VARIABLE as aswNMFS,
n.SAMPLING_FACTOR as sfNMFS,
n.expFACTOR as expfNMFS,
b.numIndivs as numBSFRF,
b.AREA_SWEPT_VARIABLE as aswBSFRF,
b.SAMPLING_FACTOR as sfBSFRF,
b.expFACTOR as expfBSFRF,
n.numIndivs+b.numIndivs as numTot,
n.numIndivs/(n.numIndivs+b.numIndivs) as propNMFS,
n.AREA_SWEPT_VARIABLE/b.AREA_SWEPT_VARIABLE as ratioAS
from dfrRHI_NMFS as n, dfrRHI_BSFRF as b
where
n.HAULJOIN=b.HAULJOIN and
n.SEX=b.SEX and
n.SIZE=b.SIZE;";
dfrProps<-sqldf::sqldf(qry) |>
dplyr::filter(!is.na(propNMFS)) |>
dplyr::mutate(q=expfBSFRF/expfNMFS,  #--correct sense of ratio for selfisher: logit(propNMFS) = log[r(z)]+log(q)
obsLnR=log(propNMFS/(1-propNMFS))-log(q),
obsR=exp(obsLnR),
YEAR=as.character(iY));
lstPropsAllYears[[as.character(iY)]] = dfrProps;
}#--iY
dfrPropsAllYears = dplyr::bind_rows(lstPropsAllYears) |>
dplyr::mutate(HAULJOIN=paste0(YEAR,"-",HAULJOIN),
YEAR=as.character(YEAR));
View(dfrPropsAllYears)
load("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04_HaulLevelCatchability/rda_Step1b_dfrPropsAllSBSYears.RData")
dfrCmp = dplyr::bind_rows(dfrPropsAllYears |> dplyr::mutate(case="new"),
obj |> dplyr::mutate(case="old")) |>
dplyr::select(case,y=YEAR,h=HAULJOIN,x=SEX,z=SIZE,nN=numNMFS,sfN=sfNMFS,nB=numBSFRF,sfB=sfBSFRF);
dfrCmpW = dfrCmp |> tidyr::pivot_wider(names_from="case",values_from=c("nN","sfN","nB","sfB");
dfrCmpW = dfrCmp |> tidyr::pivot_wider(names_from="case",values_from=c("nN","sfN","nB","sfB"));
View(dfrCmpW)
dfrCmpWnN = dfrCmpW |> dplyr::filter(nN_new!=nN_old);
View(dfrCmpWnN)
dfrCmpWsfN = dfrCmpW |> dplyr::filter(sfN_new!=sfN_old);
dfrCmpWnB  = dfrCmpW |> dplyr::filter(nB_new !=nB_old);
dfrCmpWsfB = dfrCmpW |> dplyr::filter(sfB_new!=sfB_old);
View(dfrCmpWnB)
##--save dfrPropsAllYears----
wtsUtilities::saveObj(dfrPropsAllYears,file.path(dirThs,"rda_Step1b_dfrPropsAllSBSYears.RData"));
#--clean up a bit
rm(lstPropsAllYears,dfrProps,qry,
dfrRHI_BSFRF,dfrRHI_NMFS,dfrREI_BSFRF,dfrREI_NMFS,dfrRCI_BSFRF,dfrRCI_NMFS,
dfrRSD_SBS,dfrRHD_BSFRF_SBS,dfrRID_BSFRF_SBS,dfrRHD_NMFS_SBS,dfrRID_NMFS_SBS,
dfrYSD_SBS,dfrYHD_BSFRF_SBS,dfrYID_BSFRF_SBS,dfrYHD_NMFS_SBS,dfrYID_NMFS_SBS);
#--calculate haul-level mean annual NMFS proportion of SBS catch----
#----and survey-level mean annual proportion based on CPUE (swept area-scaled values)
qry<-"select
SEX,YEAR,SIZE,
sum(numTot) as numTot,
avg(propNMFS) as mnPropNMFS,
avg(numNMFS*expfNMFS) as mnCPUE_NMFS,
avg(numBSFRF*expfBSFRF) as mnCPUE_BSFRF
from dfrPropsAllYears
group by SEX,YEAR,SIZE;";
dfrMnPropsAllYears<-sqldf::sqldf(qry) |>
dplyr::mutate(mnLnR       = log(mnPropNMFS/(1-mnPropNMFS)),
mnCPUE_Prop = mnCPUE_NMFS/(mnCPUE_NMFS+mnCPUE_BSFRF),
mnCPUE_lnR  = log(mnCPUE_Prop/(1-mnCPUE_Prop)),
);
##--save dfrMnPropsAllYears----
wtsUtilities::saveObj(dfrMnPropsAllYears,file.path(dirThs,"rda_Step1c_dfrMnPropsAllSBSYears.RData"));
dfrNewMnPropsAllYear = wtsUtilities::getObj(file.path(dirThs,"rda_Step1c_dfrMnPropsAllSBSYears.RData"));
dfrOldMnPropsAllYear = wtsUtilities::getObj(file.path(dirThs,"rda_Step1c_dfrMnPropsAllSBSYears.20260111.RData"));
View(dfrNewMnPropsAllYear)
names(dfrNewMnPropsAllYear)
dfrCmpW = dplyr::bind_rows(dfrNewMnPropsAllYears |> dplyr::mutate(case="new"),
dfrOldMnPropsAllYears |> dplyr::mutate(case="old")) |>
dplyr::select(case,y=YEAR,x=SEX,z=SIZE,numTot,mnPropNMFS,mnCPUE_NMFS,mnCPUE_BSFRF,mnLnR,mnCPUE_Prop,mnCPUE_lnR) |>
tidyr::pivot_wider(names_from="case",values_from=c("numTot","mnPropNMFS","mnCPUE_NMFS","mnCPUE_BSFRF","mnLnR","mnCPUE_Prop","mnCPUE_lnR"));
dfrNewMnPropsAllYears = wtsUtilities::getObj(file.path(dirThs,"rda_Step1c_dfrMnPropsAllSBSYears.RData"));
dfrOldMnPropsAllYears = wtsUtilities::getObj(file.path(dirThs,"rda_Step1c_dfrMnPropsAllSBSYears.20260111.RData"));
dfrCmpW = dplyr::bind_rows(dfrNewMnPropsAllYears |> dplyr::mutate(case="new"),
dfrOldMnPropsAllYears |> dplyr::mutate(case="old")) |>
dplyr::select(case,y=YEAR,x=SEX,z=SIZE,numTot,mnPropNMFS,mnCPUE_NMFS,mnCPUE_BSFRF,mnLnR,mnCPUE_Prop,mnCPUE_lnR) |>
tidyr::pivot_wider(names_from="case",values_from=c("numTot","mnPropNMFS","mnCPUE_NMFS","mnCPUE_BSFRF","mnLnR","mnCPUE_Prop","mnCPUE_lnR"));
dfrCmpWnumTot  = dfrCmpW |> dplyr::filter(numTot_new !=numTot_old);  #-- rows
View(dfrCmpWnumTot)
dfrCmpWmLnR    = dfrCmpW |> dplyr::filter(mnLnR_new !=mnLnR_old);  #-- 153 rows
dfrCmpWmnPropNMFS  = dfrCmpW |> dplyr::filter(mnPropNMFS_new !=mnPropNMFS_old);  #-- 153 rows
dfrCmpWmnCPUE_lnR = dfrCmpW |> dplyr::filter(mnCPUE_lnR_new  !=mnCPUE_lnR_old);    #-- 116 rows
dfrCmpWmnCPUE_Prop = dfrCmpW |> dplyr::filter(mnCPUE_Prop_new  !=mnCPUE_Prop_old);    #-- 264 rows
require(ggplot2);
ggplot(dfrCmpWmLnR,aes(x=z,y=mnLnR,colour=as.factor(y))) + geom_point();
ggplot(dfrCmpWmLnR,aes(x=z,shape=as.factor(y))) + geom_point(aes(y=mnLnR_new),colour="green") + geom_point(aes(y=mnLnR_old),colour="blue");
ggplot(dfrCmpWmnCPUE_lnR,aes(x=z,shape=as.factor(y))) + geom_point(aes(y=mnCPUE_LnR_new),colour="green") + geom_point(aes(y=mnCPUE_LnR_old),colour="blue");
View(dfrCmpWmnCPUE_lnR)
ggplot(dfrCmpWmnCPUE_lnR,aes(x=z,shape=as.factor(y))) + geom_point(aes(y=mnCPUE_lnR_new),colour="green") + geom_point(aes(y=mnCPUE_lnR_old),colour="blue");
ggplot(dfrCmpWmnCPUE_Prop,aes(x=z,shape=as.factor(y))) + geom_point(aes(y=mnCPUE_Prop_new),colour="green") + geom_point(aes(y=mnCPUE_Prop_old),colour="blue");
#--subset haul-level data----
require(ggplot2);
#--read project setup info----
dirPrj = rstudioapi::getActiveProject();
dirThs = file.path(dirPrj,"Analysis/04_HaulLevelCatchability")
fn = file.path(dirPrj,"rda_ProjectSetup.RData");
s  = wtsUtilities::getObj(fn);
#--get proportions dataframe
dfrPropsAllYears   = wtsUtilities::getObj(file.path(dirThs,"rda_Step1b_dfrPropsAllSBSYears.RData"));
#--the logit-scale observed proportions "o" are related to the
#--NMFS-to-BSFRF selectivity ratio "r" (S_nmfs/S_bsfrf) by
#     logit(o) = ln(r) + ln(q)
# where q = expF_b/expF_a is the ratio of expansion factors used to convert
# numbers sampled to CPUE: i.e., CPUE = N_s * expF, where expF = 1/(As * Sf),
# and As = area swept and Sf is the sampling fraction (note that
# the SAMPLING_FACTOR in the haul data tables is 1/(sampling fraction),
# so expF = SAMPLING_FACTOR/AREA_SWEPT).
#--extract proportions data with environmental covariates
dfrDat = dfrPropsAllYears |>
dplyr::transmute(y=YEAR,h=HAULJOIN,d=BOTTOM_DEPTH,t=GEAR_TEMPERATURE,f=phi,s=sorting,
z=SIZE,x=SEX,p=propNMFS,n=numTot,asr=ratioAS,q=q,lnq=log(q),lgtp=log(p/(1-p)),lnR=lgtp-lnq);
##--function to check for outliers based on area swept ratios----
#'
#' @title Edit data for outlier areas swept ratios (NMFS/BSFRF ratios)
#'
#' @description Function to edit data for outlier areas swept ratios.
#'
#' @param dfrDat - tibble with proprtion data to edit
#' @param qs - 3-element vector with min ASR, nominal ASR, max ASR
#'
#' @return list
#'
#' @export
#'
check_ASRs<-function(dfrDat,ASRs,maxASR=20){
#--
dfrDatp = dfrDat |> dplyr::distinct(y,h,asr) |>
dplyr::mutate(asr=ifelse(asr>maxASR,maxASR,asr));
#--create dataframe for q's defining range
gghst = ggplot2::stat_bin(data=dfrDatp,mapping=ggplot2::aes(x=asr,fill=y),binwidth=1);
dfrASRs = tibble::tibble(asr=c(ASRs[1]-0.5,ASRs[2],ASRs[3]+0.5),
y=1000+0*ASRs[1:3],
lbl=as.factor(c("min","nominal","max")));
qts = quantile(dfrDatp$asr,probs=c(0.98),na.rm=TRUE);
#--plot histogram of ASR's
p1 = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDatp,mapping=ggplot2::aes(x=asr,fill=y),binwidth=1) +
ggplot2::geom_vline(data=dfrASRs,mapping=ggplot2::aes(xintercept=asr),linetype=2) +
# ggplot2::geom_text(data=dfrQs,mapping=ggplot2::aes(x=q,y=y,label=lbl)) +
ggplot2::scale_colour_viridis_d(option="plasma") +
ggplot2::xlim(c(0,maxASR)) +
ggplot2::labs(x="area swept ratio (A_NMSF/A_BSFRF)",y="count",fill="year");
# print(p1);
#--plot original data on logit scale
nrw_orig = nrow(dfrDat);
dfrDatp = dplyr::bind_rows(
dfrDat |> dplyr::filter(dplyr::between(asr,ASRs[1],ASRs[3])) |>
dplyr::mutate(cat=paste0("in [",ASRs[1],",",ASRs[3],"]")),
dfrDat |> dplyr::filter(asr<ASRs[1]) |>
dplyr::mutate(cat=paste0("<",ASRs[1])),
dfrDat |> dplyr::filter(asr>ASRs[3]) |>
dplyr::mutate(cat=paste0(">",ASRs[3])));
dfrDatp$cat = factor(dfrDatp$cat,levels=c(paste0("<",ASRs[1]),
paste0("in [",ASRs[1],",",ASRs[3],"]"),
paste0(">",ASRs[3])));
p2 = ggplot2::ggplot(data=dfrDatp,mapping=ggplot2::aes(x=z,y=lnR,fill=cat,size=n))+
ggplot2::geom_point(position=ggplot2::position_jitter(width=1),alpha=0.8,shape=21) +
ggplot2::scale_colour_viridis_d(option="plasma") +
ggplot2::facet_grid(x~.,scales="free_y")+
ggplot2::labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)",fill="q");
# print(p2);
#--edit data based on ASR limits
dfrDatp  = dfrDat |> dplyr::filter(dplyr::between(asr,ASRs[1],ASRs[3]));
dfrDrop  = dfrDat |> dplyr::anti_join(dfrDatp,by=NULL) |> dplyr::select(h) |> dplyr::distinct();
nrw_edit = nrow(dfrDatp);
nrw_drop = nrow(dfrDrop);
p3 = ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDatp,
mapping=ggplot2::aes(x=z,y=lgtp,colour=y),
position=ggplot2::position_jitter(width=1)) +
ggplot2::geom_point(data=dfrDat |> dplyr::anti_join(dfrDatp,by=NULL),
mapping=ggplot2::aes(x=z,y=lnR),colour="black") +
ggplot2::facet_grid(x~.,scales="free_y")+
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
# print(p3);
return(list(dfrDat=dfrDatp,dfrDrop=dfrDrop,ps=list(p1=p1,p2=p2,p3=p3),
nrw_orig=nrw_orig,nrw_edit=nrw_edit,nrw_drop=nrw_drop));
}
##--function to select data based on number of individuals caught----
#'
#' @title Select data based on minimium number of individuals caught
#'
#' @description Function to select data based on minimium number of individuals caught.
#'
#' @param dfrDat - tibble with proportion data to edit
#' @param n_min - minimum number of individuals required to keep
#'
#' @return list
#'
#' @export
#'
selectSizeData<-function(dfrDat,n_min){
#--subset the data based on minimum number of individuals caught
dfrDatpp = dfrDat |> dplyr::filter(n>=n_min);
#--plot the data that have been subsetted
p1 = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=z,y=lnR,colour=y,size=n))+
ggplot2::geom_point(position=ggplot2::position_jitter(width=1)) +
ggplot2::geom_point(data=dfrDat |> dplyr::anti_join(dfrDatpp,by=NULL),mapping=ggplot2::aes(x=z,y=lnR,size=n),
position=position_jitter(width=1),colour="black") +
ggplot2::facet_grid(x~.,scales="free_y")+
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
# print(p1);
#--plot data that will be fit
p2 = ggplot2::ggplot(data=dfrDatpp,mapping=ggplot2::aes(x=z,y=lnR,colour=y,size=n))+
ggplot2::geom_point(position=ggplot2::position_jitter(width=1)) +
ggplot2::facet_grid(x~.,scales="free_y")+
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
# print(p2);
return(list(dfrDat=dfrDatpp,ps=list(p1=p1,p2=p2)));
}
#--check for outliers in area swept ratios----
#----(should be ~6 with 5 min. BSFRF tow, 30 min. NMFS tow)
ASRs = c(3,6,12);
lst1 = check_ASRs(dfrDat,ASRs);
lst1$ASRs = ASRs;
#----drop cells with < n_min individuals
n_min = 5;
lst2 = selectSizeData(lst1$dfrDat,n_min=n_min);
lst2$n_min = n_min;
ASRs$ps
lst1$ps
lst2$ps
selectSizeData<-function(dfrDat,n_min,facet_scales="free_y"){
#--subset the data based on minimum number of individuals caught
dfrDatpp = dfrDat |> dplyr::filter(n>=n_min);
#--plot the data that have been subsetted
p1 = ggplot2::ggplot(data=dfrDat,mapping=ggplot2::aes(x=z,y=lnR,colour=y,size=n))+
ggplot2::geom_point(position=ggplot2::position_jitter(width=1)) +
ggplot2::geom_point(data=dfrDat |> dplyr::anti_join(dfrDatpp,by=NULL),mapping=ggplot2::aes(x=z,y=lnR,size=n),
position=position_jitter(width=1),colour="black") +
ggplot2::facet_grid(x~.,scales=facet_scales)+
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
# print(p1);
#--plot data that will be fit
p2 = ggplot2::ggplot(data=dfrDatpp,mapping=ggplot2::aes(x=z,y=lnR,colour=y,size=n))+
ggplot2::geom_point(position=ggplot2::position_jitter(width=1)) +
ggplot2::facet_grid(x~.,scales=facet_scales)+
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
# print(p2);
return(list(dfrDat=dfrDatpp,ps=list(p1=p1,p2=p2)));
}
lst2 = selectSizeData(lst1$dfrDat,n_min=n_min,facet_scales="fixed");
lst2$ps
#--save results----
lst3 = list(dfrInput=dfrDat,
lstTrimmedASRs=lst1,
lstTrimmedFinal=lst2
);
wtsUtilities::saveObj(lst3,file.path(dirThs,"rda_Step2_TrimmedDataList.RData"));
#--get indiv data with sediment characteristics for all 83-112 NMFS hauls----
dirThs = dirname(rstudioapi::getActiveDocumentContext()$path);
#--get NMFS individual data----
require(tcsamSurveyData);
dirData_NMFS    = "~/Work/StockAssessments-Crab/Data/Survey.NMFS.EBS/Current";
fnStrata        = file.path(dirData_NMFS,"TannerCrab_SurveyStrata.csv");
fnHaulData_NMFS = file.path(dirData_NMFS,"TannerCrab_HaulData.csv");
verbosity       = 0;
minYr = 1982;
maxYr = 2024;
##--read NMFS strata definitions and create NMFS strata table for SBS years----
dfrStrata<-readr::read_csv(fnStrata) |>
dplyr::select(STATION_ID,DISTRICT,TOWS,SURVEY_YEAR,
LATITUDE,LONGITUDE,STRATUM,TOTAL_AREA_SQ_NM) |>
dplyr::filter(dplyr::between(SURVEY_YEAR,minYr,maxYr));
dfrSD<-selectStrata.TrawlSurvey(dfrStrata,
species="BTC",
strataType="2015",
export=FALSE,
verbosity=verbosity);
rm(dfrStrata);
##--NMFS haul data----
##----read in NMFS haul data
dfrHaulData_NMFS<-readr::read_csv(file=fnHaulData_NMFS,
guess_max=Inf,
skip=5) |>
dplyr::filter(dplyr::between(AKFIN_SURVEY_YEAR,minYr,maxYr));
##------extract NMFS haul-specific data tbl
dfrHD_NMFS<-selectHauls.TrawlSurvey(dfrSD,
tbl=dfrHaulData_NMFS,
YearRange=c(minYr,maxYr),
export=FALSE,
verbosity=verbosity);
##--select NMFS individual data at haul stations
sex   = "ALL";
mat   =  "ALL";
s_c   =  "ALL";
minZ  =  25;
maxZ  =  Inf;
calcMaleMat = FALSE;
dfrID_NMFS<-selectIndivs.TrawlSurvey(dfrHD_NMFS,
tbl=dfrHaulData_NMFS,
sex=sex,
maturity=mat,
shell_condition=s_c,
calcMaleMaturity=calcMaleMat,
minSize=minZ,
maxSize=maxZ,
export=FALSE,
verbosity=verbosity) |>
dplyr::filter(SEX %in% c("MALE","FEMALE"));
#--calculate CPUE by size bin by haul
dfrCPUE = calcCPUE.ByHaul(dfrHD_NMFS,
dfrID_NMFS,
bySex=TRUE,
byMaturity=FALSE,
byShellCondition=FALSE,
bySize=TRUE,
cutpts=seq(25,185,5)) |>
dplyr::mutate(SIZE=SIZE+2.5);#--shift to bin center
View(dfrCPUE)
View(dfrCPUE |> dplyr::filter(SAMPLING_FACTOR!=1))
View(dfrCPUE |> dplyr::filter(SAMPLING_FACTOR!=1,numIndivs>0))
View(dfrCPUE |> dplyr::filter(SAMPLING_FACTOR!=1))
setwd("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04_HaulLevelCatchability/CrossVal_Males")
dfrFld = wtsUtilities::getObj("fold_1.RData") |>
dplyr::select(!c(lstMdl,lstTrn,lstTst));
View(dfrFld)
