fit$obj$report(fit$obj$env$last.par.best)
summary(fitM$rep)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
botM = boot(dM);
View(botM)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
plot.gearcalibFit(fitM,boot=botM,Lvec=zM)
names(botM)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
plot.gearcalibFit(fitM,boot=botM,Lvec=zM)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
plot.gearcalibFit(fitM,boot=botM,Lvec=zM)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
botM = boot(dM);
plot.gearcalibFit(fitM,boot=botM,Lvec=zM)
quantiles = c(0.025,0.16,0.5)
apply(botM$BootEstimate,2,quantile,probs=q)
q=0.025
apply(botM$BootEstimate,2,quantile,probs=q)
apply(botM$BootEstimate,2,quantile,probs=1-q)
View(dM)
c("N","SweptArea","group","Gear")  %in%  names(d)
any(!c("N","SweptArea","group","Gear")  %in%  names(d))
all(c("N","SweptArea","group","Gear")  %in%  names(d))
dM = list();
dM$L         = zM;
dM$N         = as.matrix(dfrM.N[,3:ncol(dfrM.N)]);
dM$SweptArea = as.matrix(dfrM.A[,3:ncol(dfrM.A)]);
dM$group     = factor(dfrM.N$group);
dM$Gear      = dfrM.N$gear;
dF = list();
dF$L         = zF;
dF$N         = as.matrix(dfrF.N[,3:ncol(dfrF.N)]);
dF$SweptArea = as.matrix(dfrF.A[,3:ncol(dfrF.A)]);
dF$group     = factor(dfrF.N$group);
dF$Gear      = dfrF.N$gear;
check.gearcalib.data(dM)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
check.gearcalib.data<-function(d){
stopifnot(class(d)=="list")
stopifnot(all(c("N","SweptArea","group","Gear")  %in%  names(d)))
stopifnot(class(d$N)[1]=="matrix")
#stopifnot(class(d$SweptArea)=="numeric")
stopifnot(class(d$SweptArea)[1]=="matrix")
stopifnot(class(d$group)=="factor")
stopifnot(class(d$Gear)=="factor")
no.hauls <- nrow(d$N)
stopifnot(dim(d$N)==dim(d$SweptArea))
stopifnot(nlevels(d$group)==no.hauls/2)
stopifnot(nlevels(d$Gear)==2)
stopifnot(all(is.finite(d$SweptArea)))
}
check.gearcalib.data(dM)
check.gearcalib.data(dF)
d=dM
d$L
boot <- function(d,quantiles = c(0.025,0.16,0.5),Nboot=1000)
{
GearNames <- levels(d$Gear)
## Raw data: Total catches
I1 <- d$Gear==GearNames[1]
I2 <- d$Gear==GearNames[2]
totcatch1 <- apply(d$N[I1,],2,sum)
totcatch2 <- apply(d$N[I2,],2,sum)
# Density1 <- totcatch1 / sum(d$SweptArea[I1])
# Density2 <- totcatch2 / sum(d$SweptArea[I2])
Density1 <- totcatch1 / apply(d$SweptArea[I1,],2,sum)
Density2 <- totcatch2 / apply(d$SweptArea[I2,],2,sum)
tiny <- 1e-6
RawEstimate <- (Density2 + tiny) / (Density1 + tiny)
BootEstimate <- array(NA,c(Nboot,length(RawEstimate)))
for(i in 1:Nboot)
{
## Select random groups with replacement
GroupBoot <- sample(1:length(levels(d$group)),length(levels(d$group)),replace=TRUE)
Haul1 <- as.numeric(sapply(GroupBoot,function(g) which( (as.numeric(d$group) == g) & I1)))
Haul2 <- as.numeric(sapply(GroupBoot,function(g) which( (as.numeric(d$group) == g) & I2)))
Nb1 <- d$N[Haul1,]
Nb2 <- d$N[Haul2,]
# Db1 <- apply(Nb1,2,sum) / sum(d$SweptArea[Haul1])
# Db2 <- apply(Nb2,2,sum) / sum(d$SweptArea[Haul2])
Db1 <- apply(Nb1,2,sum) / apply(d$SweptArea[Haul1,],2,sum)
Db2 <- apply(Nb2,2,sum) / apply(d$SweptArea[Haul2,],2,sum)
BootEstimate[i,] <- (Db2 + tiny) / (Db1 + tiny)
}
lst = list(); i=0;
for (q in seq_along(quantitles)){
lwr = apply(botM$BootEstimate,2,quantile,probs=q);
upr = apply(botM$BootEstimate,2,quantile,probs=1-q);
lst[[i<-i+1]] = tibble::tibble(ci=1-2*q,L=d$L,lwr=lwr,upr=upr);
}
BootQuantiles <- dplyr::bind_rows(lst);
return(list(RawEstimate=RawEstimate,
BootEstimate=BootEstimate,
quantiles=quantiles,
BootQuantiles=BootQuantiles,
Density1=Density1,
Density2=Density2))
}
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
botM = boot(dM);
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
botM = boot(dM);
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
botM = boot(dM);
fit=fitM
boot=bootM
boot=botM
est = fit$est; sd = fit$sd;
dfr = tibble::tibble(x=Lvec,
y=exp(est),
ymin=exp(est-2*sd),
ymax=exp(est+2*sd));
Lvec=dM$L
p1 = ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax)) +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
est = fit$est; sd = fit$sd;
dfr = tibble::tibble(x=Lvec,
y=exp(est),
ymin=exp(est-2*sd),
ymax=exp(est+2*sd));
if (!is.null(boot)) dfr$RawEstimate = boot$RawEstimate;
p1 = ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax)) +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
p1
View(boot)
p1 = p1 +
geom_point(aes(y=RawEstimate),shape=21);
p1
names(p1)
p1@coordinates$limits$y
ylim
max(dfr$ymax);
max(dfr$ymax,dfr$RawEstimate,boot$BootQuantiles$upr)
if (ymx1>3*ymx0) ymx1 = 3*ymx0;
ymx0 = max(dfr$ymax);
ymx1 = max(dfr$ymax,dfr$RawEstimate,boot$BootQuantiles$upr);
if (ymx1>3*ymx0) ymx1 = 3*ymx0;
p1 +
geom_point(aes(y=RawEstimate),shape=21) +
scale_y_continuous(limits=c(0,ymx1),oob=scales::oob_squish_any);
ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax)) +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
geom_hline(yintercept=c(0,1),linetype=c(0.3),alpha=c(1,0.5)) +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax)) +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
geom_hline(yintercept=c(0,1),linetype=c(0,3),alpha=c(1,0.5)) +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax)) +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
geom_hline(yintercept=c(0,1),linetype=c(1,3),alpha=c(1,0.5)) +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
p1 +
geom_point(aes(y=RawEstimate),shape=21) +
geom_line(aes(x=L,y=val),data=boot$medBoot,linetype=2) +
scale_y_continuous(limits=c(0,ymx1),oob=scales::oob_squish_any);
ymx0 = max(1,dfr$ymax);
ymx1 = max(1,dfr$ymax,dfr$RawEstimate,boot$BootQuantiles$upr);
if (ymx1>3*ymx0) ymx1 = 3*ymx0;
p1 +
geom_point(aes(y=RawEstimate),shape=21) +
geom_line(aes(x=L,y=val),data=boot$medBoot,linetype=2) +
scale_y_continuous(limits=c(0,ymx1),oob=scales::oob_squish_any);
p1 +
geom_point(aes(y=RawEstimate),shape=21) +
geom_line(aes(x=L,y=val),data=boot$medBoot,linetype=2,inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,ymx1),oob=scales::oob_squish_any);
cis = sort(unique(boot$BootQuantiles$ci),decreasing=TRUE);
p1 = ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax));
if (is.null(boot)){
cis = sort(unique(boot$BootQuantiles$ci),decreasing=TRUE);
for (ci_ in cis) {
p1 = p1 + geom_ribbon(mapping=aes(x=L,ymin=lwr,ymax=upr),
data=boot$BootQuantiles |> dplyr::filter(ci==ci_),
alpha=0.2,fill="green",colour=NA,inherit.aes=FALSE);
}
}
p1 = p1 +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
geom_hline(yintercept=c(0,1),linetype=c(1,3),alpha=c(1,0.5)) +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
if (!is.null(boot)){
ymx0 = max(1,dfr$ymax);
ymx1 = max(1,dfr$ymax,dfr$RawEstimate,boot$BootQuantiles$upr);
if (ymx1>3*ymx0) ymx1 = 3*ymx0;
p1 = p1 +
geom_point(aes(y=RawEstimate),shape=21) +
geom_line(aes(x=L,y=val),data=boot$medBoot,linetype=2,colour="green",inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,ymx1),oob=scales::oob_squish_any);
}
print(p1)
p1 = ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax));
if (is.null(boot)){
cis = sort(unique(boot$BootQuantiles$ci),decreasing=TRUE);
for (ci_ in cis) {
p1 = p1 + geom_ribbon(mapping=aes(x=L,ymin=lwr,ymax=upr),
data=boot$BootQuantiles |> dplyr::filter(ci==ci_),
alpha=0.2,fill="green",colour=NA,inherit.aes=FALSE);
}
}
p1
p1 = ggplot(dfr,aes(x=x,y=y,ymin=ymin,ymax=ymax));
if (!is.null(boot)){
cis = sort(unique(boot$BootQuantiles$ci),decreasing=TRUE);
for (ci_ in cis) {
p1 = p1 + geom_ribbon(mapping=aes(x=L,ymin=lwr,ymax=upr),
data=boot$BootQuantiles |> dplyr::filter(ci==ci_),
alpha=0.2,fill="green",colour=NA,inherit.aes=FALSE);
}
}
p1 = p1 +
geom_ribbon(colour=NA,alpha=0.2) +
geom_line() +
geom_hline(yintercept=c(0,1),linetype=c(1,3),alpha=c(1,0.5)) +
labs(x="size (mm CW)",y="relative selectivity") +
wtsPlots::getStdTheme();
if (!is.null(boot)){
ymx0 = max(1,dfr$ymax);
ymx1 = max(1,dfr$ymax,dfr$RawEstimate,boot$BootQuantiles$upr);
if (ymx1>3*ymx0) ymx1 = 3*ymx0;
p1 = p1 +
geom_point(aes(y=RawEstimate),shape=21) +
geom_line(aes(x=L,y=val),data=boot$medBoot,linetype=2,colour="green",inherit.aes=FALSE) +
scale_y_continuous(limits=c(0,ymx1),oob=scales::oob_squish_any);
}
print(p1)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM)
botF = boot(dF);
pltF = plot.gearcalibFit(fitF,boot=botF,Lvec=zF)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltF = plot.gearcalibFit(fitF,boot=botF,Lvec=zF,ymax=1)
levels(fit$d$Gear)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltF = plot.gearcalibFit(fitF,boot=botF,Lvec=zF,ymax=1)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltF = plot.gearcalibFit(fitF,boot=botF,Lvec=zF,ymax=1)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
#--use Thygesen et al approach to estimate relative selectivity ratio
##--using log-Gaussian Cox processes
require(TMB);
require(ggplot2);
dirPrj = rstudioapi::getActiveProject();
dirThs = file.path(dirPrj,"Analysis/04a_ThygesenIntercalibration");
dirCPP = file.path(dirThs,"Intercalibration/gearcalib/src");
#--compile dynamic library
setwd(dirCPP);
compile("gearcalib.cpp",CXX="clang++")
if(is.loaded("EvalDoubleFunObject")) dyn.unload("gearcalib.so") #<-may error out
dyn.load("gearcalib.so")
setwd(dirThs);
#--get data
##--dfrCPUE: fleet, y, gis_station, sampling_factor, area_swept_variable, x, m, s, z, n, val, type
dfrCPUE = wtsUtilities::getObj(file.path(dirPrj,"Analysis/01_SBS_Data/rda_Step3_SBS_CrabAbundance.RData"))$dfrCPUE;
dfrCPUE = dfrCPUE |> dplyr::mutate(gear=factor(fleet,levels=c("BSFRF","NMFS")),
group=paste0(y,"_",gis_station),
ASp=area_swept_variable/sampling_factor);
dfrGr = dfrCPUE |> dplyr::select(group,x,n,ASp) |>
dplyr::group_by(group,x) |>
dplyr::summarize(totN=sum(n,na.rm=FALSE),
totA=sum(ASp,na.rm=FALSE)) |>
dplyr::ungroup() |>
dplyr::arrange(group,x) |>
dplyr::filter(totN>0,is.finite(totA)) |> dplyr::select(group,x);
dfrM.N = dfrGr |> dplyr::filter(x=="male") |>
dplyr::inner_join(dfrCPUE |> dplyr::filter(dplyr::between(z,24,179)),by=c("group","x")) |>
dplyr::select(group,gear,z,n) |>
tidyr::pivot_wider(names_from=z,values_from=n) |> dplyr::arrange(group,gear);
dfrM.A = dfrGr |> dplyr::filter(x=="male") |>
dplyr::inner_join(dfrCPUE |> dplyr::filter(dplyr::between(z,24,179)),by=c("group","x")) |>
dplyr::select(group,gear,z,ASp) |>
tidyr::pivot_wider(names_from=z,values_from=ASp) |> dplyr::arrange(group,gear);
dfrF.N = dfrGr |> dplyr::filter(x=="female") |>
dplyr::inner_join(dfrCPUE |> dplyr::filter(dplyr::between(z,24,119)),by=c("group","x")) |>
dplyr::select(group,gear,z,n) |>
tidyr::pivot_wider(names_from=z,values_from=n) |> dplyr::arrange(group,gear);
dfrF.A = dfrGr |> dplyr::filter(x=="female") |>
dplyr::inner_join(dfrCPUE |> dplyr::filter(dplyr::between(z,24,119)),by=c("group","x")) |>
dplyr::select(group,gear,z,ASp) |>
tidyr::pivot_wider(names_from=z,values_from=ASp) |> dplyr::arrange(group,gear);
#--source the R code
source(file.path(dirThs,"Intercalibration/gearcalib/R/gearcalib.R"));
#--convert to NEW gearcalib "d" format:
##--d$N: matrix with N in haul x size
##--d$SweptArea: matrix with area_swept/sampling_factor in haul x size
##--d$group: factor encoding hauls (size = nHauls)
##--d$Gear:  factor encoding gear  (size = nHauls)
###--males
zM = as.double(colnames(dfrM.N)[3:ncol(dfrM.N)]) + 3;
dM = list();
dM$L         = zM;
dM$N         = as.matrix(dfrM.N[,3:ncol(dfrM.N)]);
dM$SweptArea = as.matrix(dfrM.A[,3:ncol(dfrM.A)]);
dM$group     = factor(dfrM.N$group);
dM$Gear      = dfrM.N$gear;
###--females
zF = as.double(colnames(dfrF.N)[3:ncol(dfrF.N)]) + 3;
dF = list();
dF$L         = zF;
dF$N         = as.matrix(dfrF.N[,3:ncol(dfrF.N)]);
dF$SweptArea = as.matrix(dfrF.A[,3:ncol(dfrF.A)]);
dF$group     = factor(dfrF.N$group);
dF$Gear      = dfrF.N$gear;
#--fit the model for males
fitM = gearcalibFit(dM,fit0=TRUE);
botM = boot(dM);
fitF = gearcalibFit(dF,fit0=TRUE);
botF = boot(dF);
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM,ymax=NULL)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM,ymax=NULL)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM,ymax=NULL)
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM,ymax=NULL,select="spectrum")
fit=fitM
pl <- fit$obj$env$parList();
spec <- pl$logspectrum;
### Take the station with the largest catch
sumspec = apply(spec,1,sum);
head(sumspec)
order(sumspec,decreasing=TRUE);
ii <- order(sumspec,decreasing=TRUE)[1:8];
iii <- which(fit$d$group %in% levels(fit$d$group)[ii]);
res1 <- pl$residual[iii,];
iii
fit$d$group %in% levels(fit$d$group)[ii]
fit$d$group[fit$d$group %in% levels(fit$d$group)[ii]]
levels(fit$d$group)[ii]
fit$d$group[ii]
names(fit$d)
fit$d$gear[ii];
View(fit$d)
fit$d$Gear[ii];
length(fit$d$Gear);
length(fit$d$group);
dim(fit$d$N);
tibble::tibble(group=fit$d$group,Gear=fit$d$Group)
tibble::tibble(group=fit$d$group,Gear=fit$d$Gear)
tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |>
dplyr::mutate(idx=dplyr::row_number())
tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |>
dplyr::mutate(idx=dplyr::row_number()) |>
tidyr::pivot_wider(names_from=Gear,values_from=idx)
nStn=8
pl <- fit$obj$env$parList(); #--parlist
spec <- pl$logspectrum;      #--extract estimated gear-neutral spectra
###--create table mapping indices in fit$d quantities to
####--row indices of associated gear-neutral spectra
dfrGG = tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |>
dplyr::mutate(idx=dplyr::row_number()) |>
tidyr::pivot_wider(names_from=Gear,values_from=idx);
### Find the stations with the nStn largest size spectra
sumspec = apply(spec,1,sum);
ii <- order(sumspec,decreasing=TRUE)[1:nStn];#--row indices of top nStn spectra
dfrGGp = dfrGG[ii,];                         #--indices for associated group/gear combinations
View(dfrGGp)
ii
sumspec[ii]
View(pl)
tibble::tibble(residual=pl$residual)
tibble::as_tibble(pl$residual)
tibble::as_tibble(pl$residual,.name_repair="universal_quiet")
tibble::as_tibble(pl$residual,.name_repair=NULL)
dfrRes = dplyr::bind_cols(
tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |> dplyr::mutate(idx=dplyr::row_number()),
tibble::as_tibble(pl$residual,.name_repair=NULL));
names(dfrRes)[4:ncol(dfrRes)] = Lvec;
Lvec=zM
dfrRes = dplyr::bind_cols(
tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |> dplyr::mutate(idx=dplyr::row_number()),
tibble::as_tibble(pl$residual,.name_repair=NULL));
names(dfrRes)[4:ncol(dfrRes)] = Lvec;
View(dfrRes)
dfrRes |> tidyr::pivot_longer(cols=4:ncol(dfrRes),names_to="L",values_to="residual");
dfrRes |> tidyr::pivot_longer(cols=4:ncol(dfrRes),names_to="L",values_to="residual") |>
tidyr::pivot_wider(names_from="Gear",values_from="residual");
dfrRes |> tidyr::pivot_longer(cols=4:ncol(dfrRes),names_to="L",values_to="residual") |>
dplyr::select(!idx) |>
tidyr::pivot_wider(names_from="Gear",values_from="residual");
dfrGG = tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |>
dplyr::mutate(idx=dplyr::row_number()) |>
tidyr::pivot_wider(names_from=Gear,values_from=idx) |>
dplyr::mutate(idx=dplyr::row_number());
View(dfrGG)
dfrSpec = tibble::as_tibble(pl$logspectrum) |> dplyr::mutate(idx=dplyr::row_number());
names(dfrSpec)[1:length(Lvec)] = Lvec;
View(dfrSpec)
dfrSpec = tibble::as_tibble(pl$logspectrum);
names(dfrSpec) = Lvec;
dfrSpec = tibble::as_tibble(pl$logspectrum);
names(dfrSpec) = as.character(Lvec);
dfrSpec = dplyr::bind_cols(dfrGG,dfrSpec);
dfrSpec = tibble::as_tibble(pl$logspectrum);
names(dfrSpec) = as.character(Lvec);
dfrSpec = dplyr::bind_cols(dfrSpec,dfrGG) |>
tidyr::pivot_longer(cols=1:length(Lvec),names_to="L",values_to="val");
dfrSumSpec = dfrSpec |> dplyr::select(group,idx,L,val) |>
dplyr::group_by(group,idx) |>
dplyr::summarize(val=sum(val)) |>
dplyr::ungroup() |>
dplyr::arrange(dplyr::desc(val));
View(dfrSumSpec)
idxs = dfrSumSpec$idx[1:nStn];
dfrRes = dplyr::bind_cols(
tibble::tibble(group=fit$d$group,Gear=fit$d$Gear) |> dplyr::mutate(idx=dplyr::row_number()),
tibble::as_tibble(pl$residual,.name_repair=NULL));
names(dfrRes)[4:ncol(dfrRes)] = as.character(Lvec);
dfrRes = dfrRes |> tidyr::pivot_longer(cols=4:ncol(dfrRes),names_to="L",values_to="residual") |>
dplyr::select(!idx) |>
tidyr::pivot_wider(names_from="Gear",values_from="residual");
dfrRes = tibble::as_tibble(pl$residual,.name_repair=NULL);
names(dfrRes) = as.character(Lvec);
dfrGG |> tidyr::pivot_longer(tidy_select::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
tidyr::pivot_longer(tidyselect::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
levels(fit$d$Gear)
dfrGG |> tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
dplyr::bind_cols(
dfrRes,
dfrGG |> tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
)
dplyr::bind_cols(
dfrRes,
dfrGG |> tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
) |> tidyr::pivot_longer(cols=1:length(Lvec),names_to="L",values_to="residual")
nrow(dfrSpec)
dplyr::bind_cols(
dfrRes,
dfrGG |> tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
) |> tidyr::pivot_longer(cols=1:length(Lvec),names_to="L",values_to="residual") |>
|> dplyr::select(!res_idx) |> tidyr::pivot_wider(names_from="Gear",values_from="residual");
dplyr::bind_cols(
dfrRes,
dfrGG |> tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
) |> tidyr::pivot_longer(cols=1:length(Lvec),names_to="L",values_to="residual") |>
dplyr::select(!res_idx) |> tidyr::pivot_wider(names_from="Gear",values_from="residual");
dfrRes = tibble::as_tibble(pl$residual,.name_repair=NULL);
names(dfrRes) = as.character(Lvec);
dfrRes = dplyr::bind_cols(
dfrRes,
dfrGG |> tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="res_idx")
) |> tidyr::pivot_longer(cols=1:length(Lvec),names_to="L",values_to="residual") |>
dplyr::select(!res_idx) |> tidyr::pivot_wider(names_from="Gear",values_from="residual");
dfrSpec |> dplyr::select(group,idx,L,base=val) |>
dplyr::inner_join(dfrRes,by=c("group","idx","L"))
dfrSpec |> dplyr::select(group,idx,L,base=val) |>
dplyr::inner_join(dfrRes,by=c("group","idx","L")) |>
dplyr::mutate(exp_base=exp(base)) |>
tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="residual") |>
dplyr::mutate(exp_resid=exp(base+residual))
head(dfrSpec)
dfrT0 |> dplyr::select(group,L,base=exp_base) |> dplyr::distinct()
dfrT0 = dfrSpec |> dplyr::select(group,idx,L,base=val) |>
dplyr::inner_join(dfrRes,by=c("group","idx","L")) |>
dplyr::mutate(exp_base=exp(base)) |>
tidyr::pivot_longer(cols=tidyr::any_of(levels(fit$d$Gear)),names_to="Gear",values_to="residual") |>
dplyr::mutate(exp_resid=exp(base+residual));
dfrT0 |> dplyr::select(group,L,base=exp_base) |> dplyr::distinct()
head(dfrT0)
dfrT0 |> dplyr::select(group,L,value=exp_base) |> dplyr::distinct() |> dplyr::mutate(Gear="baseline")
dfrT0 |> dplyr::select(group,L,Gear,value=exp_resid)
dfrT1 = dplyr::bind_rows(
dfrT0 |> dplyr::select(group,L,value=exp_base) |> dplyr::distinct() |> dplyr::mutate(Gear="baseline"),
dfrT0 |> dplyr::select(group,L,Gear,value=exp_resid)
) |> dplyr::mutate(L=as.numeric(L));
View(dfrT1)
View(dfrSumSpec)
str(dfrT1)
grps = as.character(dfrSumSpec$group[1:nStn]);#--indices for largest nStn summed spectra
grps
ggplot(dfrT1 |> dplyr::filter(group %in% grps),aes(x=L,y=value,colour=Gear)) +
geom_line() +
facet_wrap(~group) +
labs(x="Length (mm)",y="Size spectrum of population [#/mm]") +
wtsPlots::getStdTheme();
ggplot(dfrT1 |> dplyr::filter(group %in% grps),aes(x=L,y=value,colour=Gear)) +
geom_line() +
facet_grid(group~.,scales="free_y") +
labs(x="Length (mm)",y="Size spectrum of population [#/mm]") +
wtsPlots::getStdTheme();
ggplot(dfrT1 |> dplyr::filter(group %in% grps),aes(x=L,y=value,colour=Gear)) +
geom_line() +
facet_grid(group~.,scales="free_y") +
labs(x="size (mm CW)",y="Haul-level size spectrum") +
wtsPlots::getStdTheme();
source("~/Work/Projects/SBS_SelectivityAnalysis_TannerCrab/Analysis/04a_ThygesenIntercalibration/Intercalibration/gearcalib/R/gearcalib.R", echo = TRUE)
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM,ymax=NULL,select="spectrum")
View(pltM)
pltM = plot.gearcalibFit(fitM,boot=botM,Lvec=zM,ymax=NULL)
pltF = plot.gearcalibFit(fitF,boot=botF,Lvec=zF,ymax=1)
dirThs
res = list(m=list(fit=fitM,boot=botM,plots=pltM),
f=list(fit=fitF,boot=botF,plots=pltF));
wtsUtilities::saveObj(res,file.path(dirThs,"results.RData"));
