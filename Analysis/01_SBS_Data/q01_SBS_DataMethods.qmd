---
title: "SBS Studies: Data Methods"
author: "William T. Stockhausen"
institute: "AFSC/NMFS/NOAA"
date: '`r format(Sys.time(), "%b %e, %Y")`'
fontsize: 11pt 
number-sections: true
number-depth: 3
reference-location: document
reference-section-title: References
bibliography: '`r path.expand("~/Work/Projects/Bibliography/AllRefs.bib")`'
csl: '`r system.file("files/CJFAS.csl",package="wtsQMD")`'
link-citations: true
crossref:
  chapters: false      # prepend label reference numbers by chater number?
  fig-title: Figure    # for caption: default is "Figure")
  tbl-title: Table     # for caption: default is "Table")
  title-delim: "."     # for caption: default is ":")
  fig-prefix: Figure   # for in-text (use [-@fig-ref] to drop prefix in text)
  tbl-prefix: Table    # for in-text (use [-@tbl-ref] to drop prefix in text)
  fig-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  tbl-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  subref-labels: alpha a # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  ref-hyperlink: true    # references are hyperlinked if true
format: 
  html: 
    df-print: paged
    toc: true
    toc-location: right
    fig-width: 8
    fig-asp: 0.6
    fig-dpi: 100
    embed-resources: true
  pdf:
    documentclass: scrartcl
    toc: false
    fig_crop: false
    keep-tex: false
    fig-asp: 0.6
    geometry:
      - left=1.0in
      - right=1.0in
      - top=1.0in
      - bottom=1.0in
      - textwidth=6.5in
      - showframe=false
    include-in-header: 
      - text: |
          \usepackage{placeins}
          \extrafloats{500}
          \maxdeadcycles=10000
      - file: '`r system.file("files/ltx_ExtraLatexIncludes.tex",package="wtsQMD")`'
#      - file: "/Users/williamstockhausen/Work/Programming/R/Library/wtsQMD/files/ltx_ExtraLatexIncludes.tex"
echo: false
warning: false
results: 'hide'
keep-md: false
keep-yaml: false
editor: source
editor_options: 
  chunk_output_type: console
concordance: true
params:
  setup: !expr 'system.file("files/qmd_setup.R",package="wtsQMD")'
  testing: false
  reorderTables: false   #--issue with finding "range" of table values  (don't use)
  reorderFigures: false  #--issue with finding "range" of figure values (don't use)
---
<!-- IMPORTANT: if used as a child doc, all chunk labels must be unique within the overall document -->

<!-- 
  NOTEs: 
     * child_path$peek() gives path to current script.
     * before starting a child document, do 
         "child_path$push(file.path(child_path$peek(),rel_path))" first, 
         where rel_path is the relative path to the child
     * after a child document has finished, do "child_path$pop()" to return to current path value
-->

<!-- if not child doc, set up required objects -->
```{r}
#| label: SBS_DataMethods_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
  testing = params$testing;
  if (testing) cat(params$setup,"\n\n")
  source(params$setup);
  if (testing) cat("root = ",root,"\n\n")
  reorderTables  = params$reorderTables;
  reorderFigures = params$reorderFigures;
```

```{r}
#| label: setup_SBS_DataMethods
#| results: 'asis'
  require(ggplot2);
  require(kableExtra);
  require(tables);
  Sum = wtsUtilities::Sum;
  old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
                               cowplot::background_grid() +
                               cowplot::panel_border());
  thm = wtsPlots::getStdTheme();
  options("readr.show_col_types"=FALSE);
  if (testing) warning("dirThs =",child_path$peek(),"\n\n")

  if (rstudioapi::isAvailable()){
    dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/01_SBS_Data");
  } else if (child_path$peek()!=""){
    dirThs = child_path$peek();
  } else {
    dirThs = ".";
  }
  ##--NOTE: take out or modify the following as necessary
  if (!exists("s")){
    if (rstudioapi::isAvailable())
      fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
    if (child_path$peek()!="")
      fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
    #--for debugging: ;
    if (file.exists(fn)) s = wtsUtilities::getObj(fn);
  }
```

## SBS data collection {#sec-SBS-DataCollection}

SBS studies were conducted jointly by the National Marine Fisheries' Alaska Science Center (NMFS AFSC) and the Bering Sea Fisheries Research Foundation (BSFRF) in 2013, 2014, 2015, and 2016 at standard NMFS Eastern Bering Sea (EBS) Shelf Survey stations in Bristol Bay, Alaska to characterize the selectivity of the NMFS bottom trawl survey gear for red king crab, *Paralithodes camtschaticus*, and Tanner crab ,*Chionoecetes bairdi* (@fig-sbs-stations). Similar studies were also conducted in 2017 and 2018 further west on the EBS shelf focused more specifically on Tanner crab (@fig-sbs-stations). These studies were similar to earlier studies conducted on the northwest EBS shelf to characterize NMFS survey selectivity for snow crab, *C. opilio* [@SomertonEtAl2013]. The NMFS survey uses a 83-112 otter trawl towed for \~30 minutes on-bottom at stations located on a standardized 20 *x* 20 nmi^2^ grid across the EBS shelf, with additional stations located at grid corners near the Pribilof Islands and St. Matthew Island to provide higher sampling densities in those areas for blue king crab [e.g., @LauthAndNichol2013]. For the SBS studies, a BSFRF-chartered vessel towed a nephrops bottom trawl [@ConanEtAl1994; @SomertonEtAl2013] starting at the same time, and at the same speed and direction, as the associated NMFS tow, but offset by \~0.5 nmi to create a "paired haul". Tow durations were limited to \~5 minutes on bottom because the BSFRF gear had better bottom-tending performance than the NMFS gear.


```{r create_sbs_station_maps}
#| cache: true
#| cache-vars: p1
#| echo: false
  lst = wtsUtilities::getObj(file.path(s$dirs$SBS_Data,"rda_Step1_SBS_RawData.RData"));
  dfr_stns  = lst$dfrSD_SBS |> dplyr::select(YEAR,GIS_STATION);
  dfr_hauls = dplyr::bind_rows(lst$dfrHD_BSFRF_SBS |> 
                                 dplyr::select(YEAR,MID_LATITUDE,MID_LONGITUDE) |> 
                                 dplyr::mutate(type="BSFRF"),
                               lst$dfrHD_NMFS_SBS |> 
                                 dplyr::select(YEAR,MID_LATITUDE,MID_LONGITUDE) |> 
                                 dplyr::mutate(type="NMFS"));
  sf_hauls = wtsGIS::createSF_points(dfr_hauls,
                                     xCol="MID_LONGITUDE",
                                     yCol="MID_LATITUDE");

  grid = tcsamSurveyData::gisGetSurveyGridLayers()$grid;
  crs  = sf::st_crs(grid);
  bbox = wtsGIS::getStandardBBox("EBS");
  bbox["xmin"] = -173;
  bbox["ymax"] =   60;
  land = wtsGIS::getPackagedLayer("Alaska");
  bthm = wtsGIS::getPackagedLayer("ShelfBathymetry") |> 
           wtsGIS::transformCRS(crs) |> 
           sf::st_crop(bbox);
          
  bmls = tcsamSurveyData::gg_GetBasemapLayers(sf_land=land,
                                              sf_bathym=bthm,
                                              final_crs=crs,
                                              bbox=bbox);
  sf_stns = dfr_stns |> 
               dplyr::inner_join(grid,by=c("GIS_STATION"="STATION_ID")) |> 
               sf::st_set_geometry("geometry");
  p1 = ggplot(sf_stns) + 
        bmls$land + 
        geom_sf(fill="grey") + 
        bmls$bathym + 
        geom_sf(data=grid,colour="grey",fill=NA,size=0.5) + 
        geom_sf(data=sf_hauls |> dplyr::filter(type=="BSFRF"),
                mapping=aes(colour=type,shape=type,fill=type),
                show.legend=FALSE) + 
        facet_wrap(~YEAR,nrow=2) + 
        bmls$map_scale + 
        wtsPlots::getStdTheme() + bmls$theme;
```

Haul sampling protocols for both survey groups were based on the standard NMFS EBS survey protocols [@LauthAndNichol2013; @ZacherEtAl2019] For each tow, all crab were removed from the catch, sorted by species and sex, and a total catch weight was obtained for each species. Biological sampling for various crab species during survey generally consists of whole haul sampling, in which all crab are enumerated and various biological data such as sex, maturity state, shell condition, and carapace width (or length, depending on species) were recorded for each individual [e.g., @ZacherEtAl2019]. However, when the total catch was exceptionally large (approximately > 300 individuals), a random subsample of the catch was taken for enumeration and biological data collection. When subsampling occurred, the subsample could be taken at the level of the total catch, or at the level of a particular size and sex category. The weights for the entire catch component to be subsampled and the total weight of all individually-measured crab in the subsample were recorded and a "sampling factor", $\theta$, was calculated from the size composition of the measured crab to "expand" the measured crab abundance to the entire catch component:

 $$ 
 \theta = \frac {W_T} {W_S} 
 $$ {#eq-SamplingFactor}

where $W_T$ was the total weight of crab in the catch component and $W_S$ was the total weight of measured crab in the subsample. A sampling factor was associated with each measured crab (measured crab which were not part of a subsample were assigned a sampling factor of 1).

Gear-specific catch abundance was standardized by sex ($x$), maturity state (for females, $m$), and 5-mm carapace width (CW) size bin ($z$) to catch-per-unit-effort (CPUE; numbers/sq nmi) for each haul by: 1) summing the sampling factors associated with each measured crab by sex/maturity/size category and 2) dividing by the area swept by the gear $g$ during the haul, $a_{g,h}$, as in: 

$$ 
CPUE_{g,h,x,m,z} = \frac {\sum_{i_{g,h} \in \{x,m,z\}} \theta_{i_{g,h}}} {a_{g,h}}
$$ {#eq-CPUE}

where $h$ denotes the paired haul, $i_{g,h}$ indicates the $i$-th measured crab caught by gear $g$ in haul $h$, $\theta_i$ is the sampling factor associated with the $i$-th crab, and $i_{g,h} \in \{x,m,z\}$ indicates that the sum is only over measured crab falling within sex/maturity state/size bin $\{x,m,z\}$. The area swept $a_{g,h}$ was estimated using bottom contact sensor data to determine time/distance on bottom and net mensuration data to determine net width.

Gear-specific, haul-level CPUE was subsequently expanded to total abundance by sex, maturity state, and 5-mm CW size bin within each year-specific study area using standard design-based calculations for area expansion [@Wakbayashi1985], where each study area was considered a single stratum and the NMFS EBS survey grid provided the associated area expansion factors (~400 sq. nmi) for the paired hauls. Specifically, 

$$ 
N_{g,x,m,z} = \sum_{h} CPUE_{g,h,x,m,z} \cdot A_{h}
$$ {#eq-TotAbund}


```{r}
#| label: fig-sbs-stations
#| fig-cap: 'Side-by-side haul (SBS) study stations for Tanner crab selectivity in the NMFS Eastern Bering Sea Shelf Survey. Grey lines: NMFS survey grid stations; filled squares: SBS stations with paired hauls; blue lines: 50 m, 100 m, 200 m and deeper bathymetric contours.'
#| fig-alt: Maps showing the side-by-side haul (SBS) study stations for Tanner crab selectivity in 2013-2018.
#| dependson: create_sbs_station_maps
#| warning: false
#| echo: false
##| fig-width: 8.0in
#| out-width: 100%
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p1));
```

<!-- references -->
```{r refs_SBS_DataMethods,eval=!knitr::opts_knit$get("child")&!isPDF,results='asis'}
  cat("# References {-}\n");
  cat("::: {#refs}\n");
  cat(":::\n\n");
```

<!-- tables, if not child doc and lstTbls is not empty -->
```{r}
#| label: tables_SBS_DataMethods
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printTablesSectionFromList.R",package="wtsQMD"));
```

<!-- figures, if not child doc and lstFigs is not empty -->
```{r}
#| label: figures_SBS_DataMethods
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printFiguresSectionFromList.R",package="wtsQMD"));
```
