---
title: "SBS Studies: Data Results"
author: "William T. Stockhausen"
institute: "AFSC/NMFS/NOAA"
date: '`r format(Sys.time(), "%b %e, %Y")`'
fontsize: 11pt 
number-sections: true
number-depth: 3
reference-location: document
reference-section-title: References
# bibliography: ../Bibliography/bib_SBS-TannerCrab-doc.bib 
csl: '`r system.file("files/CJFAS.csl",package="wtsQMD")`'
link-citations: true
crossref:
  chapters: false      # prepend label reference numbers by chater number?
  fig-title: Figure    # for caption: default is "Figure")
  tbl-title: Table     # for caption: default is "Table")
  title-delim: "."     # for caption: default is ":")
  fig-prefix: Figure   # for in-text (use [-@fig-ref] to drop prefix in text)
  tbl-prefix: Table    # for in-text (use [-@tbl-ref] to drop prefix in text)
  fig-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  tbl-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  subref-labels: alpha a # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  ref-hyperlink: true    # references are hyperlinked if true
format: 
  html: 
    df-print: paged
    toc: true
    toc-location: right
    fig-width: 8
    fig-asp: 1.4
    fig-dpi: 100
    embed-resources: true
  pdf:
    documentclass: scrartcl
    toc: false
    fig_crop: false
    keep-tex: false
    geometry:
      - left=1.0in
      - right=1.0in
      - top=1.0in
      - bottom=1.0in
      - textwidth=6.5in
      - showframe=false
    include-in-header: 
      - text: |
          \usepackage{placeins}
          \extrafloats{500}
          \maxdeadcycles=10000
      - file: "/Users/williamstockhausen/Work/Programming/R/Library/wtsQMD/files/ltx_ExtraLatexIncludes.tex"
echo: false
warning: false
results: 'hide'
keep-md: false
keep-yaml: false
editor: source
editor_options: 
  chunk_output_type: console
concordance: true
params:
  setup: !expr 'system.file("files/qmd_setup.R",package="wtsQMD")'
  testing: false
  reorderTables: false   #--issue with finding "range" of table values  (don't use)
  reorderFigures: false  #--issue with finding "range" of figure values (don't use)
---
<!-- IMPORTANT: if used as a child doc, all chunk labels must be unique within the overall document -->

<!-- 
  NOTEs: 
     * child_path$peek() gives path to current script.
     * before starting a child document, do 
         "child_path$push(file.path(child_path$peek(),rel_path))" first, 
         where rel_path is the relative path to the child
     * after a child document has finished, do "child_path$pop()" to return to current path value
-->

<!-- if not child doc, set up required objects -->
```{r}
#| label: SBSDataResults_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
  testing = params$testing;
  if (testing) cat(params$setup,"\n\n")
  source(params$setup);
  if (testing) cat("root = ",root,"\n\n")
  reorderTables  = params$reorderTables;
  reorderFigures = params$reorderFigures;
```

```{r}
#| label: setup_SBSDataResults
#| results: 'asis'
  require(ggplot2);
  require(kableExtra);
  require(tables);
  Sum = wtsUtilities::Sum;
  old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
                               cowplot::background_grid() +
                               cowplot::panel_border());
  thm = wtsPlots::getStdTheme();
  options("readr.show_col_types"=FALSE);
  if (testing) cat("dirThs =",child_path$peek(),"\n\n")

  if (rstudioapi::isAvailable()){
    dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/01_SBS_Data");
  } else if (child_path$peek()!=""){
    dirThs = child_path$peek();
  } else {
    dirThs = ".";
  }
  ##--NOTE: take out or modify the following as necessary
  if (!exists("s")){
    if (rstudioapi::isAvailable())
      fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
    if (child_path$peek()!="")
      fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
    #--for debugging: ;
    if (file.exists(fn)) s = wtsUtilities::getObj(fn);
  }
  ##--
```

### Survey catch data {#sec-SBSDataResults}

On average, the NMFS gear tended to catch more crab per tow at all (except the smallest) sizes compared with the BSFRF gear, reflecting the larger area swept by the NMFS gear during a tow (Figures [-@fig-RawNumbersMales], [-@fig-RawNumbersFemales] and [-@fig-ProportionNMFS]). Conversely, estimates of crab abundance were generally higher, particularly for small crab, from the BSFRF gear after accounting for area swept in each haul (@fig-AreaSweptNumbers). The resulting values obtained for $ln(r_{h,z})$ (@fig-LnR) exhibit substantial variability across hauls at almost any given size, with ln-scale values ranging from less than -2 to greater than 1 (ignoring infinite values from paired hauls with no catch at a given size by one gear type), suggesting that haul-level selectivity at a given size could vary by as much as a factor of 20 across stations--although this also includes variability simply due to sampling "error". The mean values of $ln(r)$ over hauls follow similar trends with size in each study year, whether weighted or unweighted by numbers caught, as generally does the value calculated from the ratio of area-swept abundance for the two gear types. All three approaches suggest that selectivity increases with size up to a point (although this point varies by year). One marked difference exhibited by the area-swept estimates, however, is that it suggests NMFS selectivity is asymptotic, whereas the values based on the paired haul data suggest that NMFS selectivity is dome-shaped, with large animals less prone to capture than intermediate-sized ones (@fig-EmpSel).

```{r SBSDataResults_calcRawZCsByStn}
  #--calculate "raw" size comps for numbers caught by station and gear type
  #----DON'T use tcsamSurveyData functions for this (they scale by area swept)
  require(wtsSizeComps)
  lst = wtsUtilities::getObj(file.path(s$dirs$SBS_Data,"rda_Step1_SBS_RawData.RData"));
  cutpts = seq(-0.5,204.5,5);
  zBs    = wtsUtilities::calcMidpoints(cutpts);
  dfrID_SBS = dplyr::bind_rows(
                lst$dfrID_BSFRF_SBS |> 
                  dplyr::inner_join(lst$dfrHD_BSFRF_SBS,by="HAULJOIN") |> 
                  dplyr::select(YEAR,station=GIS_STATION,SEX,MATURITY,SHELL_CONDITION,SIZE,
                                numIndivs,SAMPLING_FACTOR) |> 
                  dplyr::mutate(gear="BSFRF"),
                lst$dfrID_NMFS_SBS |> 
                  dplyr::inner_join(lst$dfrHD_NMFS_SBS,by="HAULJOIN") |> 
                  dplyr::select(YEAR,station=GIS_STATION,SEX,MATURITY,SHELL_CONDITION,SIZE,
                                numIndivs,SAMPLING_FACTOR) |> 
                  dplyr::mutate(gear="NMFS")) |> 
               dplyr::rename_with(tolower,.cols=!numIndivs) |> 
               dplyr::filter(sex %in% c("MALE","FEMALE"));#--drop other categories
  #--determine unique year/station combinations and all size bins
  dfrYSZ = dfrID_SBS |> dplyr::distinct(year,station) |> 
             dplyr::cross_join(tibble::tibble(size=zBs));
  #--calc size comps based on numbers sampled
  dfrZCs_Num = wtsSizeComps::calcSizeComps(dfrID_SBS,"size","numIndivs",
                                           c("gear","year","station","sex"),
                                           cutpts,expandToAllFactorCombos=FALSE) |> 
                 dplyr::mutate(size=size+2.5); #--adjust to center of size bins
  #----expand size comps to all year/station/size bin combinations
  dfrZCs_Num = dfrYSZ |> dplyr::left_join(dfrZCs_Num,by=c("year","station","size")) |> 
                 dplyr::mutate(sampled=ifelse(is.na(numIndivs),0,numIndivs)) |> 
                 dplyr::arrange(year,station,sex,size,gear) |> 
                 dplyr::select(!numIndivs);
  #--calc size comps based on estimated numbers caught
  dfrZCs_Cat = wtsSizeComps::calcSizeComps(dfrID_SBS,"size","sampling_factor",
                                           c("gear","year","station","sex"),
                                           cutpts,expandToAllFactorCombos=FALSE) |> 
                 dplyr::mutate(size=size+2.5); #--adjust to center of size bins
  #----expand size comps to all year/station/size bin combinations
  dfrZCs_Cat = dfrYSZ |> dplyr::left_join(dfrZCs_Cat,by=c("year","station","size")) |> 
                 dplyr::mutate(caught=ifelse(is.na(sampling_factor),0,sampling_factor)) |> 
                 dplyr::arrange(year,station,sex,size,gear) |> 
                 dplyr::select(!sampling_factor);
  #--combine tables
  dfrZCs_RawByStn = dplyr::bind_cols(dfrZCs_Num,caught=dfrZCs_Cat$caught);
  rm(dfrZCs_Cat,dfrZCs_Num);
```

```{r SBSDataResults_CalcTotRawZCs}
  dfrZCs_RawTot = dfrZCs_RawByStn |> 
                    dplyr::group_by(year,sex,size,gear) |> 
                    dplyr::summarize(ss=Sum(ss),
                                     sampled=Sum(sampled),
                                     caught=Sum(caught)) |>
                    dplyr::ungroup() |> 
                  tidyr::pivot_longer(c(sampled,caught),names_to="type",values_to="total")
```

```{r SBSDataResults_DefFcn-plotTotRawZCs}
  require(ggplot2);
  require(rlang);
  plotTotRawZCs<-function(dfr_,sex_,col,label){
    p = ggplot(dfr_ |> dplyr::filter(sex==sex_),
               aes(x=size,y={{col}},colour=gear,linetype=type)) + 
          geom_line() + 
          geom_vline(xintercept=25,linetype=3) + 
          facet_wrap(~year,nrow=2,scales="free_y") + 
          labs(x="size (mm CW)",y=label) + 
          theme(legend.position=c(0.99,0.48),
                legend.justification=c(1,1)) +
          wtsPlots::getStdTheme();
    return(p);
  }
```

```{r}
#| label: fig-RawNumbersMales
#| fig-cap: "Total numbers of males sampled (measured) in the SBS studies, by 5-mm size bin and gear type (solid lines). Also shown are the estimated numbers caught prior to any sub-sampling, by 5-mm size bin and gear type (dotted lines)."
  plotTotRawZCs(dfrZCs_RawTot,"MALE",total,"males");
```

```{r}
#| label: fig-RawNumbersFemales
#| fig-cap: "Total numbers of females sampled (measured) in the SBS studies, by 5-mm size bin and gear type (solid lines). Also shown are the estimated numbers caught prior to any sub-sampling, by 5-mm size bin and gear type (dotted lines)."
plotTotRawZCs(dfrZCs_RawTot,"FEMALE",total,"females");
```

```{r calcTotNMFSPropByZB}
dfrTotNMFSProps = 
  dfrZCs_RawTot |> dplyr::select(!ss) |>
    tidyr::pivot_wider(names_from=gear,values_from="total") |> 
    dplyr::mutate(total=NMFS+BSFRF,
                  propNMFS=NMFS/total,
                  type=factor(type,levels=c("sampled","caught")));
```

```{r createPlotTotPropsByZB}
clrs_numtype = c(sampled="cyan",caught="red");
plotTotPropsByZB<-function(dfr_,sex_,col,label){
  p = ggplot(dfr_ |> dplyr::filter(sex==sex_),
             aes(x=size,y={{col}},colour=type,linetype=type)) + 
        geom_line() + 
        geom_point(aes(size=total),shape=21) + 
        geom_vline(xintercept=25,linetype=3) + 
        scale_size_area() + 
        scale_colour_discrete(type=clrs_numtype) + 
        ylim(0,1) + 
        facet_wrap(~year,nrow=2,scales="free_y") + 
        labs(x="size (mm CW)",y=paste0("Proportion total in NMFS gear (",label,")")) + 
        theme(legend.position="top",
              legend.box.just="top",
              legend.justification=c(0,0.5),
              legend.direction="horizontal") +
        wtsPlots::getStdTheme();
  return(p);
}
dfr = dfrTotNMFSProps |> dplyr::arrange(rev(type)) |> 
        dplyr::rowwise() |> dplyr::mutate(total=min(total,500));
```
```{r}
#| label: fig-TotRawPropsMales
#| fig-cap: "Total numbers of males sampled (measured) in the SBS studies, by 5-mm size bin and gear type (solid lines). Also shown are the estimated numbers caught prior to any sub-sampling, by 5-mm size bin and gear type (dotted lines)."
plotTotPropsByZB(dfr,"MALE",  propNMFS,"males");
```
```{r}
#| label: fig-TotRawPropsFemales
#| fig-cap: "Total numbers of males sampled (measured) in the SBS studies, by 5-mm size bin and gear type (solid lines). Also shown are the estimated numbers caught prior to any sub-sampling, by 5-mm size bin and gear type (dotted lines)."
plotTotPropsByZB(dfr,"FEMALE",propNMFS,"females")
```

```{r calcNMFSPropsByStn}
dfrNMFSPropsByStn = 
  dfrZCs_RawByStn |> 
    tidyr::pivot_longer(c(sampled,caught),names_to="type",values_to="total") |> 
    dplyr::select(!ss) |>
    tidyr::pivot_wider(names_from=gear,values_from="total") |> 
    dplyr::mutate(total=NMFS+BSFRF,
                  propNMFS=NMFS/total,
                  type=factor(type,levels=c("sampled","caught")));
```

```{r }
clrs_numtype = c(sampled="cyan",caught="red");
plotPropsByStnZB<-function(dfr_,sex_,col,label){
  p = ggplot(dfr_ |> dplyr::filter(sex==sex_),
             aes(x=size,y={{col}},colour=type,linetype=type)) + 
        geom_smooth(colour="black",method=stats::loess,formula=y~x) + 
        geom_point(aes(size=total),shape=21) + 
        geom_vline(xintercept=25,linetype=3) + 
        scale_size_area() + 
        scale_colour_discrete(type=clrs_numtype) + 
        ylim(0,1) + 
        facet_wrap(~year,nrow=2,scales="free_y") + 
        labs(x="size (mm CW)",y=paste0("Proportion in NMFS gear by station (",label,")")) + 
        theme(legend.position="top",
              legend.box.just="top",
              legend.justification=c(0,0.5),
              legend.direction="horizontal") +
        wtsPlots::getStdTheme();
  return(p);
}
dfr = dfrNMFSPropsByStn |> dplyr::arrange(rev(type)) |> 
        dplyr::rowwise() |> dplyr::mutate(total=min(total,500));
```
```{r}
#| label: fig-RawPropsByStnnMales
#| fig-cap: "Raw proportion of total males sampled (measured) using NMFS gear, by station and 5-mm size bin (circles; area indicates total number sampled across both gear types). Also shown is a loess smooth (black line and shading."
plotPropsByStnZB(dfr |>dplyr::filter(type=="sampled"),"MALE",propNMFS,"males")
```
```{r}
#| label: fig-RawPropsByStnnMales
#| fig-cap: "Raw proportion of total males sampled (measured) using NMFS gear, by station and 5-mm size bin (circles; area indicates total number sampled across both gear types). Also shown is a loess smooth (black line and shading."
plotPropsByStnZB(dfr |>dplyr::filter(type=="sampled"),"MALE",propNMFS,"males")
```
```{r}
#| label: fig-RawPropsByStnFemales
#| fig-cap: "Raw proportion of total females sampled (measured) using NMFS gear, by station and 5-mm size bin (circles; area indicates total number sampled across both gear types). Also shown is a loess smooth (black line and shading."
plotPropsByStnZB(dfr |>dplyr::filter(type=="sampled"),"FEMALE",propNMFS,"females")+xlim(0,130)
```

```{r}
#--compare areas swept, depth, and temperature
dfrADT = dplyr::bind_rows(
              lst$dfrHD_BSFRF_SBS |> 
                dplyr::select(YEAR,station=GIS_STATION,area_swept=AREA_SWEPT_VARIABLE,
                              depth=BOTTOM_DEPTH,temp=GEAR_TEMPERATURE) |> 
                dplyr::rename_with(tolower,everything()) |> 
                dplyr::mutate(gear="BSFRF"),
              lst$dfrHD_NMFS_SBS |> 
                dplyr::select(YEAR,station=GIS_STATION,area_swept=AREA_SWEPT_VARIABLE,
                              depth=BOTTOM_DEPTH,temp=GEAR_TEMPERATURE) |> 
                dplyr::rename_with(tolower,everything()) |> 
                dplyr::mutate(gear="NMFS"));
```
```{r}
#| label: fig-AreasSwept
#| fig-cap: "Comparison of areas swept by the NMFS (x-axis) and BSFRF (y-axis) gear types. Each histogram is normalized by its maximum to show relative frequencies across bins."
#| warning: false
#| echo: false
dfr = dfrADT |> 
        tidyr::pivot_wider(id_cols=c("year","station"),names_from="gear",values_from="area_swept");
xmx = max(dfr$NMFS,na.rm=TRUE);
ymx = max(dfr$BSFRF,na.rm=TRUE);
wtsPlots::ggMarginal_Hist2D(dfr,NMFS,BSFRF,xlab="NMFS area swept",ylab="BSFRF area swept",
       xparams=list(limits=c(0,xmx)),yparams=list(limits=c(0,ymx)),
       legend.position=c(0.1,0.99),legend.justification=c(0,1))
```
```{r}
#| label: fig-HaulDepths
#| fig-cap: "Comparison of haul depths, by paired haul, for the NMFS (x-axis) and BSFRF (y-axis) gear types. Note that it is the difference between the NMFS and BSFRF haul depths that is plotted against the NMFS haul depth. Colour indicates the year each haul was conducted. The smooth line (and shading) indcates the overall trend with depth."
#| warning: false
#| echo: false
dfr = dfrADT |> 
        tidyr::pivot_wider(id_cols=c("year","station"),names_from="gear",values_from="depth");
xmx = max(dfr$NMFS,na.rm=TRUE);
ymx = max(dfr$BSFRF,na.rm=TRUE);
# wtsPlots::ggMarginal_Hist2D(dfr,NMFS,BSFRF,xlab="NMFS haul depth",ylab="BSFRF haul depth",
#        xparams=list(limits=c(0,xmx)),yparams=list(limits=c(0,ymx)),
#        legend.position=c(0.1,0.99),legend.justification=c(0,1));
# p1 = ggplot(dfr,aes(x=NMFS,y=BSFRF,colour=as.character(year))) + 
#   geom_point(shape=22) + geom_abline(slope=1,linetype=2) + 
#   labs(x="NMFS haul depth (m)",y="BSFRF haul depth (m)",colour="year") + 
#   thm + theme(legend.position=c(0.01,0.99),legend.justification=c(0,1));
ggplot(dfr,aes(x=NMFS,y=NMFS-BSFRF,colour=as.character(year))) + 
  geom_smooth(colour="black") + 
  geom_point(shape=22) + geom_hline(yintercept=0,linetype=2) + 
  labs(x="NMFS haul depth (m)",y="NMFS-BSFRF haul depth (m)",colour="year") + 
  thm + theme(legend.position=c(0.01,0.99),legend.justification=c(0,1));
```
```{r}
#| label: fig-BottomTemps
#| fig-cap: "Comparison of measured bottom temperatures, by paired haul, from the NMFS (x-axis) and BSFRF (y-axis) gear types. Note that it is the difference between the NMFS and BSFRF haul depths that is plotted against the NMFS haul depth. Colour indicates the year each haul was conducted. The smooth line (and shading) indcates the overall trend with depth."
#| warning: false
#| echo: false
dfr = dfrADT |> 
        tidyr::pivot_wider(id_cols=c("year","station"),names_from="gear",values_from="temp");
xmx = max(dfr$NMFS,na.rm=TRUE);
ymx = max(dfr$BSFRF,na.rm=TRUE);
# wtsPlots::ggMarginal_Hist2D(dfr,NMFS,BSFRF,xlab="NMFS bottom temperature",ylab="BSFRF bottom temperature",
#        xparams=list(limits=c(0,xmx)),yparams=list(limits=c(0,ymx)),
#        legend.position=c(0.1,0.99),legend.justification=c(0,1));
# ggplot(dfr,aes(x=NMFS,y=BSFRF,colour=as.character(year))) + 
#   geom_point(shape=22) + geom_abline(slope=1,linetype=2) + 
#   labs(x="NMFS bottom temperature",y="BSFRF bottom temperature",colour="year") + 
#   thm + theme(legend.position=c(0.01,0.99),legend.justification=c(0,1));
ggplot(dfr,aes(x=NMFS,y=NMFS-BSFRF,colour=as.character(year))) + 
  geom_smooth(colour="black") + 
  geom_point(shape=22) + geom_hline(yintercept=0,linetype=2) + 
  labs(x="NMFS bottom temperature",y="NMFS-BSFRF bottom temperature",colour="year") + 
  thm + theme(legend.position=c(0.01,0.01),legend.justification=c(0,0));
```

<!-- references -->
```{r refs_SBSDataResults,eval=!knitr::opts_knit$get("child"),results='asis'}
  cat("# References {-}\n");
  cat("::: {#refs}\n");
  cat(":::\n\n");
```

<!-- tables, if not child doc and lstTbls is not empty -->
```{r}
#| label: tables_SBSDataResults
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printTablesSectionFromList.R",package="wtsQMD"));
```

<!-- figures, if not child doc and lstFigs is not empty -->
```{r}
#| label: figures_SBSDataResults
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printFiguresSectionFromList.R",package="wtsQMD"));
```
