---
title: "SBS Studies: Empirical Selectivity Results"
author:
- name: William T. Stockhausen
  affiliations:
    - id: afsc-refm
      name: "Alaska Fisheries Science Center"
      department: "Resource Ecology and Fisheries Management"
      address: 
        - "7600 Sand Point Way N.E."
        - "Seattle, Washington 98115-6349"
date: '`r format(Sys.time(), "%b %e, %Y")`'
fontsize: 11pt 
number-sections: true
number-depth: 3
reference-location: document
reference-section-title: References
bibliography: '`r path.expand("~/Work/Projects/Bibliography/AllRefs.bib")`'
csl: '`r system.file("files/CJFAS.csl",package="wtsQMD")`'
link-citations: true
crossref:
  chapters: false      # prepend label reference numbers by chater number?
  fig-title: Figure    # for caption: default is "Figure")
  tbl-title: Table     # for caption: default is "Table")
  title-delim: "."     # for caption: default is ":")
  fig-prefix: Figure   # for in-text (use [-@fig-ref] to drop prefix in text)
  tbl-prefix: Table    # for in-text (use [-@tbl-ref] to drop prefix in text)
  fig-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  tbl-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  subref-labels: alpha a # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  ref-hyperlink: true    # references are hyperlinked if true
format: 
  html: 
    df-print: paged
    toc: true
    toc-location: right
    fig-width: 8
    fig-asp: 0.4
    fig-dpi: 100
    embed-resources: true
    include-in-header: 
      - '`r system.file("files/in-line_math_mode.html",package="wtsQMD")`'
  pdf:
    documentclass: scrartcl
    toc: false
    fig_crop: false
    keep-tex: false
    fig-width: 6.5
    fig-asp: 0.4
    geometry:
      - left=1.0in
      - right=1.0in
      - top=1.0in
      - bottom=1.0in
      - textwidth=6.5in
      - showframe=false
    include-in-header: 
      - text: |
          \usepackage{placeins}
          \extrafloats{500}
          \maxdeadcycles=10000
      - file: '`r system.file("files/ltx_ExtraLatexIncludes.tex",package="wtsQMD")`'
echo: false
warning: false
results: 'hide'
keep-md: false
keep-yaml: false
editor: source
editor_options: 
  chunk_output_type: console
concordance: true
params:
  setup: !expr 'system.file("files/qmd_setup.R",package="wtsQMD")'
  testing: false
  reorderTables: false   #--issue with finding "range" of table values  (don't use)
  reorderFigures: false  #--issue with finding "range" of figure values (don't use)
---
<!-- IMPORTANT: if used as a child doc, all chunk labels must be unique within the overall document -->

<!-- 
  NOTEs: 
     * child_path$peek() gives path to current script.
     * before starting a child document, do 
         "child_path$push(file.path(child_path$peek(),rel_path))" first, 
         where rel_path is the relative path to the child
     * after a child document has finished, do "child_path$pop()" to return to current path value
-->

<!-- if not child doc, set up required objects -->
```{r}
#| label: EmpSel_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
  testing = params$testing;
  if (testing) cat(params$setup,"\n\n")
  source(params$setup);
  if (testing) cat("root = ",root,"\n\n")
  reorderTables  = params$reorderTables;
  reorderFigures = params$reorderFigures;
```

```{r}
#| label: setup_EmpSel
#| results: 'asis'
  require(ggplot2);
  require(kableExtra);
  require(tables);
  Sum = wtsUtilities::Sum;
  old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
                               cowplot::background_grid() +
                               cowplot::panel_border());
  thm = wtsPlots::getStdTheme();
  options("readr.show_col_types"=FALSE);
  if (testing) cat("dirThs =",child_path$peek(),"\n\n")

  if (rstudioapi::isAvailable()){
    dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/01_SBS_Data");
  } else if (child_path$peek()!=""){
    dirThs = child_path$peek();
  } else {
    dirThs = ".";
  }
  ##--NOTE: take out or modify the following as necessary
  if (!exists("prj_setup")){
    if (rstudioapi::isAvailable())
      fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
    if (child_path$peek()!="")
      fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
    #--for debugging: ;
    if (file.exists(fn)) prj_setup = wtsUtilities::getObj(fn);
  }
  ##--
```

```{r EmpSel_GetStep1}
  lst1  = wtsUtilities::getObj(file.path(prj_setup$dirs$EmpSel,"rda_Step1_EmpSel.RData"));
  objs1 = names(lst1);
  for (obj in objs1) assign(obj,lst2[[obj]]);
```

## Empirical selectivity {#sec-Results-EmpSel}

Under the assumption that the BSFRF gear is non-size selective and has a fully-selected catchability equal to 1 (i.e., $S^{BSFRF}_{y,x,z}=1$ for all $y$, $x$, and $z$), the NMFS survey-level selectivity $S^{NMFS}_{y,x,z}$ is related to the gear-specific survey-levels size compositions $Z^{NMFS}_{y,x,z}$ and $Z^{BSFRF}_{y,x,z}$ by either of the following two relationships:

$$S^{NMFS}_{y,x,z} = {Z^{NMFS}_{y,x,z} \over Z^{BSFRF}_{y,x,z}}$$ 
or 

$$ {S^{NMFS}_{x,y,z} \over {1+S^{NMFS}_{x,y,z}}} = {Z^{NMFS}_{x,y,z} \over {Z^{BSFRF}_{x,y,z}+Z^{NMFS}_{x,y,z}}} ~ \left = p_{x,y,z} \right} $$ 

where $p_{x,y,z}$ denotes the proportion on the righthand side. The latter equation can be rearranged to yield

$$ \ln[S^{NMFS}_{x,y,z}] = \ln[{p_{x,y,z} \over {1-p_{x,y,z}}}]=logit(p_{x,y,z})$$

```{r EmpSel-DefFcn-CalcEmpSels,cache=TRUE}
  #--calculate empirical size compositions
  calcEmpiricalSelectivity<-function(dfrZCs){
    #--Calculate empirical selectivity as ratio of NMFS to BSFRF size compositions
    dfrZCsp1<-reshape2::dcast(dfrZCs,"type+y+x+z~fleet",
                              fun.aggregate=wtsUtilities::Sum,value.var="n");
    names(dfrZCsp1)[5:6]<-paste0("n_",names(dfrZCsp1)[5:6]);
    dfrZCsp2<-reshape2::dcast(dfrZCs,"type+y+x+z~fleet",
                              fun.aggregate=wtsUtilities::Sum,value.var="val");
    dfrZCsp2[["emp_sel"]]<-dfrZCsp2$NMFS/dfrZCsp2$BSFRF;
    idx<-is.infinite(dfrZCsp2[["emp_sel"]]);
    dfrZCsp2[["emp_sel"]][idx]<-NaN;
    dfrESs<-cbind(dfrZCsp1,BSFRF=dfrZCsp2$BSFRF,NMFS=dfrZCsp2$NMFS,emp_sel=dfrZCsp2$emp_sel) |> 
              dplyr::mutate(n=n_BSFRF+n_NMFS);
  
    return(dfrESs);
  }
```

```{r EmpSel-CalcEmpSelFcns}
  if (FALSE){
    dfrESs = calcEmpiricalSelectivity(dfrZCs) |> 
               dplyr::mutate(y=factor(y));
    wtsUtilities::saveObj(dfrESs,file.path(child_path$peek(),"rda_EmpSelFcnsRaw.RData"));
  } else {
    dfrESs = wtsUtilities::getObj(file.path(child_path$peek(),"rda_EmpSelFcnsRaw.RData"));
  }
```

```{r EmpSel-CalcModelsEmpSelFcnsM}
  dfrESsp = dfrESs |> dplyr::filter(x=="male");
  mdl1m = mgcv::gam(emp_sel ~ ti(z,bs="tp",k=10),
                     family=tw,data=dfrESsp,method="REML",
                     weights=n_BSFRF/mean(n_BSFRF));
  mdl2m = mgcv::gam(emp_sel ~ ti(z,bs="tp",k=10) + ti(z,by=y,bs="sz"),
                     family=tw,data=dfrESsp,method="REML",select=TRUE,
                     weights=n_BSFRF/mean(n_BSFRF));
  mdl3m = mgcv::gam(emp_sel ~ ti(z,bs="tp",k=10) + ti(z,y,bs="fs"),
                     family=tw,data=dfrESsp,method="REML",select=TRUE,
                     weights=n_BSFRF/mean(n_BSFRF));
  grids = list(z=(dfrESsp |> dplyr::distinct(z))[[1]],
               y=(dfrESsp |> dplyr::distinct(y))[[1]]);
  prd1m = prdMod(mdl1m,trms=c("(Intercept)","s(z)"),lst=grids,type="response",keep="z");
  plotMod(prd1m,c(0,1.5))
  prd2m = prdMod(mdl2m,trms=c("(Intercept)","s(z)"),lst=grids,type="response",keep="z");
  plotMod(prd2m,c(0,1.5))
  lstPrd2m = list();
  for (y_ in levels(dfrESs$y))
    lstPrd2m[[y_]] = prdMod(mdl2m,trms=paste0("ti(z):y",y_),lst=grids,type="terms") |> 
                       dplyr::filter(y==as.numeric(y_));
  dfrPrd2m = dplyr::bind_rows(lstPrd2m);
  dfrPrd2m |> dplyr::group_by(z) |> dplyr::summarize(sum=sum(emp_sel))
  dfrPrd2m |> dplyr::group_by(y) |> dplyr::summarize(sum=sum(emp_sel))
  plotMod(prd2m,c(0,1.5))
```

```{r EmpSel-DefPlots}
  prdMod<-function(mdl,trms,lst,type="response",keep=NULL,p=0.05){
    dfr = wtsMGCV::createGridTbl(lst);
    if (any(trms=="all")){
      #--add intercept and all smooth terms
      trmsp = "(Intercept)";
      trms = wtsMGCV::getSmoothTerms(mdl);
      for (trm in trms) trmsp = c(trmsp,trm);
      trms = trmsp;
    }
    prd = dplyr::bind_cols(
              dfr,
              tibble::as_tibble(
                mgcv::predict.gam(mdl,dfr,type=type,terms=trms,se.fit=TRUE),
              ) |> 
              dplyr::mutate(type="fit",
                            lci=qnorm(p,fit,se.fit,lower.tail=TRUE),
                            uci=qnorm(p,fit,se.fit,lower.tail=FALSE),
                            terms=paste(trms,collapse=" + "))
          ) |> 
            dplyr::rename(emp_sel=fit);
    if (!is.null(keep)){
      prd = prd |> 
              dplyr::distinct(pick(tidyselect::any_of(keep),emp_sel,se.fit,lci,uci,terms));
      drop = names(lst)[!(names(lst) %in% keep)];
      for (drp in drop) prd[[drp]] = NA;
    }
    return(prd);
  }
```

  frmla = emp_sel ~ te(z,bs="tp",k=10);
  p = 0.05;#--tail probability for qnorm: confidence interval = 1-2*p
  fitModel<-function(dfr,dfrp,frmla,fam,p=0.05){
    mdl = mgcv::gam(frmla,family=fam,data=dfr,weights=n/mean(n));
    prd = dplyr::bind_cols(
              dfrp,
              tibble::as_tibble(
                mgcv::predict.gam(mdl,dfrp,type="response",se.fit=TRUE),
              ) |> 
              dplyr::mutate(type="fit",
                            lci=qnorm(p,fit,se.fit,lower.tail=TRUE),
                            uci=qnorm(p,fit,se.fit,lower.tail=FALSE))
          );
    return(list(mdl=mdl,prd=prd));
  }
  mdlESMs = fitModel(dfr=dfrESs |> dplyr::filter(x=="male"),
                     dfrp=dfrESs |> dplyr::distinct(z) |> dplyr::mutate(y=NA,x="male"),
                     frmla = emp_sel ~ te(z,bs="tp",k=10),
                     fam=gaussian);
  mdlESFs = fitModel(dfr=dfrESs |> dplyr::filter(x=="female"),
                     dfrp=dfrESs |> dplyr::distinct(z) |> dplyr::mutate(y=NA,x="female"),
                     frmla = emp_sel ~ te(z,bs="tp",k=10),
                     fam=gaussian);
  dfrESPs = dplyr::bind_rows(dfrESs,mdlESMs$prd,mdlESFs$prd)


Empirical selectivity for the NMFS gear by sex $x$ was estimated for each SBS study year $y$ using Eq. [-@eq-AreaLevelSel] from the corresponding gear-specific, area-expanded total abundance size compositions $N_{g,y,x,z}$, where $g$ denotes gear type, (see Eq. [-@eq-TotAbundZCs]) as 

$$ \tilde{S}^T_{y,x,z} = \frac{N_{g=NMFS,y,x,z}} {N_{g=BSFRF,y,x,z}} $$ {#eq-EmpSurveySel}

under the assumption that the BSFRF nephrops gear is non-selective and catchability is 1. 

The resulting annual empirical selectivity estimates (Tables [-@tbl-EmpSelFcnsMales] and [-@tbl-EmpSelFcnsFemales], Figure [-@fig-EmpSelFcns-Annual]) generally increase with size from a small value near 0 and remain less than 1 across the size range, but also exhibit substantial variability across years--with several estimates that exceeded 1 for both sexes. However, smooth sex-specific functions of size fit to the annual estimates suggest that selectivity for both sexes is small (< 0.3) and increases with size in similar fashion from 25-50 mm CW before diverging above 50 mm CW, with female selectivity reaching an asymptote of ~0.35 near 100 mm CW while male selectivity increases rather steadily up to 0.74 at 160 mm CW (after which few data exist; Tables [-@tbl-EmpSelFcnsMales] and [-@tbl-EmpSelFcnsFemales], Figure [-@fig-EmpSelFcns-Smooths]).

```{r tbl.EmpSelFcnsMales}
#| results: asis
  cap = 'Annual empirical selectivity functions for the NMFS gear for males from the SBS studies, by 5-mm size bin. "NaN" indicates size bins where the BSFRF gear caught no males (i.e., the size composition was 0). Values in the "fit" and "se" columns were derived by fitting a generalized additive model in size to the estimates from all years simultaneously, weighted by the total number of males sampled by size bin for each year.'
  dfrESsp = dplyr::bind_rows(
             dfrESs |> dplyr::filter(x=="male") |> dplyr::mutate(y=as.character(y)) |>
               dplyr::select(year=y,size=z,emp_sel),
             mdlESMs$prd |> dplyr::mutate(y="fit") |> 
               dplyr::select(year=y,size=z,emp_sel=fit),
             mdlESMs$prd |> dplyr::mutate(y="se") |> 
               dplyr::select(year=y,size=z,emp_sel=`se.fit`)
            );
  tblr = tabular(Factor(size)~Factor(year)*emp_sel*sum*Format(formatC(digits=3,format="f")),
                 data=dfrESsp);
  colLabels(tblr) = colLabels(tblr)[c(2),];
  kbl = tblr |> wtsQMD::convert_tblr_to_kbl(c(1,7),
                                            isPDF=wtsQMD::isOutputPDF());
  lstTbls = c(lstTbls,
              insertKblIntoQMD(kbl,
                               lbl="tbl-EmpSelFcnsMales", 
                               cap=cap,
                               ori="P"));
  rm(dfrESsp,tblr,kbl);
``` 

```{r tbl.EmpSelFcnsFemales}
#| results: asis
  cap = 'Annual empirical selectivity functions for the NMFS gear for females from the SBS studies, by 5-mm size bin. "NaN" indicates size bins where the BSFRF gear caught no females (i.e., the size composition was 0). Values in the "fit" and "se" columns were derived by fitting a generalized additive model in size to the estimates from all years simultaneously, weighted by the total number of females sampled by size bin for each year.'
  dfrESsp = dplyr::bind_rows(
             dfrESs |> dplyr::filter(x=="female") |> dplyr::mutate(y=as.character(y)) |>
               dplyr::select(year=y,size=z,emp_sel),
             mdlESFs$prd |> dplyr::mutate(y="fit") |> 
               dplyr::select(year=y,size=z,emp_sel=fit),
             mdlESFs$prd |> dplyr::mutate(y="se") |> 
               dplyr::select(year=y,size=z,emp_sel=`se.fit`)
            );
  tblr = tabular(Factor(size)~Factor(year)*emp_sel*sum*Format(formatC(digits=3,format="f")),
                 data=dfrESsp);
  colLabels(tblr) = colLabels(tblr)[c(2),];
  kbl = tblr |> wtsQMD::convert_tblr_to_kbl(c(1,7),
                                            isPDF=wtsQMD::isOutputPDF());
  lstTbls = c(lstTbls,
              insertKblIntoQMD(kbl,
                               lbl="tbl-EmpSelFcnsFemales", 
                               cap=cap,
                               ori="P"));
  rm(dfrESsp,tblr,kbl);
``` 

```{r}
#| label: fig-EmpSelFcns-Annual
#| fig-cap: "Annual empirical estimates of survey selectivity (colored lines, points). Annual estimates above 1.5 are capped to better show overall detail. Point size reflects the total number of crab across both gear types that were sampled within the corresponding size bin. The black line (fit) and grey shading (90% confidence interval) reflect sex-specific fits using a generalized additive model (GAM) to fit a single smooth function of size to the empirical estimates."
  tmp = dfrESPs |> dplyr::filter((n>9)||is.na(n));
  tmp$y = factor(tmp$y)
  p1 = ggplot(data=tmp |> dplyr::filter(type=="observed"),
              mapping=aes(x=z,y=emp_sel,colour=y)) +
         geom_point(aes(size=n)) + scale_size_area() + 
         geom_line() +
         #geom_smooth(mapping=aes(x=z,y=emp_sel),method="gam",inherit.aes = FALSE) +
         geom_line(data=tmp |> dplyr::filter(type=="fit"),
                   mapping=aes(x=z,y=fit),inherit.aes=FALSE) + 
         geom_ribbon(data=tmp |> dplyr::filter(type=="fit"),
                   mapping=aes(x=z,ymin=lci,ymax=uci),alpha=0.3,inherit.aes=FALSE) + 
         geom_hline(yintercept=0.5,linetype=3) + 
         facet_grid(rows = x~.,scales = "free_y") + 
         scale_y_continuous(limits=c(0,1.5),oob=scales::squish) + 
         labs(x="size (mm CW)",y="empirical\nselectivity",
              colour="study\nyear",size="crab\nsampled") + 
         # wtsPlots::getStdTheme() + 
         theme(legend.position=c(0.99,0.99),
               legend.justification=c(1,1),
               legend.byrow=TRUE,
               legend.box="horizontal");
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p1));
  rm(tmp,p1);
```

```{r}
#| label: fig-EmpSelFcns-Smooths
#| fig-cap: Overlay of the sex-specific smooth functions for NMFS empirical selectivity estimated from the annual estimates (shown in the previous figure).
  tmp = dfrESPs |> dplyr::filter((n>9)||is.na(n));
  tmp$y = factor(tmp$y)
  p1 = ggplot(data=tmp |> dplyr::filter(type=="fit"),
              mapping=aes(x=z,y=fit,colour=x,fill=x)) +
         geom_line() +
         geom_ribbon(mapping=aes(ymin=lci,ymax=uci),alpha=0.3,inherit.aes=TRUE) + 
         geom_hline(yintercept=0.5,linetype=3) + 
         scale_y_continuous(limits=c(0,1.0),oob=scales::squish) + 
         labs(x="size (mm CW)",
              y="smooth fits to empirical\nselectivity",
              colour="sex",fill="sex") + 
         theme(legend.position=c(0.01,0.99),
               legend.justification=c(0,1),
               legend.byrow=TRUE,
               legend.box="horizontal");
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p1));
  rm(tmp,p1);
```

<!-- references -->
```{r refs_EmpSel,eval=!knitr::opts_knit$get("child")&(!isPDF),results='asis'}
  cat("# References {-}\n");
  cat("::: {#refs}\n");
  cat(":::\n\n");
```

<!-- tables, if not child doc and lstTbls is not empty -->
```{r}
#| label: tables_EmpSel
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printTablesSectionFromList.R",package="wtsQMD"));
```

<!-- figures, if not child doc and lstFigs is not empty -->
```{r}
#| label: figures_EmpSel
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printFiguresSectionFromList.R",package="wtsQMD"));
```
