require(dplyr);
require(magrittr);
require(tables);
tmp  = dfrZCs %>% group_by(fleet,y,x) %>%
summarize(totN=wtsUtilities::Sum(n)) %>%
ungroup();
View(tmp)
#--create table of numbers of crab sampled, by year, sex, and gear
require(dplyr);
require(magrittr);
require(tables);
tmp  = dfrZCs %>% group_by(fleet,y,x) %>%
summarize(totN=wtsUtilities::Sum(n)) %>%
ungroup();
tbl = tables::tabular(Heading("year")*Factor(y)~
Heading("sex")*Factor(x)*(
Heading("group")*Factor(fleet)*wtsUtilities::Sum
),data=tmp);
tbl
tables::tabular(Heading("year")*Factor(y)~
Heading("sex")*Factor(x)*(
Heading("group")*Factor(fleet)*totN*wtsUtilities::Sum
),data=tmp);
tables::tabular(Heading("year")*Factor(y,name="year")~
Factor(x,name="sex")*(
Heading("group")*Factor(fleet)*totN*wtsUtilities::Sum
),data=tmp);
colLabels(tbl)
colLabels(tbl) = colLabels(tbl)[c(2,4)];
tbl
tbl = tables::tabular(Heading("year")*Factor(y,name="year")~
Factor(x,name="sex")*(
Heading("group")*Factor(fleet)*totN*wtsUtilities::Sum
),data=tmp);
colLabels(tbl) = colLabels(tbl)[c(2,4)];
tbl
library(tidyr)
tmp  = dfrZCs %>% group_by(fleet,y,x) %>%
summarize(totN=wtsUtilities::Sum(n),totA=wtsUtilities::Sum(val)) %>%
ungroup() %>%
pivot_longer(cols=totN,totA,names_to="type");
tmp  = dfrZCs %>% group_by(fleet,y,x) %>%
summarize(totN=wtsUtilities::Sum(n),
totA=wtsUtilities::Sum(val)) %>%
ungroup() %>%
pivot_longer(cols=c("totN","totA"),names_to="type");
tbl = tables::tabular(Heading("year")*Factor(y,name="year")~
Factor(type)*
Factor(x,name="sex")*(
Heading("group")*Factor(fleet)*totN*wtsUtilities::Sum
),data=tmp);
tbl = tables::tabular(Heading("year")*Factor(y,name="year")~
Factor(type)*
Factor(x,name="sex")*(
Heading("group")*Factor(fleet)*value*wtsUtilities::Sum
),data=tmp);
colLabels(tbl)
tmp  = dfrZCs %>% group_by(fleet,y,x) %>%
summarize(`number sampled`=wtsUtilities::Sum(n),
`total abundance`=wtsUtilities::Sum(val)) %>%
ungroup() %>%
pivot_longer(cols=c("number sampled","total abundance"),names_to="type");
tbl = tables::tabular(Heading("year")*Factor(y,name="year")~
Factor(type)*
Factor(x,name="sex")*(
Heading("group")*Factor(fleet)*value*wtsUtilities::Sum
),data=tmp);
colLabels(tbl)
colLabels(tbl) = colLabels(tbl)[c(2,4,6)];
tbl
write.csv.tabular(tbl,file="SBS_Summary.csv");
View(dfrESs)
x=1
lstMods<-list();
#----fit models by sex
sexes<-c("male","female");
mxZs <-c(180,   120);     #--need one for each sex
nXs<-length(sexes);
sex<-sexes[x]; mxZ<-mxZs[x];
dfrESsp<-dfrESs[(dfrESs$x==sex)&(dfrESs$z<=mxZ),];
dfrESsp$yf<-factor(dfrESsp$y);
dfrESsp$zf<-factor(dfrESsp$z);
View(dfrESs)
#--fit models to "observed" catchability
#----list for models
lstMods<-list();
#----fit models by sex
sexes<-c("male","female");
mxZs <-c(180,   120);     #--need one for each sex
nXs<-length(sexes);
for (x in 1:nXs){
sex<-sexes[x]; mxZ<-mxZs[x];
dfrESsp<-dfrESs[(dfrESs$x==sex)&(dfrESs$z<=mxZ),];
dfrESsp$yf<-factor(dfrESsp$y);
dfrESsp$zf<-factor(dfrESsp$z);
dfrESsp$p<-dfrESsp$NMFS/(dfrESsp$NMFS+dfrESsp$BSFRF);
dfrESsp$w = dfrESsp$n_BSFRF + dfrESsp$n_NMFS/mean(dfrESsp$n_BSFRF + dfrESsp$n_NMFS);
#----emp_avail: gaussian with log link
nm<-paste0(sex,": annual");
lstMods[[nm]]<-gam(emp_sel~ yf+s(z,bs="cs",by=yf), data=dfrESsp,family=gaussian(link="log"));
#----emp_avail: gaussian with log link
nm<-paste0(sex,": aggregated");
lstMods[[nm]]<-gam(emp_sel~ s(z,bs="cs"), data=dfrESsp,family=gaussian(link="log"));
}
#--calculate statistics for empirical selectivity functions
load("EmpiricalSelectivityFromData.RData")
#--fit with smooth models
library(mgcv);
#----function to do model diagnostics
doDiagnostics<-function(mod){
summary(mod);
plot(mod,page=1);
gam.check(mod);
}
#----function to calculate estimates from model
calcEstimates<-function(mod,zs,yfs){
dfrPrd<-data.frame(z=rep(zs,length(yfs)),yf=rep(yfs,each=length(zs)));
prd<-predict(mod,dfrPrd,type="response",se.fit=TRUE);
cis<-wtsUtilities::calcCIs(prd$fit,sdvs=prd$se.fit,pdfType="lognormal",ci=0.8);
dfrPrdRes<-cbind(dfrPrd,fit=prd$fit,se=prd$se.fit,lci=cis$lci,uci=cis$uci);
dfrPrdRes$yf<-factor(dfrPrdRes$yf);
return(dfrPrdRes);
}
#----function to plot estimates from model
plotEstimates<-function(dfrPrdSel,nm){
pl<-wtsPlots::plotMDFR.XY(dfrPrdSel,x="z",value.var="fit",colour="yf",facet_grid="yf~.",ylim=c(0,1.2),plotLines=TRUE,plotPoints=FALSE,showPlot=FALSE)
pl<-pl + ggplot2::geom_ribbon(mapping=ggplot2::aes_string(ymin="lci",ymax="uci"),alpha=0.4,fill="grey");
pl<-pl + ggplot2::labs(x="size (mm CW)",y="empirical selectivity");
pl<-pl + ggplot2::ggtitle(nm);
print(pl);
}
#--fit models to "observed" catchability
#----list for models
lstMods<-list();
#----fit models by sex
sexes<-c("male","female");
mxZs <-c(180,   120);     #--need one for each sex
nXs<-length(sexes);
for (x in 1:nXs){
sex<-sexes[x]; mxZ<-mxZs[x];
dfrESsp<-dfrESs[(dfrESs$x==sex)&(dfrESs$z<=mxZ),];
dfrESsp$yf<-factor(dfrESsp$y);
dfrESsp$zf<-factor(dfrESsp$z);
dfrESsp$p<-dfrESsp$NMFS/(dfrESsp$NMFS+dfrESsp$BSFRF);
dfrESsp$w = dfrESsp$n_BSFRF + dfrESsp$n_NMFS/mean(dfrESsp$n_BSFRF + dfrESsp$n_NMFS);
#----emp_avail: gaussian with log link
nm<-paste0(sex,": annual");
lstMods[[nm]]<-gam(emp_sel~ yf+s(z,bs="cs",by=yf), data=dfrESsp,family=gaussian(link="log"));
#----emp_avail: gaussian with log link
nm<-paste0(sex,": aggregated");
lstMods[[nm]]<-gam(emp_sel~ s(z,bs="cs"), data=dfrESsp,family=gaussian(link="log"));
}
lstMods
lstMods<-list();
#----fit models by sex
sexes<-c("male","female");
mxZs <-c(180,   120);     #--need one for each sex
nXs<-length(sexes);
for (x in 1:nXs){
sex<-sexes[x]; mxZ<-mxZs[x];
dfrESsp<-dfrESs[(dfrESs$x==sex)&(dfrESs$z<=mxZ),];
dfrESsp$yf<-factor(dfrESsp$y);
dfrESsp$zf<-factor(dfrESsp$z);
dfrESsp$p<-dfrESsp$NMFS/(dfrESsp$NMFS+dfrESsp$BSFRF);
dfrESsp$w = dfrESsp$n_BSFRF + dfrESsp$n_NMFS/mean(dfrESsp$n_BSFRF + dfrESsp$n_NMFS);
#----emp_avail: gaussian with log link
nm<-paste0(sex,": annual");
lstMods[[nm]]<-gam(emp_sel~ yf+s(z,bs="cs",by=yf), weights=w, data=dfrESsp,family=gaussian(link="log"));
#----emp_avail: gaussian with log link
nm<-paste0(sex,": aggregated");
lstMods[[nm]]<-gam(emp_sel~ s(z,bs="cs"), weights=w, data=dfrESsp,family=gaussian(link="log"));
}
x=1
#--get model estimate of selectivity
yfs<-c(2013:2017);
zs<-seq(25,mxZs[x],by=5);
#--annnual model
nm <-paste0(sexes[x],": annual")
tmp<-calcEstimates(lstMods[[nm]],zs,yfs);
View(tmp)
tmp$z<-tmp$z+2;#--match z's in assessment
tmp$model_name<-nm;
plotEstimates(tmp,nm);
plotEstimates<-function(dfrPrdSel,nm){
pl<-wtsPlots::plotMDFR.XY(dfrPrdSel,x="z",value.var="fit",colour="yf",facet_grid="yf~.",ylim=c(0,1.2),plotLines=TRUE,plotPoints=FALSE,showPlot=FALSE)
pl<-pl + ggplot2::geom_ribbon(mapping=ggplot2::aes_string(ymin="lci",ymax="uci"),alpha=0.4,fill="grey");
pl<-pl + ggplot2::labs(x="size (mm CW)",y="empirical selectivity");
pl<-pl + ggplot2::ggtitle(nm);
return(pl);
}
pl = plotEstimates(tmp,nm);
View(tmp)
pl + geom_point(data=dfrESs %>% subset(x==sex),mapping=aes_string(x="z",y="emp_sel"))
dfrESsp<-dfrESs[(dfrESs$x==sex)&(dfrESs$z<=mxZ),];
dfrESsp$yf<-factor(dfrESsp$y);
dfrESsp$zf<-factor(dfrESsp$z);
dfrESsp$p<-dfrESsp$NMFS/(dfrESsp$NMFS+dfrESsp$BSFRF);
dfrESsp$w = dfrESsp$n_BSFRF + dfrESsp$n_NMFS/mean(dfrESsp$n_BSFRF + dfrESsp$n_NMFS);
pl + geom_point(data=dfrESsp %>% subset(x==sex),mapping=aes_string(x="z",y="emp_sel"))
sex=sexes[1]
pl + geom_point(data=dfrESsp %>% subset(x==sex),mapping=aes_string(x="z",y="emp_sel",size=w))
pl + geom_point(data=dfrESsp %>% subset(x==sex),mapping=aes_string(x="z",y="emp_sel",size="w"))
View(dfrESsp)
mdl = lstMods[[nm]];
View(mdl)
mdl$model
View(dfrESs)
x_=1
require(magrittr)
sex<-sexes[x_]; mxZ<-mxZs[x_];
dfrESsp = dfrESs %>% subset((x==sexes[x_])&(z<=mxZs[x_])) %>%
dplyr::mutate(yf=factor(y),zf<-factor(z),p<-NMFS/(NMFS+BSFRF)) %>%
dplyr::group_by(type,y,x) %>%
dplyr::mutate(w=(n_BSFRF + n_NMFS)/mean(n_BSFRF + n_NMFS));
View(dfrESsp)
dfrESsp = dfrESs %>% subset((x==sexes[x_])&(z<=mxZs[x_])) %>%
dplyr::mutate(yf=factor(y),zf=factor(z),p=NMFS/(NMFS+BSFRF)) %>%
dplyr::group_by(type,y,x) %>%
dplyr::mutate(w=(n_BSFRF + n_NMFS)/mean(n_BSFRF + n_NMFS));
dplyr::ungroup();
dfrESsp = dfrESs %>% subset((x==sexes[x_])&(z<=mxZs[x_])) %>%
dplyr::mutate(yf=factor(y),zf=factor(z),p=NMFS/(NMFS+BSFRF)) %>%
dplyr::group_by(type,y,x) %>%
dplyr::mutate(w=(n_BSFRF + n_NMFS)/mean(n_BSFRF + n_NMFS)) %>%
dplyr::ungroup();
#--fit models to "observed" catchability
#----list for models
lstMods<-list();
#----fit models by sex
sexes<-c("male","female");
mxZs <-c(180,   120);     #--need one for each sex
nXs<-length(sexes);
for (x_ in 1:nXs){
sex<-sexes[x_]; mxZ<-mxZs[x_];
dfrESsp = dfrESs %>% subset((x==sexes[x_])&(z<=mxZs[x_])) %>%
dplyr::mutate(yf=factor(y),zf=factor(z),p=NMFS/(NMFS+BSFRF)) %>%
dplyr::group_by(type,y,x) %>%
dplyr::mutate(w=(n_BSFRF + n_NMFS)/mean(n_BSFRF + n_NMFS)) %>%
dplyr::ungroup();
#----emp_avail: gaussian with log link
nm<-paste0(sex,": annual");
lstMods[[nm]]<-gam(emp_sel~ yf+s(z,bs="cs",by=yf), weights=w, data=dfrESsp,family=gaussian(link="log"));
#----emp_avail: gaussian with log link
nm<-paste0(sex,": aggregated");
lstMods[[nm]]<-gam(emp_sel~ s(z,bs="cs"), weights=w, data=dfrESsp,family=gaussian(link="log"));
}
#--get model estimate of selectivity
yfs<-c(2013:2017);
dfrModEsts<-NULL;
x_=1
zs<-seq(25,mxZs[x_],by=5);
#--annnual model
nm <-paste0(sexes[x_],": annual")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],": annual")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
pl = plotEstimates(tmp,nm);
pl + geom_point(data=mdl$model,mapping=aes_string(x="z",y="emp_sel",size="(weights)"))
View(tmp)
plotEstimates(tmp,nm);
pl + geom_point(data=mdl$model,mapping=aes_string(x="z",y="emp_sel",size="(weights)"))
data=mdl$model
View(data)
str(data)
#--fit with smooth models
library(ggplot2)
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],": annual")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
plt
plt + ggplot2::geom_point(data=mdl$model,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="(weights)"))
data=mdl$model;
ggplot()+geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="(weights)"));
rlang::last_error()
names(data)
data[["(weights)"]]
data=mdl$model %>% mutate(w=`(weights)`);
plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w"));
plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],"s: annual fits")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p1 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
#--get model estimate of selectivity
yfs<-c(2013:2017);
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],"s: annual fits")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p1 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
lstMods<-list();
#----fit models by sex
sexes<-c("male","female");
mxZs <-c(180,   120);     #--need one for each sex
nXs<-length(sexes);
for (x_ in 1:nXs){
sex<-sexes[x_]; mxZ<-mxZs[x_];
#----emp_avail: gaussian with log link + annual fits
dfrESsp = dfrESs %>% subset((x==sexes[x_])&(z<=mxZs[x_])) %>%
dplyr::mutate(yf=factor(y),zf=factor(z),p=NMFS/(NMFS+BSFRF)) %>%
dplyr::group_by(type,y,x) %>%
dplyr::mutate(w=(n_BSFRF + n_NMFS)/mean(n_BSFRF + n_NMFS)) %>%
dplyr::ungroup();
nm<-paste0(sex,"s: annual fits");
lstMods[[nm]]<-gam(emp_sel~ yf+s(z,bs="cs",by=yf), weights=w, data=dfrESsp,family=gaussian(link="log"));
#----emp_avail: gaussian with log link + aggregated fit
dfrESsp = dfrESs %>% subset((x==sexes[x_])&(z<=mxZs[x_])) %>%
dplyr::mutate(zf=factor(z),p=NMFS/(NMFS+BSFRF)) %>%
dplyr::group_by(type,x) %>%
dplyr::mutate(w=(n_BSFRF + n_NMFS)/mean(n_BSFRF + n_NMFS)) %>%
dplyr::ungroup();
nm<-paste0(sex,"s: aggregated fit");
lstMods[[nm]]<-gam(emp_sel~ s(z,bs="cs"), weights=w, data=dfrESsp,family=gaussian(link="log"));
}
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],"s: annual fits")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p1 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
nm <-paste0(sexes[x_],"s: aggregated fits")
mdl = lstMods[[nm]];
tmp<-calcEstimates(lstMods[[nm]],zs,sexes[x]);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p2 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
nm <-paste0(sexes[x_],"s: aggregated fit")
mdl = lstMods[[nm]];
tmp<-calcEstimates(lstMods[[nm]],zs,sexes[x]);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p2 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
ggpubr::ggarrange(p1,p2,ncol=1,heights=c(4,1))
plt
View(tmp)
nm <-paste0(sexes[x_],"s: aggregated fit")
mdl = lstMods[[nm]];
tmp<-calcEstimates(lstMods[[nm]],zs," ");
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
plt
data=mdl$model %>% mutate(w=`(weights)`,yf=" ");
p2 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight")
p2
ggpubr::ggarrange(p1,p2,ncol=1,heights=c(4,1))
pg = ggpubr::ggarrange(p1,p2,ncol=1,heights=c(4,2))
pg
plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="empirical",size="relative\nweight",title = NULL)
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],"s: annual fits")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p1 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight",title=NULL);
tmp$z<-tmp$z+2;#--match z's in assessment
dfrModEsts<-rbind(dfrModEsts,tmp);
#--aggregated model
nm <-paste0(sexes[x_],"s: aggregated fit")
mdl = lstMods[[nm]];
tmp<-calcEstimates(lstMods[[nm]],zs," ");
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`,yf=" ");
p2 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="empirical",size="relative\nweight",title = NULL);
tmp$z<-tmp$z+2;#--match z's in assessment
dfrModEsts<-rbind(dfrModEsts,tmp);
ggpubr::ggarrange(p1,p2,ncol=1,heights=c(4,2))
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/01_Empirical_Selectivity/step2c.FitEmpiricalSelectivityFromData.R')
rm(x,sex,dfrESsp,nm);
#--get model estimate of selectivity
yfs<-c(2013:2017);
dfrModEsts<-NULL;
for (x_ in 1:nXs){
sex = sexes[x_];
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm <-paste0(sexes[x_],"s: annual fits")
mdl = lstMods[[nm]];
tmp<-calcEstimates(mdl,zs,yfs);
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`);
p1 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight",title=NULL);
tmp$z<-tmp$z+2;#--match z's in assessment
dfrModEsts<-rbind(dfrModEsts,tmp);
#--aggregated model
nm <-paste0(sexes[x_],"s: aggregated fit")
mdl = lstMods[[nm]];
tmp<-calcEstimates(lstMods[[nm]],zs," ");
tmp$model_name<-nm;
plt = plotEstimates(tmp,nm);
data=mdl$model %>% mutate(w=`(weights)`,yf=" ");
p2 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="empirical",size="relative\nweight",title = NULL);
tmp$z<-tmp$z+2;#--match z's in assessment
dfrModEsts<-rbind(dfrModEsts,tmp);
pg = ggpubr::ggarrange(p1,p2,ncol=1,heights=c(4,2));
print(pg);
ggplot2::ggsave(paste0("EstimatedEmpiricalSelectivityFromData.",sex,"s.pdf"),pg,width=6.5,height=8)
}
wtsUtilities::saveObj(dfrModEsts,"dfrModEsts.RData");
broom::tidy(lstMods[[1]])
broom::tidy(lstMods[[2]])
summary(lstMods[[2]])
glance(lstMods[[2]])
broom::glance(lstMods[[2]])
broom::glance(lstMods[[1]])
AIC(lstMods[1:2])
AIC(lstMods[[1]],lstMods[[2]])
nm <-paste0(sexes[x_],"s: annual fits")
mdl1 = lstMods[[nm]];
nm <-paste0(sexes[x_],"s: aggregated fit")
mdl2 = lstMods[[nm]];
r = AIC(mdl1,mdl2)
r
View(mdl1)
print(mdl1)
summary(mdl1)
1.36/5.41
modDiags = cbind(mdl=c(nm1,nm2),AIC(mdl1,mdl2),BIC(mdl1,mdl2),"deviance explained"=c(1-mdl1$deviance/mdl1$null.deviance,1-md21$deviance/mdl2$null.deviance));
#--annual model
nm1 <-paste0(sexes[x_],"s: annual fits")
#--aggregated model
nm2 <-paste0(sexes[x_],"s: aggregated fit")
modDiags = cbind(mdl=c(nm1,nm2),AIC(mdl1,mdl2),BIC(mdl1,mdl2),"deviance explained"=c(1-mdl1$deviance/mdl1$null.deviance,1-md21$deviance/mdl2$null.deviance));
modDiags = cbind(mdl=c(nm1,nm2),AIC(mdl1,mdl2),BIC(mdl1,mdl2),"deviance explained"=c(1-mdl1$deviance/mdl1$null.deviance,1-mdl2$deviance/mdl2$null.deviance));
modDiags
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/01_Empirical_Selectivity/step2c.FitEmpiricalSelectivityFromData.R')
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/01_Empirical_Selectivity/step2c.FitEmpiricalSelectivityFromData.R')
traceback()
plt
plt1
p1
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/01_Empirical_Selectivity/step2c.FitEmpiricalSelectivityFromData.R')
#--get model estimate of selectivity
yfs<-c(2013:2017);
dfrModEsts<-NULL;
for (x_ in 1:nXs){
sex = sexes[x_];
zs<-seq(25,mxZs[x_],by=5);
#--annual model
nm1 <-paste0(sexes[x_],"s: annual fits")
mdl1 = lstMods[[nm1]];
tmp<-calcEstimates(mdl1,zs,yfs);
tmp$model_name<-nm1;
plt = plotEstimates(tmp,nm1);
data=mdl1$model %>% mutate(w=`(weights)`);
p1 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="year",size="relative\nweight",title=NULL);
tmp$z<-tmp$z+2;#--match z's in assessment
dfrModEsts<-rbind(dfrModEsts,tmp);
#--aggregated model
nm2 <-paste0(sexes[x_],"s: aggregated fit")
mdl2 = lstMods[[nm2]];
tmp<-calcEstimates(mdl2,zs," ");
tmp$model_name<-nm2;
plt = plotEstimates(tmp,nm2);
data=mdl2$model %>% mutate(w=`(weights)`,yf=" ");
p2 = plt + ggplot2::geom_point(data=data,mapping=ggplot2::aes_string(x="z",y="emp_sel",size="w")) +
ggplot2::labs(colour="empirical",size="relative\nweight",title = NULL);
tmp$z<-tmp$z+2;#--match z's in assessment
dfrModEsts<-rbind(dfrModEsts,tmp);
pg = ggpubr::ggarrange(p1,p2,ncol=1,heights=c(4,2));
print(pg);
ggplot2::ggsave(paste0("EstimatedEmpiricalSelectivityFromData.",sex,"s.pdf"),pg,width=6.5,height=8);
modDiags = cbind(model=c(nm1,nm2),AIC(mdl1,mdl2),BIC(mdl1,mdl2)[,2],
"% deviance explained"=100*c(1-mdl1$deviance/mdl1$null.deviance,
1-mdl2$deviance/mdl2$null.deviance));
readr::write_csv(modDiags,file = paste0("ModelDiagnostics.",sex,".csv"));
#rm(sex,zs,nm1,mdl1,tmp,plt,nm2,mdl2,pg)
}
wtsUtilities::saveObj(dfrModEsts,"dfrModEsts.RData");
citation("mgcv")
citation("R")
citation()
