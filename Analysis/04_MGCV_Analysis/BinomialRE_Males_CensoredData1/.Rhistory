install.packages("tidyverse")
install.packages("sf")
install.packages("sf")
install.packages("TMB")
install.packages("tmap")
install.packages("tmaptools")
install.packages("mgcv")
14.93/(2*12.72)
require(ggplot2);
require(magrittr);
require(sf);
require(wtsGIS);
land = wtsGIS::getPackagedLayer("Alaska");
load("~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/sf_eastBS_polys.RData")
p=ggplot()+geom_sf(data=sf_eastBS_polys %>% subset(depth_bin>-500),mapping=aes(fill=depth_bin),colour=NA);
print(p)
sf_eastBS_polys
sf_eastBSshelf_polys = sf_eastBS_polys %>% subset(depth_bin>-500);
sf_eastBS_env = sf::st_union(sf_eastBS_polys);    #--possibly leaves holes
ggplot()+geom_sf(data=sf_eastBS_env);
View(sf_eastBS_env)
View(sf_eastBS_polys)
load("~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/sf_ETOPO_polys.RData");
View(sf_ETOPO_polys)
sf_ETOPO_polys$depth_bin
sf_ETOPO_polys %<>% subset(!is.na(depth_bin));#--remove unclassified area
ggplot()+geom_sf(data=sf_ETOPO_polys,mapping=aes(fill=depth_bin),colour=NA);
sf::st_write(sf_ETOPO_polys,
"~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/ETOPO1_NorthPacificBathymetryBinned.shp",append=FALSE);
save(sf_ETOPO_polys,file="~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/sf_ETOPO_polys.RData");
sf_eastBS_polys$depth_bin
bbox<-wtsGIS::getBBox(sf_ETOPO_polys);
bbox[1:4] = c(180,53,206,65);#--set western edge of bbox to 180 deg W (not always IDL, unfortunately)
sf_eastBS_polys = wtsGIS::cropFeaturesToBBox(sf_ETOPO_polys,bbox);
sf_eastBS_polys$depth_bin
ggplot()+geom_sf(data=sf_eastBS_polys,colour=NA);
ggplot()+geom_sf(data=sf_eastBS_polys,colour=NA,fill="dark grey");
ggplot()+geom_sf(data=sf_eastBS_polys,mapping=aes(fill=depth_bin),colour=NA);
sf::st_write(sf_eastBS_polys,
"~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/ETOPO1_EasternBeringSeaBathymetryBinned.shp",append=FALSE);
save(sf_eastBS_polys,file="~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/sf_eastBS_polys.RData");
sf_eastBS_env = sf::st_union(sf_eastBS_polys);    #--possibly leaves holes, includes part of GOA
ggplot()+geom_sf(data=sf_eastBS_env);
bbox[1:4] = c(180,53,203.5,65);#--set western edge of bbox to 180 deg W (not always IDL, unfortunately)
sf_eastBS_polys = wtsGIS::cropFeaturesToBBox(sf_ETOPO_polys,bbox);
ggplot()+geom_sf(data=sf_eastBS_polys,mapping=aes(fill=depth_bin),colour=NA);
sf::st_write(sf_eastBS_polys,
"~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/ETOPO1_EasternBeringSeaBathymetryBinned.shp",append=FALSE);
save(sf_eastBS_polys,file="~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/sf_eastBS_polys.RData");
#----create envelope
sf_eastBS_env = sf::st_union(sf_eastBS_polys);    #--possibly leaves holes, includes part of GOA
ggplot()+geom_sf(data=sf_eastBS_env,fill="dark grey",colour="red");
sf::st_write(sf_eastBS_env,
"~/Work/Projects/MapData/EBS/Bathymetry/ETOPO1_NorthPacific/ETOPO1_EasternBeringSeaEnvelope.shp",append=FALSE);
#--compare models
require(rCompTCMs);
require(rTCSAM02);
#-load models to compare
models<-list();
topDir = "~/Work/StockAssessments-Crab/Assessments/TannerCrab/2021-05_TannerCrab";
cases<-rbind(tibble::tibble(case="20.07",file=file.path(topDir,"ModelRuns/01_NewADMB/20.07.00.ADMB12p3/Results.RData")),
tibble::tibble(case="21.02",file=file.path(topDir,"ModelRuns/21.02.ExpQsFixedLgtRets/Results.RData")));
tibble::tibble(case="21.03",file=file.path(topDir,"ModelRuns/21.01.Lognormal/Results.RData")));
for (rw in 1:nrow(cases)){
models[[cases$case[rw]]]<-wtsUtilities::getObj(cases$file[rw]);
}
compare<-names(models);
#--compare models
require(rCompTCMs);
require(rTCSAM02);
#-load models to compare
models<-list();
topDir = "~/Work/StockAssessments-Crab/Assessments/TannerCrab/2021-05_TannerCrab";
cases<-rbind(tibble::tibble(case="20.07",file=file.path(topDir,"ModelRuns/01_NewADMB/20.07.00.ADMB12p3/Results.RData")),
tibble::tibble(case="21.02",file=file.path(topDir,"ModelRuns/21.02.ExpQsFixedLgtRets/Results.RData")),
tibble::tibble(case="21.03",file=file.path(topDir,"ModelRuns/21.01.Lognormal/Results.RData")));
for (rw in 1:nrow(cases)){
models[[cases$case[rw]]]<-wtsUtilities::getObj(cases$file[rw]);
}
compare<-names(models);
rCompTCMs::compareResults.Surveys.CaptureProbs(models[compare],singlePlot=TRUE,
dodge=0,years=c(1981,2018));
rCompTCMs::compareResults.Fisheries.SelFcns(models[compare],fleets="TCF",singlePlot=TRUE,
dodge=0,years=c(1990,2013:2018))
rCompTCMs::compareResults.Fisheries.SelFcns(models[compare],fleets="SCF",singlePlot=TRUE,
dodge=0,years=c(1990,2000,2015))
rCompTCMs::compareFits.BiomassData(models[compare],fleet.type="survey",catch.type="index",
plot1stObs=TRUE,numRecent=30)
rCompTCMs::compareFits.BiomassData(models[compare],fleet.type="fishery",catch.type="retained",
fishery.pdfType = "lognormal",
plot1stObs=FALSE,numRecent=20)
rCompTCMs::compareFits.BiomassData(models[compare],fleet.type="fishery",catch.type="total",
fishery.pdfType = "lognormal",
plot1stObs=FALSE,numRecent=20)
compareFits.SizeComps(models[compare],fleets="SCF",
fleet.type="fishery",catch.type="total",
plot1stObs=TRUE);
rCompTCMs::compareFits.MeanSizeComps(models[compare],
fleet.type="fishery",catch.type="total",
plot1stObs=TRUE);
rCompTCMs::compareFits.GrowthData(models[compare],
dodge=0,
plot1stObs=TRUE);
rCompTCMs::compareResults.Pop.PrM2M(models[compare],dodge=0)
rCompTCMs::compareResults.Pop.MatureBiomass(models[compare],dodge=0,numRecent=30)
rCompTCMs::compareResults.Pop.Recruitment(models[compare],dodge=0,numRecent=30)
rCompTCMs::compareResults.Pop.NaturalMortality.BarPlot(models[compare]);
setwd("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/BinomialRE_Females_CensoredData1")
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/BinomialRE_Females_CensoredData1/step4b.PlotSurveySpecificSelectivities.R')
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/BinomialRE_Females_CensoredData1/step4b.PlotSurveySpecificSelectivities.R')
#--plot model results
#--load required packages
require(dplyr);
require(ggplot2);
require(magrittr);
require(mgcv);
require(mgcViz);
#--other required packages
#----ggdist
#----wtsUtilities
#--get model results
x = "MALE"; maxZ = 180;
mdl = wtsUtilities::getObj(paste0("./results_RData/selModels.BinomRE.Best.",tolower(x),"s.RData"));
#--get original data used in model fit
dfrDat = wtsUtilities::getObj("./results_RData/dfrDatRE.RData");
#--set up plotting output
device = "png";
pltctr = 1;
plotFN<-function(n,dev=device){paste0("plots3c_females_",wtsUtilities::formatZeros(n),".",dev)}
#--set up covariates for predictions
grd_z = seq(5,maxZ,5)+2.5; med_z = 77.5;
med_d = median(dfrDat$d,na.rm=TRUE); rng_d = range(dfrDat$d,na.rm=TRUE); grd_d = seq(from=rng_d[1],rng_d[2],length.out=50);
med_t = median(dfrDat$t,na.rm=TRUE); rng_t = range(dfrDat$t,na.rm=TRUE); grd_t = seq(from=rng_t[1],rng_t[2],length.out=50);
med_f = median(dfrDat$f,na.rm=TRUE); rng_f = range(dfrDat$f,na.rm=TRUE); grd_f = seq(from=rng_f[1],rng_f[2],length.out=50);
med_s = median(dfrDat$s,na.rm=TRUE); rng_s = range(dfrDat$s,na.rm=TRUE); grd_s = seq(from=rng_s[1],rng_s[2],length.out=50);
grds = list(z=grd_z,d=grd_d,t=grd_t,f=grd_f,s=grd_s);
newDFR<-function(vars,grds){
#str = paste0(vars,"=grds[['",vars,"']]",collapse=",")
gnms = names(grds);
for (i in 1:length(gnms)){
var = gnms[i];
if (i==1){
if (var %in% vars)
{str = paste0(var,"=grds[['",var,"']]");}
else
{str = paste0(var,"=NA");}
} else {
if (var %in% vars)
{str = paste0(str,",",var,"=grds[['",var,"']]");}
else
{str = paste0(str,",",var,"=NA");}
}
}
eval(parse(text=paste0("dfrPrd1 = tidyr::expand_grid(",str,")")));
return(dfrPrd1);
}
#--get model intercept
int = mdl$coefficients[1];
#--get model smooths
smths = mdl$smooth;
ns    = length(smths);
setwd("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/BinomialRE_Males_CensoredData1")
#--plot model results
#--load required packages
require(dplyr);
require(ggplot2);
require(magrittr);
require(mgcv);
require(mgcViz);
#--other required packages
#----ggdist
#----wtsUtilities
#--get model results
x = "MALE"; maxZ = 180;
mdl = wtsUtilities::getObj(paste0("./results_RData/selModels.BinomRE.Best.",tolower(x),"s.RData"));
#--get original data used in model fit
dfrDat = wtsUtilities::getObj("./results_RData/dfrDatRE.RData");
#--set up plotting output
device = "png";
pltctr = 1;
plotFN<-function(n,dev=device){paste0("plots3c_females_",wtsUtilities::formatZeros(n),".",dev)}
#--set up covariates for predictions
grd_z = seq(5,maxZ,5)+2.5; med_z = 77.5;
med_d = median(dfrDat$d,na.rm=TRUE); rng_d = range(dfrDat$d,na.rm=TRUE); grd_d = seq(from=rng_d[1],rng_d[2],length.out=50);
med_t = median(dfrDat$t,na.rm=TRUE); rng_t = range(dfrDat$t,na.rm=TRUE); grd_t = seq(from=rng_t[1],rng_t[2],length.out=50);
med_f = median(dfrDat$f,na.rm=TRUE); rng_f = range(dfrDat$f,na.rm=TRUE); grd_f = seq(from=rng_f[1],rng_f[2],length.out=50);
med_s = median(dfrDat$s,na.rm=TRUE); rng_s = range(dfrDat$s,na.rm=TRUE); grd_s = seq(from=rng_s[1],rng_s[2],length.out=50);
grds = list(z=grd_z,d=grd_d,t=grd_t,f=grd_f,s=grd_s);
newDFR<-function(vars,grds){
#str = paste0(vars,"=grds[['",vars,"']]",collapse=",")
gnms = names(grds);
for (i in 1:length(gnms)){
var = gnms[i];
if (i==1){
if (var %in% vars)
{str = paste0(var,"=grds[['",var,"']]");}
else
{str = paste0(var,"=NA");}
} else {
if (var %in% vars)
{str = paste0(str,",",var,"=grds[['",var,"']]");}
else
{str = paste0(str,",",var,"=NA");}
}
}
eval(parse(text=paste0("dfrPrd1 = tidyr::expand_grid(",str,")")));
return(dfrPrd1);
}
#--get model intercept
int = mdl$coefficients[1];
#--get model smooths
smths = mdl$smooth;
ns    = length(smths);
#--plot smooths again
os1 = list();
os2 = list();
for (s in 1:ns){
smth = smths[[s]];
if (!inherits(smth,"random.effect")){
if (length(smth$term)==1){
#--plot ith term, if a 1-variable smooth and not a random effect
o = plot( sm(viz, s) ) +
l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
l_ciLine(mul = 5, colour = "blue", linetype = 2) +
l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic();
print(o);
# ggsave(plotFN(pltctr),width=8,height=5); pltctr %<>% +1;
os1[[smth$label]] = o;
} else {
o = plot( sm(viz, s) ) +
l_fitRaster() +
l_fitContour() +
l_points(shape=19,size=1,alpha=0.1) +
l_rug(alpha=0.8)
print(o);
os2[[smth$label]] = o;
# plotRGL(sm(viz, s),residuals=TRUE);
# aspect3d(1,1,0.1)
}
}
}
ncol = 1*(length(os1)<4)+2*(4<=length(os1));
pg = gridPrint(grobs=os1,ncol=ncol);
ggsave(paste0("smooths_males_1d.",device),pg,units="in",width=6.5,height=5);
ncol = 1*(length(os2)<4)+2*(4<=length(os2));
pg = gridPrint(grobs=os2,ncol=ncol);
ggsave(paste0("smooths_males_2d.",device),pg,units="in",width=6.5,height=5);
#--plot model results
#--load required packages
require(dplyr);
require(ggplot2);
require(magrittr);
require(mgcv);
require(mgcViz);
#--other required packages
#----ggdist
#----wtsUtilities
#--get model results
x = "MALE"; maxZ = 180;
mdl = wtsUtilities::getObj(paste0("./results_RData/selModels.BinomRE.Best.",tolower(x),"s.RData"));
#--get original data used in model fit
dfrDat = wtsUtilities::getObj("./results_RData/dfrDatRE.RData");
#--set up plotting output
device = "png";
pltctr = 1;
plotFN<-function(n,dev=device){paste0("plots3c_females_",wtsUtilities::formatZeros(n),".",dev)}
#--set up covariates for predictions
grd_z = seq(5,maxZ,5)+2.5; med_z = 77.5;
med_d = median(dfrDat$d,na.rm=TRUE); rng_d = range(dfrDat$d,na.rm=TRUE); grd_d = seq(from=rng_d[1],rng_d[2],length.out=50);
med_t = median(dfrDat$t,na.rm=TRUE); rng_t = range(dfrDat$t,na.rm=TRUE); grd_t = seq(from=rng_t[1],rng_t[2],length.out=50);
med_f = median(dfrDat$f,na.rm=TRUE); rng_f = range(dfrDat$f,na.rm=TRUE); grd_f = seq(from=rng_f[1],rng_f[2],length.out=50);
med_s = median(dfrDat$s,na.rm=TRUE); rng_s = range(dfrDat$s,na.rm=TRUE); grd_s = seq(from=rng_s[1],rng_s[2],length.out=50);
grds = list(z=grd_z,d=grd_d,t=grd_t,f=grd_f,s=grd_s);
newDFR<-function(vars,grds){
#str = paste0(vars,"=grds[['",vars,"']]",collapse=",")
gnms = names(grds);
for (i in 1:length(gnms)){
var = gnms[i];
if (i==1){
if (var %in% vars)
{str = paste0(var,"=grds[['",var,"']]");}
else
{str = paste0(var,"=NA");}
} else {
if (var %in% vars)
{str = paste0(str,",",var,"=grds[['",var,"']]");}
else
{str = paste0(str,",",var,"=NA");}
}
}
eval(parse(text=paste0("dfrPrd1 = tidyr::expand_grid(",str,")")));
return(dfrPrd1);
}
#--get model intercept
int = mdl$coefficients[1];
#--get model smooths
smths = mdl$smooth;
ns    = length(smths);
# smth = smths[[1]];
# cs = mdl$coefficients[smth$first.para:smth$last.para];
# dfrPrd1 = newDFR("z",grds);
# pm = mgcv::PredictMat(smth,dfrPrd1);#--prediction matrix (values of basis functions for each row of data)
# prd = int + pm %*% cs;
# dfrPrd2 = tibble::tibble(z=grd_z,`ln(R)`=prd,R=exp(prd));
# ggplot(data=dfrPrd2,mapping=aes(x=z,y=R)) +
#   geom_line();
#
# smth = smths[[4]];
# trms = smth$term;
# cs = mdl$coefficients[smth$first.para:smth$last.para];
# dfrPrd1 = newDFR(trms,grds);
# pm = mgcv::PredictMat(smth,dfrPrd1);#--prediction matrix (values of basis functions for each row of data)
# prd = pm %*% cs;
# dfrPrd2 = cbind(dfrPrd1,tibble::tibble(R=prd));
# p = ggplot(dfrPrd2,mapping=aes(x=z,y=d,z=R,fill=R)) + geom_raster() + scale_fill_viridis_c(option="plasma");
# print(p)
# require(rayshader)
# plot_gg(p, width=4,height=4)
# render_camera(12,37,1,0);
# render_snapshot()
#
# ns = length(smths);
# ps = list();   #--plot list
# dfrPrds = NULL;#--dataframe with predicted values
# for (s in 1:ns){
#   smth = smths[[s]];
#   if (!inherits(smth,"random.effect")){
#     trms = smth$term;
#     lbl  = smth$label;
#     cs   = mdl$coefficients[smth$first.para:smth$last.para];
#     dfrPrd1 = newDFR(trms,grds);
#     pm = mgcv::PredictMat(smth,dfrPrd1);#--prediction matrix (values of basis functions for each row of data)
#     prd = pm %*% cs;                    #--predicted logit-scale value for each row of data
#     dfrPrd2 = cbind(dfrPrd1,tibble::tibble(lgt_val=prd,label=lbl,terms=paste0(terms,collapse=",")));
#     dfrPrds = rbind(dfrPrds,dfrPrd2);
#     if (length(trms)==1){
#       p = ggplot(data=dfrPrd2,mapping=aes_string(x=trms[1],y="lgt_val")) +
#             geom_line() +
#             labs(y="ln-scale additive effect",subtitle=lbl);
#     } else {
#       p = ggplot(data=dfrPrd2,mapping=aes_string(x=trms[1],y=trms[2],fill="lgt_val")) +
#             geom_raster() + scale_fill_viridis_c(option="plasma") +
#             labs(fill="ln-scale\nadditive effect",subtitle=lbl);
#     }
#     print(p);
#     ps[[lbl]] = p;
#   }
# }
#--use mgcVis to plot iterms
viz = mgcViz::getViz(mdl);#get mgcViz object based on the model
# #----plot terms
# ps = plot(viz,allTerms = TRUE);
# for (p in ps$plots){
#   print(p);
#   ggsave(plotFN(pltctr),width=8,height=5); pltctr %<>% +1;
# }
os1 = list();
os2 = list();
for (s in 1:ns){
smth = smths[[s]];
if (!inherits(smth,"random.effect")){
if (length(smth$term)==1){
#--plot ith term, if a 1-variable smooth and not a random effect
o = plot( sm(viz, s) ) +
l_fitLine(colour = "red") + l_rug(mapping = aes(x=x, y=y), alpha = 0.8) +
l_ciLine(mul = 5, colour = "blue", linetype = 2) +
l_points(shape = 19, size = 1, alpha = 0.1) + theme_classic();
print(o);
# ggsave(plotFN(pltctr),width=8,height=5); pltctr %<>% +1;
os1[[smth$label]] = o;
} else {
o = plot( sm(viz, s) ) +
l_fitRaster() +
l_fitContour() +
l_points(shape=19,size=1,alpha=0.1) +
l_rug(alpha=0.8)
print(o);
os2[[smth$label]] = o;
# plotRGL(sm(viz, s),residuals=TRUE);
# aspect3d(1,1,0.1)
}
}
}
ncol = 1*(length(os1)<4)+2*(4<=length(os1));
pg = gridPrint(grobs=os1,ncol=ncol);
ggsave(paste0("smooths_males_1d.",device),pg,units="in",width=6.5,height=5);
ncol = 1*(length(os2)<4)+2*(4<=length(os2));
pg = gridPrint(grobs=os2,ncol=ncol);
ggsave(paste0("smooths_males_2d.",device),pg,units="in",width=6.5,height=5);
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/BinomialRE_Males_CensoredData1/step4b.PlotSurveySpecificSelectivities.R')
