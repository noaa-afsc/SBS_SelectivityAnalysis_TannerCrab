upper=quantile(prdR,probs=0.95,na.rm=TRUE))
dfrRbyH %>% dplyr::left_join(dfrCPUE,by=c("y","h","z")) %>%
subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = wgt(numCPUE)) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(wtsUtilities::Sum(w*(prdR-mnR)^2)),
lower=quantile(prdR,probs=0.05,na.rm=TRUE),
upper=quantile(prdR,probs=0.95,na.rm=TRUE))
dfrRbyY = dfrRbyH %>% dplyr::left_join(dfrCPUE,by=c("y","h","z")) %>%
subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = wgt(numCPUE)) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(wtsUtilities::Sum(w*(prdR-mnR)^2)),
lower=quantile(prdR,probs=0.05,na.rm=TRUE),
upper=quantile(prdR,probs=0.95,na.rm=TRUE)) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
intv = 10;#--number of intervals per plot
tmp = dfrRbyY %>% dplyr::mutate(group=floor((y-min(y))/intv+1),lbl=paste0((group-1)*intv+min(y)," : ",group*intv+min(y)-1));
p = ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,colour=y)) +
ggplot2::geom_ribbon(alpha=0.3) +
ggplot2::geom_line() +
ggplot2::facet_grid(lbl~.);
print(p);
wgt<-function(x){
if (wtsUtilities::Sum(x)>0) {
wgt=x/wtsUtilities::Sum(x);
} else {
wgt = 1.0/length(x);
}
return(wgt)
}
dfrRbyY = dfrRbyH %>% dplyr::left_join(dfrCPUE,by=c("y","h","z")) %>%
subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = wgt(numCPUE)) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(wtsUtilities::Sum(w*(prdR-mnR)^2)),
lower=quantile(prdR,probs=0.05,na.rm=TRUE),
upper=quantile(prdR,probs=0.95,na.rm=TRUE)) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
View(dfrRbyY)
library(tidyr)
tmp = dfrRbyH %>% subset(between,y,1975,1980);
p = ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=prdR,colour=y)) +
ggplot2::point(alpha=0.3)
#--look at results by haul
tmp = dfrRbyH %>% subset(dplyr::between(y,1975,1980));
ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=prdR,colour=y)) +
ggplot2::point(alpha=0.3)
ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=prdR,colour=y)) +
ggplot2::geom_point(alpha=0.3)
ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=prdR,colour=as.factor(y)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::lims(y=c(0,2))
)
ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=prdR,colour=as.factor(y))) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::lims(y=c(0,2))
ggplot2::ggplot(data=tmp,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::geom_line(alpha=0.3) +
ggplot2::lims(y=c(0,2)) +
ggplot2::facet_grid(y~.);
View(dfrRbyH)
prd = predict(mdl,newdata=dfrHDwSCs,se.fit=TRUE,type="link");#--return predictions on logit-scale w/ no offset
seR = sqrt(exp(prd$se.fit^2)-1)*exp(prd$fit+(prd$se.fit^2)/2);
seFactor = 2;
dfrRbyH = dfrHDwSCs %>%
dplyr::mutate(prdLnR=prd$fit,  #--offset lnq is 0, identically
seLnR=prd$se.fit,#--standard error
prdR=exp(prdLnR),#--arithmetic-scale predicted selectivity ratio
seR=seR,         #--arithmetic-scale standard error
lower=exp(prdLnR-seFactor*seLnR),
upper=exp(prdLnR+seFactor*seLnR));
#--look at results by haul
tmp1 = dfrRbyH %>% subset(dplyr::between(y,2015,2019));
p = ggplot2::ggplot(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::geom_line(alpha=0.3) +
ggplot2::lims(y=c(0,2)) +
ggplot2::facet_grid(y~.);
print(p);
tmp2 = tmp1 %>% subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = sqrt(1/(seR^2)/wtsUtilities::Sum(1/(seR^2)))) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(1/wtsUtilities::Sum(1/seR^2)),
lower=mnR-seFactor*seR,
upper=mnR+seFactor*seR) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
p = ggplot2::ggplot(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::geom_line(alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper)) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR,colour=as.factor(y))) +
ggplot2::lims(y=c(0,2)) + labs(y="predicted selectivity (ratio)",colour="year")
ggplot2::facet_grid(y~.);
print(p);
names(dfrRbyH)
names(tmp1)
p = ggplot2::ggplot(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::geom_line(alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper)) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR,colour=as.factor(y))) +
ggplot2::lims(y=c(0,2)) + labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
print(p);
ggplot2::ggplot(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::geom_line(alpha=0.3)
ggplot2::ggplot(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h)) +
ggplot2::geom_point(alpha=0.3) +
ggplot2::geom_line(alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper,group=NULL)) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR,colour=as.factor(y),group=NULL)) +
ggplot2::lims(y=c(0,2)) + labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
ggplot2::ggplot() +
ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper,group=NULL)) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR,colour=as.factor(y),group=NULL)) +
ggplot2::lims(y=c(0,2)) + labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
ggplot2::ggplot() +
ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper),colour="grey",alpha=0.3) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR),colour="black",size=2) +
ggplot2::lims(y=c(0,2)) + labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
ggplot2::ggplot() +
ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper),colour="grey",alpha=0.3) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR),colour="black",size=2) +
#ggplot2::lims(y=c(0,2)) +
labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
tmp1 = dfrRbyH %>% subset(dplyr::between(y,2015,2019)&(prdR<10));
tmp2 = tmp1 %>% subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = sqrt(1/(seR^2)/wtsUtilities::Sum(1/(seR^2)))) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(1/wtsUtilities::Sum(1/seR^2)),
lower=mnR-seFactor*seR,
upper=mnR+seFactor*seR) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
p = ggplot2::ggplot() +
ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper),colour="grey",alpha=0.3) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR),colour="black",size=2) +
#ggplot2::lims(y=c(0,2)) +
labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
print(p);
p = ggplot2::ggplot() +
# ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
# ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper),colour="grey",alpha=0.3) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR),colour="black",size=2) +
#ggplot2::lims(y=c(0,2)) +
labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
print(p);
View(tmp2)
View(dfrRbyH)
tmp2 = tmp1 %>% subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h)
tmp2 = tmp1 %>% subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
subset((y==2019)&(z==102.5))
tmp2
seR = tmp2$seR
sqrt(1.0/wtsUtilities::Sum(1.0/(seR^2)))
seR
sqrt(1.0/wtsUtilities::Sum(1.0/(seR^2)))
min(seR,na.rm=TRUE)
tmp2 = tmp1 %>% subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
subset((y==2019)&(z==102.5))
dplyr::group_by(y,z) %>%
dplyr::summarize(mnR=mean(prdR,na.rm=TRUE),
seR=sd(prdR,na.rm=TRUE),
lower=mnR-seFactor*seR,
upper=mnR+seFactor*seR) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
tmp2 = tmp1 %>% subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::summarize(mnR=mean(prdR,na.rm=TRUE),
seR=sd(prdR,na.rm=TRUE),
lower=mnR-seFactor*seR,
upper=mnR+seFactor*seR) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
p = ggplot2::ggplot() +
# ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
# ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper),colour="grey",alpha=0.3) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR),colour="black",size=2) +
#ggplot2::lims(y=c(0,2)) +
labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
print(p);
p = ggplot2::ggplot() +
# ggplot2::geom_point(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
# ggplot2::geom_line(data=tmp1,mapping=aes(x=z,y=prdR,colour=as.factor(y),group=h),alpha=0.3) +
#ggplot2::geom_ribbon(data=tmp2,mapping=aes(x=z,ymin=lower,ymax=upper),colour="grey",alpha=0.3) +
ggplot2::geom_line(data=tmp2,mapping=aes(x=z,y=mnR),colour="black",size=1) +
#ggplot2::lims(y=c(0,2)) +
labs(y="predicted selectivity (ratio)",colour="year") +
ggplot2::facet_grid(y~.);
print(p);
dfrRbyY = dfrRbyH %>%
subset(dplyr::between(y,2015,2019)&(prdR<10)) %>%
dplyr::left_join(dfrCPUE,by=c("y","h","z")) %>%
subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = wgt(numCPUE)) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(wtsUtilities::Sum(w*(prdR-mnR)^2)),
lower=quantile(prdR,probs=0.05,na.rm=TRUE),
upper=quantile(prdR,probs=0.95,na.rm=TRUE)) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,colour=y)) +
ggplot2::facet_grid(lbl~.);
print(p);
intv = 10;#--number of intervals per plot
tmp = dfrRbyY %>% dplyr::mutate(group=floor((y-min(y))/intv+1),lbl=paste0((group-1)*intv+min(y)," : ",group*intv+min(y)-1));
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,colour=y)) +
ggplot2::facet_grid(lbl~.);
print(p);
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,group=y),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,colour=y,group=y)) +
ggplot2::facet_grid(lbl~.);
print(p);
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,group=as.factor(y)),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,colour=y,group=as.factor(y))) +
ggplot2::facet_grid(lbl~.);
print(p);
intv = 10;#--number of intervals per plot
tmp = dfrRbyY %>% dplyr::mutate(group=floor((y-min(y))/intv+1),lbl=paste0((group-1)*intv+min(y)," : ",group*intv+min(y)-1));
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,group=as.factor(y)),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,colour=y,group=as.factor(y))) +
ggplot2::facet_grid(lbl~.) +
ggplot2::labs(x="size (mm CW)",y="survey-averaged selectivity (ratio)",colour="year");
print(p);
dfrRbyY = dfrRbyH %>%
subset((prdR<10)) %>%
dplyr::left_join(dfrCPUE,by=c("y","h","z")) %>%
subset(!(is.na(t)|is.na(f)|is.na(s))) %>%
dplyr::arrange(y,z,h) %>%
dplyr::group_by(y,z) %>%
dplyr::mutate(w = wgt(numCPUE)) %>%
dplyr::summarize(mnR=wtsUtilities::Sum(w*prdR),
seR=sqrt(wtsUtilities::Sum(w*(prdR-mnR)^2)),
lower=quantile(prdR,probs=0.05,na.rm=TRUE),
upper=quantile(prdR,probs=0.95,na.rm=TRUE)) %>%
dplyr::ungroup() %>%
dplyr::select(y,z,mnR,seR,lower,upper);
#--plot year-specific survey selectivity by multi-year intervals
intv = 10;#--number of intervals per plot
tmp = dfrRbyY %>% dplyr::mutate(group=floor((y-min(y))/intv+1),lbl=paste0((group-1)*intv+min(y)," : ",group*intv+min(y)-1));
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,group=as.factor(y)),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,colour=y,group=as.factor(y))) +
ggplot2::facet_grid(lbl~.) +
ggplot2::labs(x="size (mm CW)",y="survey-averaged selectivity (ratio)",colour="year");
print(p);
p = ggplot2::ggplot() +
ggplot2::geom_ribbon(data=tmp,mapping=aes(x=z,y=mnR,ymin=lower,ymax=upper,group=as.factor(y)),alpha=0.3) +
ggplot2::geom_line(data=tmp,mapping=aes(x=z,y=mnR,colour=as.factor(y),group=as.factor(y))) +
ggplot2::facet_grid(lbl~.) +
ggplot2::labs(x="size (mm CW)",y="survey-averaged selectivity (ratio)",colour="year");
print(p);
mdl_res$plotEsts
dfrDat = mdl_res$data
str(dfrDat)
dfrDat %<>% mutate(lgtp=log(p/(1-p)-lnq));
dfrDat %<>% mutate(lgtp=log(p/(1-p))-lnq));
dfrDat %<>% mutate(lgtp=log(p/(1-p))-lnq);
ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDat,mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDat %>% subset(n>=10),mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=z,y=lnq,colour=y)) +
labs(x="size (mm CW)",y="log(R) = ln(q)");
ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=lnq,fill=y)) +
labs(x="size (mm CW)",y="log(R) = ln(q)");
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count");
print(p);
dfrQs = tibble::tibble(q  =c(3,        6,     12),
lbl=c("min","nominal","max"));
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
ggplot2::geom_vline(data=dfrQs,mapping=ggplot2::aes(x=q,colour=lbl),linetype=2) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count",colour="year");
print(p);
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
ggplot2::geom_vline(data=dfrQs,mapping=ggplot2::aes(xintercept=q,colour=lbl),linetype=2) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count",colour="year");
print(p);
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
ggplot2::geom_vline(data=dfrQs,mapping=ggplot2::aes(xintercept=q),linetype=2) +
ggplot2::geom_text(data=dfrQs,mapping=ggplot2::aes(x=q,y=y,label=lbl)) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count",fill="year");
print(p);
dfrQs = tibble::tibble(q  =          c(  3,     6,      12),
y  =   1000 + c(  0,     0,       0),
lbl=as.factor(c("min","nominal","max")));
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
ggplot2::geom_vline(data=dfrQs,mapping=ggplot2::aes(xintercept=q),linetype=2) +
ggplot2::geom_text(data=dfrQs,mapping=ggplot2::aes(x=q,y=y,label=lbl)) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count",fill="year");
print(p);
p = ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDat,
mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
print(p);
p = ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDat %>% subset(dplyr::within(exp(lnq),dfrQs$q[1],dfrQs$q[3])),
mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
print(p);
nrw_orig = nrow(dfrDat);
nrw_edit = nrow(dfrDat %>% subset(dplyr::betewen(exp(lnq),dfrQs$q[1],dfrQs$q[3])));
nrw_edit = nrow(dfrDat %>% subset(dplyr::between(exp(lnq),dfrQs$q[1],dfrQs$q[3])));
#--edit data
dfrDatp  = dfrDat %>% subset(dplyr::between(exp(lnq),dfrQs$q[1],dfrQs$q[3]));
dfrDrop  = dfrDatp %>% anti_join(dfrDat,by=c("h","z")) %>% dplyr::select(h,z) %>% dplyr::distinct();
dfrDrop  = dfrDatp %>% anti_join(dfrDat,by=c("h","z"))
names(dfrDatp)
dfrDrop  = dfrDat %>% anti_join(dfrDatp,by=c("h","z")) %>% dplyr::select(h,z) %>% dplyr::distinct();
View(dfrDrop)
dfrDrop  = dfrDat %>% anti_join(dfrDatp,by=c("h","z"))
View(dfrDrop)
log(3)
log(12)
dfrDrop  = dfrDat %>% anti_join(dfrDatp,by=c("h","z")) %>% dplyr::select(h) %>% dplyr::distinct();
dfrDrop  = dfrDat %>% anti_join(dfrDatp,by=NULL) %>% dplyr::select(h) %>% dplyr::distinct();
p = ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDatp,mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
ggplot2::geom_point(data=dfrDat %>% anti_join(dfrDatp,by=NULL),mapping=ggplot2::aes(x=z,y=lgtp),colour="black") +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
print(p);
setwd("~/Work/StockAssessments-Crab/Assessments/TannerCrab/2021-05_TannerCrab/ModelRuns/21.02.ExpQsFixedLgtRets")
#convert TCSAM02 model output to RData files
require(rTCSAM02)
#--remove old results files
fns1<-list.files(pattern=glob2rx("OFCs*.csv"));
fns2<-list.files(pattern=glob2rx("Results*.RData"));
file.remove(fns1,fns2);
#--create new results files
best<-rTCSAM02::getResLst(file.path(".","run_best"),verbose=TRUE)
if (!is.null(best)) {
wtsUtilities::saveObj(best,fn=paste0("Results.RData"));
mdfr<-rTCSAM02::getMDFR.OFCs.DataComponents(best,verbose=FALSE);
write.csv(mdfr,file=paste0("OFCs.DataComponents.csv"),row.names=FALSE);
mdfrp<-rTCSAM02::getMDFR.OFCs.NonDataComponents(best,verbose=FALSE)
write.csv(mdfrp,file=paste0("OFCs.NonDataComponents.csv"),row.names=FALSE);
rm(best,mdfr,mdfrp)
}
case<-c("21.02");
models<-list();
models[[case]] = wtsUtilities::getObj(fn="Results.RData");
compare = names(models);
if (!dir.exists('results')) dir.create("results");
#--extract tables and create plots
dfr.PVs   <-rCompTCMs::extractMDFR.Results.ParameterValues(models[compare]);
write.csv(dfr.PVs,"./results/ParamValues.csv",row.names=FALSE)
dfr.PsAtBs<-rCompTCMs::extractMDFR.Results.ParametersAtBounds(models[compare]);
if (!is.null(dfr.PsAtBs)){
write.csv(dfr.PsAtBs,"./results/ParamsAtBounds.csv",row.names=FALSE);
cat(paste0(dfr.PsAtBs$name," ",dfr.PsAtBs$test," [",dfr.PsAtBs$label,"]\n"));
}
dfr.OFLs<-rTCSAM02::getMDFR.OFLResults(models[compare],verbose=TRUE);
if (!is.null(dfr.OFLs)){
dfr.OFLs$avgRec<-dfr.OFLs$avgRecM + dfr.OFLs$avgRecF;
dfr.OFLs<-wtsUtilities::deleteCols(dfr.OFLs,cols=c("avgRecM","avgRecF"),debug=FALSE);
dfr.OFLs<-dfr.OFLs[,c("case","objFun","maxGrad","avgRec","B100","Bmsy","curB","Fmsy","MSY","Fofl","OFL","prjB")];
write.csv(dfr.OFLs,"./results/oflResults.csv",row.names=FALSE)
}
View(dfr.PsAtBs)
setwd("~/Work/StockAssessments-Crab/Assessments/TannerCrab/2021-05_TannerCrab/ModelRuns/21.03.Lognormal/runJitterA")
setwd("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis")
pltctr = 1;
pltctr %<>% +1;
setwd("~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/Binomial_Males_CensoredData1")
#--fit various models for ln(r) using mgcv to fit GAMs for a specific sex
require(magrittr);
require(mgcv);
dfrProps_AYs =  wtsUtilities::getObj("../dfrPropsAllYears.RData");
#--the logit-scale observed proportions "o" are related to the
#--NMFS-to-BSFRF selectivity ratio "r" (S_nmfs/S_bsfrf) by
#     logit(o) = ln(r) + ln(q)
# where q = expF_b/expF_a is the ratio of expansion factors used to convert
# numbers sampled to CPUE: i.e., CPUE = N_s * expF, where expF = 1/(As * Sf),
# and As = area swept and Sf is the sampling fraction (note that
# the SAMPLING_FACTOR in the haul data tables is 1/(sampling fraction),
# so expF = SAMPLING_FACTOR/AREA_SWEPT).
pltctr = 1;
#--extract data for a specific sex
x = "MALE";
dfrDat = dfrProps_AYs %>%
subset(SEX==x) %>%
dplyr::transmute(y=YEAR,h=HAULJOIN,d=BOTTOM_DEPTH,t=GEAR_TEMPERATURE,f=phi,s=sorting,z=SIZE,
p=propNMFS,n=numTot,lnq=log(q),lgtp=log(p/(1-p))-lnq);
grd_z = seq(5,180,5)+2.5; med_z = 77.5;
med_d = median(dfrDat$d,na.rm=TRUE); rng_d = range(dfrDat$d,na.rm=TRUE); grd_d = seq(from=rng_d[1],rng_d[2],length.out=50);
med_t = median(dfrDat$t,na.rm=TRUE); rng_t = range(dfrDat$t,na.rm=TRUE); grd_t = seq(from=rng_t[1],rng_t[2],length.out=50);
med_f = median(dfrDat$f,na.rm=TRUE); rng_f = range(dfrDat$f,na.rm=TRUE); grd_f = seq(from=rng_f[1],rng_f[2],length.out=50);
med_s = median(dfrDat$s,na.rm=TRUE); rng_s = range(dfrDat$s,na.rm=TRUE); grd_s = seq(from=rng_s[1],rng_s[2],length.out=50);
#--check for outliers
dfrQs = tibble::tibble(q  =          c(  3,     6,      12),
y  =   1000 + c(  0,     0,       0),
lbl=as.factor(c("min","nominal","max")));
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
ggplot2::geom_vline(data=dfrQs,mapping=ggplot2::aes(xintercept=q),linetype=2) +
ggplot2::geom_text(data=dfrQs,mapping=ggplot2::aes(x=q,y=y,label=lbl)) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count",fill="year");
print(p);
plotFN<-function(n){paste0("plots3a_",wtsUtilities::formatZeros(n),".pdf")}
plotFN(3)
require(magrittr);
require(mgcv);
dfrProps_AYs =  wtsUtilities::getObj("../dfrPropsAllYears.RData");
#--the logit-scale observed proportions "o" are related to the
#--NMFS-to-BSFRF selectivity ratio "r" (S_nmfs/S_bsfrf) by
#     logit(o) = ln(r) + ln(q)
# where q = expF_b/expF_a is the ratio of expansion factors used to convert
# numbers sampled to CPUE: i.e., CPUE = N_s * expF, where expF = 1/(As * Sf),
# and As = area swept and Sf is the sampling fraction (note that
# the SAMPLING_FACTOR in the haul data tables is 1/(sampling fraction),
# so expF = SAMPLING_FACTOR/AREA_SWEPT).
pltctr = 1;
plotFN<-function(n){paste0("plots3a_",wtsUtilities::formatZeros(n),".pdf")}
#--extract data for a specific sex
x = "MALE";
dfrDat = dfrProps_AYs %>%
subset(SEX==x) %>%
dplyr::transmute(y=YEAR,h=HAULJOIN,d=BOTTOM_DEPTH,t=GEAR_TEMPERATURE,f=phi,s=sorting,z=SIZE,
p=propNMFS,n=numTot,lnq=log(q),lgtp=log(p/(1-p))-lnq);
grd_z = seq(5,180,5)+2.5; med_z = 77.5;
med_d = median(dfrDat$d,na.rm=TRUE); rng_d = range(dfrDat$d,na.rm=TRUE); grd_d = seq(from=rng_d[1],rng_d[2],length.out=50);
med_t = median(dfrDat$t,na.rm=TRUE); rng_t = range(dfrDat$t,na.rm=TRUE); grd_t = seq(from=rng_t[1],rng_t[2],length.out=50);
med_f = median(dfrDat$f,na.rm=TRUE); rng_f = range(dfrDat$f,na.rm=TRUE); grd_f = seq(from=rng_f[1],rng_f[2],length.out=50);
med_s = median(dfrDat$s,na.rm=TRUE); rng_s = range(dfrDat$s,na.rm=TRUE); grd_s = seq(from=rng_s[1],rng_s[2],length.out=50);
#--check for outliers
dfrQs = tibble::tibble(q  =          c(  3,     6,      12),
y  =   1000 + c(  0,     0,       0),
lbl=as.factor(c("min","nominal","max")));
p = ggplot2::ggplot()+
ggplot2::geom_histogram(data=dfrDat,mapping=ggplot2::aes(x=exp(lnq),fill=y)) +
ggplot2::geom_vline(data=dfrQs,mapping=ggplot2::aes(xintercept=q),linetype=2) +
ggplot2::geom_text(data=dfrQs,mapping=ggplot2::aes(x=q,y=y,label=lbl)) +
labs(x="q = (A_NMSF/A_BSFRF)*(S_NMFS/S_BSFRF)",y="count",fill="year");
print(p);
ggsave(plotFN(pltctr),p,"pdf",width=8,height=5); pltctr %<>% +1;
nrw_orig = nrow(dfrDat);
p = ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDat,
mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
print(p);
ggsave(plotFN(pltctr),p,"pdf",width=8,height=5); pltctr %<>% +1;
#--edit data
dfrDatp  = dfrDat %>% subset(dplyr::between(exp(lnq),dfrQs$q[1],dfrQs$q[3]));
dfrDrop  = dfrDat %>% anti_join(dfrDatp,by=NULL) %>% dplyr::select(h) %>% dplyr::distinct();
nrw_edit = nrow(dfrDatp);
p = ggplot2::ggplot()+
ggplot2::geom_point(data=dfrDatp,mapping=ggplot2::aes(x=z,y=lgtp,colour=y)) +
ggplot2::geom_point(data=dfrDat %>% anti_join(dfrDatp,by=NULL),mapping=ggplot2::aes(x=z,y=lgtp),colour="black") +
labs(x="size (mm CW)",y="log(R) = logit(phi)-ln(q)");
print(p);
ggsave(plotFN(pltctr),p,"pdf",width=8,height=5); pltctr %<>% +1;
wtsUtilities::saveObj(dfrDrop,"dfrDrop.RData");
source('~/Work/Projects/TannerCrab_SBS_SelectivityAnalysis/Analysis/03_MGCV_Analysis/Binomial_Males_CensoredData1/step3a.FitObservedProportions.R')
