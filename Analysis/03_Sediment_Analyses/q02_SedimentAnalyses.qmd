---
title: "SBS Studies: Sediment data"
author: "William T. Stockhausen"
institute: "AFSC/NMFS/NOAA"
date: '`r format(Sys.time(), "%b %e, %Y")`'
fontsize: 11pt 
number-sections: true
number-depth: 3
reference-location: document
reference-section-title: References
bibliography: '`r path.expand("~/Work/Projects/Bibliography/AllRefs.bib")`'
csl: '`r system.file("files/CJFAS.csl",package="wtsQMD")`'
link-citations: true
crossref:
  chapters: false      # prepend label reference numbers by chater number?
  fig-title: Figure    # for caption: default is "Figure")
  tbl-title: Table     # for caption: default is "Table")
  title-delim: "."     # for caption: default is ":")
  fig-prefix: Figure   # for in-text (use [-@fig-ref] to drop prefix in text)
  tbl-prefix: Table    # for in-text (use [-@tbl-ref] to drop prefix in text)
  fig-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  tbl-labels: arabic    # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  subref-labels: alpha a # options are arabic, roman, roman i, alpha x, alpha X; latter two starting from x/X
  ref-hyperlink: true    # references are hyperlinked if true
format: 
  html: 
    df-print: paged
    toc: true
    toc-location: right
    fig-width: 8
    fig-asp: 0.4
    fig-dpi: 100
    embed-resources: true
  pdf:
    documentclass: scrartcl
    toc: false
    fig_crop: false
    keep-tex: false
    fig-width: 6.5
    fig-asp: 0.4
    geometry:
      - left=1.0in
      - right=1.0in
      - top=1.0in
      - bottom=1.0in
      - textwidth=6.5in
      - showframe=false
    include-in-header: 
      - text: |
          \usepackage{placeins}
          \extrafloats{500}
          \maxdeadcycles=10000
      - file: "/Users/williamstockhausen/Work/Programming/R/Library/wtsQMD/files/ltx_ExtraLatexIncludes.tex"
echo: false
warning: false
results: 'hide'
keep-md: true
keep-yaml: false
editor: source
editor_options: 
  chunk_output_type: console
concordance: true
params:
  setup: !expr 'system.file("files/qmd_setup.R",package="wtsQMD")'
  doSedInterp: false     #--do interpoaltion of sediment data to NMFS haul locations (or read in)
  testing: false
  reorderTables: false   #--issue with finding "range" of table values  (don't use)
  reorderFigures: false  #--issue with finding "range" of figure values (don't use)
---
<!-- IMPORTANT: if used as a child doc, all chunk labels must be unique within the overall document -->

<!-- 
  NOTEs: 
     * child_path$peek() gives path to current script.
     * before starting a child document, do 
         "child_path$push(file.path(child_path$peek(),rel_path))" first, 
         where rel_path is the relative path to the child
     * after a child document has finished, do "child_path$pop()" to return to current path value
-->

<!-- if not child doc, set up required objects -->
```{r}
#| label: SedAnal2_setup
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: "asis"
  testing = params$testing;
  if (testing) cat(params$setup,"\n\n")
  source(params$setup);
  if (testing) cat("root = ",root,"\n\n")
  reorderTables  = params$reorderTables;
  reorderFigures = params$reorderFigures;
```

```{r}
#| label: setup_SedAnal2
#| results: 'asis'
  require(ggplot2);
  require(kableExtra);
  require(tables);
  require(tcsamSurveyData);
  #--also requires cowplot, dplyr, readr, rstudioapi, sf, stars, 
  #----wtsGIS, wtsPlots, wtsUtilities
  Sum = wtsUtilities::Sum;
  old_thm = ggplot2::theme_set(cowplot::theme_cowplot(font_size = 10) +
                               cowplot::background_grid() +
                               cowplot::panel_border());
  thm = wtsPlots::getStdTheme();
  options("readr.show_col_types"=FALSE);
  if (testing) cat("dirThs =",child_path$peek(),"\n\n")

  if (rstudioapi::isAvailable()){
    dirThs = file.path(rstudioapi::getActiveProject(),"Analysis/03_Sediment_Analyses");
  } else if (child_path$peek()!=""){
    dirThs = child_path$peek();
  } else {
    dirThs = ".";
  }
  ##--NOTE: take out or modify the following as necessary
  if (!exists("s",mode="list")){
    if (rstudioapi::isAvailable())
      fn = file.path(rstudioapi::getActiveProject(),"rda_ProjectSetup.RData");
    if (child_path$peek()!="")
      fn = file.path(child_path$peek(),"../../rda_ProjectSetup.RData");
    #--for debugging: ;
    if (file.exists(fn)) s = wtsUtilities::getObj(fn);
  }
  ##--
```

```{r SedAnal2_GetRasters}
  #--get interpolation rasters
  top<-file.path(dirThs,"02_SedimentAnalyses","Rasters");
  fns<-c("CoKr_EditedGrainSizeRaster.tif",
         "CoKr_EditedSortingRaster.tif");
  rasters<-list();
  for (fn in fns){
    fnp<-stringr::str_remove(fn,(".tif"))
    rasters[[fnp]]<-stars::read_stars(file.path(top,fn));
    if (params$testing) plot(rasters[[fnp]]);
  }
  crs = sf::st_crs(rasters[[1]]);
```

```{r SedAnal2_GetBMLS,cache=TRUE}
  bmls = wtsGIS::gg_CreateBasemapLayers();
```

```{r SedAnal2_DoInterpolation,cache=TRUE}
  if (params$doSedInterp){
    #--get **all NMFS haul** data
    minYr = 1975;
    maxYr = 2023;
    verbosity   = 0;
  
    #--NMFS data
    dirData_NMFS    = "~/Work/StockAssessments-Crab/Data/Survey.NMFS.EBS/Current";
    fnStrata        = file.path(dirData_NMFS,"TannerCrab_SurveyStrata.csv");
    fnHaulData_NMFS = file.path(dirData_NMFS,"TannerCrab_HaulData.csv");
  
    #--read NMFS strata definitions
    dfrStrata<-readr::read_csv(fnStrata) |>
                 dplyr::select(STATION_ID,DISTRICT,TOWS,SURVEY_YEAR,
                               LATITUDE,LONGITUDE,STRATUM,TOTAL_AREA_SQ_NM) |> 
                 dplyr::filter(dplyr::between(SURVEY_YEAR,minYr,maxYr));
    dfrSD<-selectStrata.TrawlSurvey(dfrStrata,
                                    species="BTC",
                                    strataType="2015",
                                    export=FALSE,
                                    verbosity=verbosity) |> 
             dplyr::filter(dplyr::between(YEAR,minYr,maxYr));
    rm(dfrStrata);
    
    #--read in NMFS haul data corresponding to stations at which BSFRF SBS hauls were conducted
    #----read in haul data file
    dfrHaulData_NMFS<-readr::read_csv(file=fnHaulData_NMFS,
                                      guess_max=Inf,
                                      skip=5) |> 
                        dplyr::filter(dplyr::between(AKFIN_SURVEY_YEAR,minYr,maxYr));
    #----Select NMFS haul data for SBS survey years
    dfrHD_NMFS<-selectHauls.TrawlSurvey(dfrSD,
                                        tbl=dfrHaulData_NMFS,
                                        YearRange=c(minYr,maxYr),
                                        export=FALSE,
                                        verbosity=verbosity);
  
    #--create sf dataset
    dfrHD_NMFS = wtsGIS::createSF_points(dfrHD_NMFS,xCol="MID_LONGITUDE",yCol="MID_LATITUDE");
    dfrHD_NMFS = sf::st_transform(dfrHD_NMFS,crs);#--transform to raster CRS (Alaska Albers)
    
    #--extract values from rasters
    dfrHD = dfrHD_NMFS;
    dfrHD = cbind(dfrHD,phi    =stars::st_extract(rasters[[1]],dfrHD)[[1]]);
    dfrHD = cbind(dfrHD,sorting=stars::st_extract(rasters[[2]],dfrHD)[[1]]);
    wtsUtilities::saveObj(dfrHD,
                          file.path(dirThs,"rda_dfrHD_All_NMFS_WithInterpolatedSedValues.RData"));
    rm(dfrHaulData_NMFS, dfrHD_NMFS, dfrStrata, dfrSD, dirData_NMFS, fnHaulData_NMFS, fnStrata);
  } else {
    dfrHD = wtsUtilities::getObj(file.path(dirThs,"rda_dfrHD_All_NMFS_WithInterpolatedSedValues.RData"));
  }
```

## Sediment characteristics {#sec-sed-results}

Mean grain size and sorting coefficient vary across the EBS (Figures [-@fig-SedAnal2-PhiMap] and [-@fig-SedAnal2-SortingMap]). At SBS haul locations, mean grain size and sorting coefficient were positively correlated with each other ($\rho=0.571$) and haul depth ($\rho=0.530$ and 0.433, respectively) but negatively correlated with bottom temperature ($\rho=0.-530$ and -0.482; [@fig-SedAnal2-PairsPlot]). 

```{r}
#| label: fig-SedAnal2-PhiMap
#| fig-cap: "Distribution of mean grain size (phi units), based on interpolation by kriging from the EBSSED2 database."
#| dependson: SedAnal2_GetBMLS
#| cache: true
  #--plot map of phi
  prj  = stars:::st_transform_proj.stars(rasters[[1]],crs=bmls$map_scale$crs);
  p = ggplot() + bmls$land + bmls$bathym + bmls$theme + 
        stars::geom_stars(data=prj) + 
        bmls$map_scale + 
        scale_fill_viridis_c(name="mean\ngrain\nsize\n(phi units)",option="magma")
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p));
  # if (!isPDF) print(p) else {
  #   lbl = getLabel();
  #   cap = wtsQMD::getFigCaption();
  #   pth = file.path(dirFigs,basename(xfun::with_ext(knitr::fig_path(),def_ext)));
  #   lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=def_wid,dpi=def_dpi);
  #   ggsave(pth,plot=p,width=def_wid,height=def_wid/def_asp,units="in",dpi=def_dpi);
  #   rm(lbl,cap,pth);
  # }
```

```{r}
#| label: fig-SedAnal2-SortingMap
#| fig-cap: "Distribution of grain size sorting coefficient (phi units), based on interpolation by kriging from the EBSSED2 database."
#| dependson: SedAnal2_GetBMLS
#| cache: true
  #--plot map of phi
  prj  = stars:::st_transform_proj.stars(rasters[[2]],crs=bmls$map_scale$crs);
  p = ggplot() + bmls$land + bmls$bathym + bmls$theme + 
        stars::geom_stars(data=prj) + 
        bmls$map_scale + 
        scale_fill_viridis_c(name="sorting\ncoefficient\n(phi units)",option="magma")
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p))
  # if (!isPDF) print(p) else {
  #   lbl = getLabel();
  #   cap = wtsQMD::getFigCaption();
  #   pth = file.path(dirFigs,basename(xfun::with_ext(knitr::fig_path(),def_ext)));
  #   lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=def_wid,dpi=def_dpi);
  #   ggsave(pth,plot=p,width=def_wid,height=def_wid/def_asp,units="in",dpi=def_dpi);
  #   rm(lbl,cap,pth);
  # }
  rm(prj);
```

```{r}
#| label: getSedDataForSBShauls
#| dependson: SedAnal2_DoInterpolation
  #--plot normalized temp, phi, and sorting as a function of depth
  dfrHDp = dfrHD |> sf::st_drop_geometry() |> 
                     dplyr::filter(dplyr::between(YEAR,2013,2018)) |> 
                     dplyr::select(BOTTOM_DEPTH,GEAR_TEMPERATURE,phi,sorting) |>
                     dplyr::rename(depth=BOTTOM_DEPTH,tmp=GEAR_TEMPERATURE,srt=sorting) |>
                     dplyr::mutate(dtmp=(tmp-min(tmp,na.rm=TRUE))/(max(tmp,na.rm=TRUE)-min(tmp,na.rm=TRUE)),
                                   dphi=(phi-min(phi,na.rm=TRUE))/(max(phi,na.rm=TRUE)-min(phi,na.rm=TRUE)),
                                   dsrt=(srt-min(srt,na.rm=TRUE))/(max(srt,na.rm=TRUE)-min(srt,na.rm=TRUE))) |>
                     dplyr::select(depth,tmp,phi,srt,dtmp,dphi,dsrt);
  dfrHDpp = dfrHDp |>
               dplyr::select(depth,dtmp,dphi,dsrt) |>
               dplyr::rename(`bottom temperature`=dtmp,phi=dphi,sorting=dsrt) |>
               tidyr::pivot_longer(c(`bottom temperature`,phi,sorting),
                                   names_to="variable",
                                   values_to="values");
  dfrHDp = dfrHDp |> dplyr::select(depth,tmp,phi,srt) |>
                     dplyr::rename(`bottom temperature`=tmp,phi=phi,sorting=srt);
```
```{r}
#| label: fig-SedAnal2-PairsPlot
#| fig-cap: "Pairs plot showing correlations among depth, bottom temperature, and interpolated mean grain size ('phi') and sorting coefficient sediment characteristics at NMFS SBS haul locations (2013-2018)."
#| dependson: SedAnal2_DoInterpolation
  #--make pairs plots 
  p_col = GGally::ggpairs(dfrHDp);
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p_col))
  # if (!isPDF) print(p_col) else {
  #   lbl = getLabel();
  #   cap = wtsQMD::getFigCaption();
  #   pth = file.path(dirFigs,basename(xfun::with_ext(knitr::fig_path(),def_ext)));
  #   lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=def_wid,dpi=def_dpi);
  #   ggsave(pth,plot=p_col,width=def_wid,height=def_wid/def_asp,units="in",dpi=def_dpi);
  #   rm(lbl,cap,pth);
  # }
  rm(dfrHDp,p_col);
```

```{r}
#| label: fig-SedAnal2-TPSvD
#| fig-cap: "Relative distributions of bottom temperature and interpolated mean grain size (phi units) and sorting coefficient with haul depth at NMFS SBS haul locations (2013-2018)."
#| dependson: SedAnal2_DoInterpolation
  p_vsd = ggplot2::ggplot(dfrHDpp,mapping=aes(x=depth,y=values,colour=variable,fill=variable)) +
            ggplot2::geom_point(alpha=0.2) +
            ggplot2::geom_smooth(alpha=0.4) + 
            ggplot2::labs(x="bottom depth (m)",y="normalized value",colour="quantity",fill="quantity") +
            ggplot2::theme(legend.position="bottom");
  lstFigs = c(lstFigs,wtsQMD::printGGplot(p_vsd));
  # if (!isPDF) print(p_vsd) else {
  #   lbl = wtsQMD::getLabel();
  #   cap = wtsQMD::getFigCaption();
  #   pth = file.path(dirFigs,basename(xfun::with_ext(knitr::fig_path(),def_ext)));
  #   lstFigs[[lbl]] = list(lbl=lbl,cap=cap,pth=pth,wid=def_wid,dpi=def_dpi);
  #   ggsave(pth,plot=p_vsd,width=def_wid,height=def_wid/def_asp,units="in",dpi=def_dpi);
  #   rm(lbl,cap,pth);
  # }
  rm(dfrHDpp,p_vsd);
```

<!-- references (don't show in PDF--no refs defined)-->
```{r refs_SedAnal2,eval=!knitr::opts_knit$get("child")&(!isPDF),results='asis'}
  cat("# References {-}\n");
  cat("::: {#refs}\n");
  cat(":::\n\n");
```

<!-- tables, if not child doc and lstTbls is not empty -->
```{r}
#| label: tables_SedAnal2
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printTablesSectionFromList.R",package="wtsQMD"));
```

<!-- figures, if not child doc and lstFigs is not empty -->
```{r}
#| label: figures_SedAnal2
#| eval: !expr '!knitr::opts_knit$get("child")'
#| results: asis
  source(system.file("files/printFiguresSectionFromList.R",package="wtsQMD"));
```
